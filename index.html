<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitQuest</title>
    <!-- Tailwind CSS CDN pour un style utilitaire et réactif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: VT323 pour un look rétro distinctif -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN pour des icônes légères et personnalisables -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tone.js CDN pour la gestion des sons et de l'audio dans l'application -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Chart.js CDN pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* Styles personnalisés inspirés de Tailwind et du rétro-gaming */
        body {
            font-family: 'VT323', monospace;
            background-color: #1a202c; /* Couleur de fond sombre (bg-gray-900) */
            color: #e2e8f0; /* Couleur de texte claire (text-white) */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* S'assure que le corps prend au moins toute la hauteur de la fenêtre */
            overflow-x: hidden; /* Empêche le défilement horizontal sur les petits écrans */
        }
        .font-vt323 {
            font-family: 'VT323', monospace;
        }

        /* Styles des boutons rétro pour une meilleure interaction visuelle */
        .btn-retro {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem; /* py-2 px-4 */
            border-radius: 0.375rem; /* rounded-md */
            border: 2px solid #1e40af; /* border-blue-800 */
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .btn-retro:active {
            box-shadow: none;
            transform: translateX(4px) translateY(4px);
        }
        .btn-retro-purple {
            background-color: #9333ea; /* bg-purple-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid #6b21a8; /* border-purple-800 */
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-purple:hover {
            background-color: #7e22ce; /* hover:bg-purple-700 */
        }
        .btn-retro-purple:active {
            box-shadow: none;
            transform: translateX(4px) translateY(4px);
        }
        .btn-retro-green {
            background-color: #16a34a; /* bg-green-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid #15803d; /* border-green-800 */
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-green:hover {
            background-color: #14713c; /* hover:bg-green-700 */
        }
        .btn-retro-green:active {
            box-shadow: none;
            transform: translateX(4px) translateY(4px);
        }
        .btn-retro-red {
            background-color: #dc2626; /* bg-red-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid #b91c1c; /* border-red-800 */
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-red:hover {
            background-color: #c01b1b; /* hover:bg-red-700 */
        }
        .btn-retro-red:active {
            box-shadow: none;
            transform: translateX(4px) translateY(4px);
        }
        .card-retro {
            background-color: #2d3748; /* bg-gray-800 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 4px solid #a78bfa; /* border-purple-500 */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-lg */
            color: white;
        }
        .input-retro, .select-retro {
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1); /* shadow */
            -webkit-appearance: none; /* appearance-none */
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #2563eb; /* border-blue-700 */
            border-radius: 0.25rem; /* rounded */
            width: 100%;
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            line-height: 1.25; /* leading-tight */
            outline: none; /* focus:outline-none */
            transition: all 0.1s ease-in-out;
            color: #dfdfdf; /* custom text color */
            background-color: #131313; /* custom background color */
        }
        .input-retro:focus, .select-retro:focus {
            ring: 2px; /* focus:ring-2 */
            ring-color: #a78bfa; /* focus:ring-purple-500 */
            border-color: #a78bfa; /* focus:border-purple-500 */
        }
        .select-retro option {
            color: #dfdfdf;
            background-color: #131313;
        }
        .table-retro {
            min-width: 100%;
            background-color: #4a5568; /* bg-gray-700 */
            border-radius: 0.5rem;
            border: 2px solid #2563eb;
        }
        .table-retro th {
            padding: 0.5rem 1rem; /* py-2 px-4 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            color: #fcd34d; /* text-yellow-300 */
            border-bottom: 2px solid #2563eb;
        }
        .table-retro td {
            padding: 0.75rem 1rem; /* py-3 px-4 */
            font-size: 0.875rem; /* text-sm */
            border-bottom: 1px solid #4a5568; /* border-gray-600 */
            color: #dfdfdf;
        }
        .table-retro tbody tr:last-child td {
            border-bottom: 0;
        }
        .btn-icon {
            font-size: 1.25rem; /* text-xl */
            padding: 0.25rem; /* p-1 */
            border-radius: 9999px; /* rounded-full */
            background-color: transparent;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-icon:hover {
            background-color: #4a5568; /* hover:bg-gray-700 */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .xp-bar-container {
            position: relative;
            width: 100%;
            height: 24px;
            background-color: #333;
            border: 2px solid #a0a0a0;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #fcd34d, #f97316); /* yellow-300 to orange-500 */
            transition: width 0.5s ease-in-out;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 2px;
            animation: xp-glow 1.5s infinite alternate;
        }
        @keyframes xp-glow {
            from { box-shadow: 0 0 5px #fcd34d; }
            to { box-shadow: 0 0 15px #f97316; }
        }
        .xp-bar-text {
            position: absolute;
            color: #1a202c; /* Dark text to contrast with yellow/orange */
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
            text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white;
        }

        /* Notifications CSS */
        .notification-container {
            position: fixed;
            z-index: 1000;
            pointer-events: none; /* Permet les clics à travers les notifications */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espacement entre les notifications */
        }
        .notification {
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            font-family: 'VT323', monospace;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 250px; /* Largeur minimale pour le contenu */
            max-width: 90%; /* Largeur max, responsive */
        }

        /* Trophées (haut gauche) */
        .notification-container-top-left {
            top: 20px; /* Position en haut */
            left: 20px; /* Position à gauche */
            align-items: flex-start; /* Aligner les éléments à gauche */
        }
        .notification.trophy {
            transform: translateX(-100%); /* Démarre hors écran à gauche */
            background-color: #9333ea; /* purple-600 */
            color: white;
            border: 2px solid #6b21a8; /* purple-800 */
            text-align: left; /* Alignement du texte à gauche */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .notification.trophy.show {
            transform: translateX(0); /* Glisse à l'intérieur */
            opacity: 1;
        }

        /* Messages généraux, conseils, chrono (bas droite) */
        .notification-container-bottom-right {
            bottom: 20px;
            right: 20px; /* Position à droite */
            align-items: flex-end; /* Aligner les éléments à droite */
        }

        .notification.general,
        .notification.tip {
            transform: translateX(100%); /* Démarre hors écran à droite */
            background-color: #2563eb; /* blue-600 par défaut */
            color: white;
            border: 2px solid #1e40af; /* blue-800 par défaut */
            text-align: right; /* Alignement du texte à droite */
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .notification.general.error {
            background-color: #dc2626; /* red-600 */
            border-color: #b91c1c; /* red-800 */
        }
        .notification.general.warning {
            background-color: #d97706; /* orange-600 */
            border-color: #9a3412; /* orange-800 */
        }
        .notification.general.success { /* Ajouté pour le type 'success' */
            background-color: #16a34a; /* green-600 */
            border-color: #15803d; /* green-800 */
        }
        .notification.general.chrono { /* Ajouté pour le type 'chrono' */
            background-color: #9333ea; /* purple-600 */
            border-color: #6b21a8; /* purple-800 */
        }
        .notification.tip { /* Specific style for tips */
            background-color: #059669; /* emerald-600 */
            border-color: #065F46; /* emerald-800 */
        }

        .notification.general.show,
        .notification.tip.show {
            transform: translateX(0); /* Glisse à l'intérieur */
            opacity: 1;
        }

        /* Adaptations pour écrans de petite taille (téléphones) */
        @media (max-width: 640px) {
            .notification-container-top-left,
            .notification-container-bottom-right {
                left: 50%;
                transform: translateX(-50%); /* Centre horizontalement le conteneur */
                right: auto; /* Annule le right: 20px; */
                width: 100%; /* Prend toute la largeur disponible */
                align-items: center; /* Centre les notifications à l'intérieur du conteneur */
            }

            .notification {
                width: 90%; /* Prend 90% de la largeur du conteneur */
                margin: 0 auto; /* Centre la notification elle-même */
                border-radius: 0.5rem; /* Coins arrondis complets */
                text-align: center; /* Centre le texte */
                flex-direction: column; /* Empile icône et texte verticalement */
                gap: 0.25rem; /* Réduit l'espacement */
            }

            .notification.trophy,
            .notification.general,
            .notification.tip {
                /* Réinitialise les transformations spécifiques pour les centrer */
                transform: translateX(-50%) !important;
                border-top-left-radius: 0.5rem;
                border-bottom-left-radius: 0.5rem;
                border-top-right-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
            }

            .notification-container-top-left {
                top: 10px; /* Moins d'espace en haut */
            }

            .notification-container-bottom-right {
                bottom: 10px; /* Moins d'espace en bas */
            }

            /* Navigation menu for small screens */
            .nav-scroll-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none;  /* IE and Edge */
            }
            .nav-scroll-container::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
            .nav-items-wrapper {
                display: flex;
                flex-wrap: nowrap; /* Prevent wrapping */
                padding-bottom: 5px; /* Add some space for potential scrollbar */
            }
            .nav-item {
                flex-shrink: 0; /* Prevent items from shrinking */
                min-width: 80px; /* Minimum width for each item */
                padding: 0.5rem 0.75rem; /* Adjust padding */
                margin: 0 0.25rem; /* Small margin between items */
            }
            .main-content-area {
                padding-bottom: 6rem; /* Adjust for footer on mobile */
            }
        </style>
</head>
<body class="font-vt323 text-white bg-gray-900 min-h-screen flex flex-col">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 font-vt323 text-white z-[999]">
        <div class="text-4xl sm:text-5xl text-yellow-300 mb-8 animate-bounce">FitQuest</div>
        <div class="w-64 sm:w-80 h-8 bg-gray-700 border-4 border-yellow-500 rounded-lg overflow-hidden relative">
            <div id="loading-progress-bar" class="h-full bg-green-500 transition-all duration-500 ease-linear" style="width: 0%;"></div>
            <div id="loading-progress-text" class="absolute inset-0 flex items-center justify-center text-lg font-bold text-gray-900">
                0% CHARGEMENT...
            </div>
        </div>
        <div id="loading-message" class="mt-8 p-3 rounded-md hidden"></div>
        <p id="audio-inactive-message" class="text-gray-400 text-sm sm:text-base mt-4 text-center hidden">
            AUDIO DÉSACTIVÉ. ACTIVEZ LE SON VIA LES OPTIONS POUR LES EFFETS AUDIO ET LA SYNTHÈSE VOCALE.
        </p>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen flex flex-col hidden">
        <header class="bg-gradient-to-r from-blue-700 to-indigo-800 text-yellow-300 p-5 shadow-md border-b-4 border-purple-500 rounded-b-lg">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-center tracking-widest leading-tight">FITQUEST</h1>
            <p class="text-center text-lg sm:text-xl mt-2 opacity-90">TON PROGRAMME PERSONNALISÉ</p>
            <p class="text-center text-sm sm:text-base mt-1 opacity-80 text-gray-300">GÉNÉRÉ PAR POXEL, TON IA PERSONNELLE</p>
            <p id="user-id-display" class="text-center text-xs sm:text-sm mt-2 opacity-80 text-gray-300 hidden">
                ID UTILISATEUR: <span id="user-id-value" class="font-mono break-all"></span>
            </p>

            <!-- XP Bar -->
            <div class="flex items-center justify-center my-4 px-4">
                <i data-lucide="zap" class="text-yellow-400 mr-2" style="width:32px; height:32px;"></i>
                <div class="flex-1 xp-bar-container">
                    <div id="xp-bar-fill" class="xp-bar-fill" style="width: 0%;"></div>
                    <span id="xp-bar-text" class="xp-bar-text">LVL 0 : 0/100 XP</span>
                </div>
            </div>

            <div class="mt-4 p-3 bg-gray-700 rounded-md border-2 border-blue-700">
                <h3 class="text-lg sm:text-xl font-bold text-yellow-300 mb-2">TON PROFIL ET STATS VITALES :</h3>
                <div class="flex flex-col sm:flex-row sm:items-end gap-3 justify-center">
                    <div class="flex-1 w-full sm:w-auto">
                        <label for="userHeight" class="block text-gray-200 text-sm font-bold mb-1">TAILLE (CM) :</label>
                        <input type="number" id="userHeight" class="input-retro" placeholder="EX: 175" />
                    </div>
                    <div class="flex-1 w-full sm:w-auto">
                        <label for="userWeight" class="block text-gray-200 text-sm font-bold mb-1">POIDS (KG) :</label>
                        <input type="number" id="userWeight" class="input-retro" placeholder="EX: 70" />
                    </div>
                    <button id="save-profile-btn" class="btn-retro-green sm:w-auto w-full px-5 py-2">
                        ENREGISTRER
                    </button>
                </div>
                <div id="imc-display" class="mt-3 text-center text-lg text-white hidden">
                    <p>TON IMC : <span id="imc-value" class="font-bold text-yellow-300"></span></p>
                    <p>CATÉGORIE : <span id="imc-category" class="font-bold text-blue-400"></span></p>
                    <p>PROTÉINES ESTIMÉES : <span id="protein-needs" class="font-bold text-yellow-300"></span></p>
                    <div class="text-xs text-gray-400 mt-2">
                        <p>**IMC INF. À 16.5 :** INSUFFISANCE PONDÉRALE (DÉNUTRITION SÉVÈRE)</p>
                        <p>**IMC 16.5 À 18.4 :** INSUFFISANCE PONDÉRALE</p>
                        <p>**IMC 18.5 À 24.9 :** POIDS NORMAL</p>
                        <p>**IMC 25 À 26.9 :** SURPOIDS (PRÉ-OBÉSITÉ)</p>
                        <p>**IMC 27 À 29.9 :** SURPOIDS (OBÉSITÉ MODÉRÉE)</p>
                        <p>**IMC 30 À 34.9 :** OBÉSITÉ CLASSE I</p>
                        <p>**IMC 35 À 39.9 :** OBÉSITÉ CLASSE II (SÉVÈRE)</p>
                        <p>**IMC SUP. OU ÉGAL À 40 :** OBÉSITÉ CLASSE III (MORBIDE OU MASSIVE)</p>
                        <p class="mt-2">**BESOINS EN PROTÉINES :** ESTIMATION POUR LA RÉCUPÉRATION MUSCULAIRE ET LE MAINTIEN DE LA MASSE CORPORELLE, CLÉ POUR TON ACTIVITÉ PHYSIQUE.</p>
                    </div>
                </div>
            </div>
        </header>

        <nav class="bg-gray-800 shadow-xl py-3 px-2 sm:px-4 border-y-4 border-blue-700 rounded-b-lg mb-4 mx-2">
            <div class="nav-scroll-container">
                <div class="nav-items-wrapper">
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="daily_plan">
                        <i data-lucide="calendar" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">PLANNING</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="workout">
                        <i data-lucide="dumbbell" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">SPORT</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="recipes">
                        <i data-lucide="utensils" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">RECETTES</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="chrono">
                        <i data-lucide="timer" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">CHRONO</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="progress">
                        <i data-lucide="line-chart" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">ÉVOLUTION</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="trophies">
                        <i data-lucide="trophy" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">TROPHÉES</span>
                    </button>
                    <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-gray-200 hover:bg-gray-700 hover:text-yellow-300 border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="options">
                        <i data-lucide="settings" class="text-xl" style="width:24px; height:24px;"></i>
                        <span class="text-sm mt-1">OPTIONS</span>
                    </button>
                </div>
            </div>
        </nav>

        <main id="main-content" class="flex-1 p-4 sm:p-6 main-content-area max-w-full mx-auto">
            <!-- Le contenu sera rendu ici par JavaScript -->
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 shadow-lg p-3 sm:hidden border-t-4 border-blue-700 text-center text-xs text-gray-400">
            FitQuest - 2023
        </footer>
    </div>

    <!-- Modals and Notifications -->
    <div id="global-modals-container"></div>
    <!-- Conteneur pour les notifications de trophées (haut-gauche) -->
    <div id="notification-container-trophy" class="notification-container notification-container-top-left"></div>
    <!-- Conteneur pour toutes les autres notifications (bas-droite, empilement vers le haut) -->
    <div id="notification-container-bottom-right" class="notification-container notification-container-bottom-right flex-col-reverse"></div>


    <script>
        // Initialisation de Lucide Icons
        function renderLucideIcons() {
            lucide.createIcons();
        }

        // =====================================================================
        // SECTION 1: VARIABLES GLOBALEs ET ÉTAT DE L'APPLICATION
        // =====================================================================
        let currentPage = 'daily_plan';
        let isLoadingApp = true;
        let loadingProgress = 0;
        let messageQueue = []; // File d'attente pour les messages généraux
        let currentDisplayedMessage = '';
        let currentDisplayedMessageType = '';
        let messageDisplayTimeoutRef = null;

        let weeklyMealPlan = null;
        let userProfile = {
            height: '',
            weight: '',
            imc: null,
            imcCategory: '',
            proteinNeeds: 'N/A',
            currentXP: 0,
            earnedTrophies: [],
            hideExerciseHistory: false, // Nouvel état pour cacher/afficher l'historique des exercices
            apiKey: '' // Nouvelle propriété pour la clé API
        };
        let workoutLogs = [];
        let weightHistory = [];
        let intervalSequences = []; // Pour les séquences de chrono sauvegardées
        let shifts = []; // Pour les postes du planning

        // Définition initiale du programme d'entraînement par défaut
        const defaultWorkoutProgramStructure = {
            phase1: {
                name: "PHASE 1 : PROGRAMME INITIAL (4 À 6 PREMIÈRES SEMAINES)",
                sessions: {
                    main: {
                        name: "SÉANCE RENFORCEMENT MUSCULAIRE - FULL BODY",
                        exercises: [
                            { name: "SQUAT (POIDS DU CORPS OU HALTÈRE GOBLET)", desc: "4 SÉRIES DE 10-15 RÉPÉTITIONS. COMMENCE AU POIDS DU CORPS. SI FACILE, UTILISE UN HALTÈRE DE 4-10 KG.", type: "legs" },
                            { name: "POMPES (PUSH-UPS)", desc: "3-4 SÉRIES DE MAX DE RÉPÉTITIONS. COMMENCE SUR LES GENOUX OU CONTRE UN MUR/BANC.", type: "chest" },
                            { name: "LAT PULLDOWN (POULIE HAUTE)", desc: "3-4 SÉRIES DE 10-15 RÉPÉTITIONS. COMMENCE AVEC 25-35 KG.", type: "back" },
                            { name: "DÉVELOPPÉ COUCHÉ HALTÈRES OU PEC DE DECK", desc: "3-4 SÉRIES DE 10-15 RÉPÉTITIONS. HALTÈRES: 6-10 KG PAR MAIN. PEC DECK: 15-25 KG.", type: "chest" },
                            { name: "FENTES (LUNGES)", desc: "3 SÉRIES DE 8-12 RÉPÉTITIONS PAR JAMBE. COMMENCE AU POIDS DU CORPS. SI FACILE, UTILISE UN HALTÈRE DE 4-6 KG DANS CHAQUE MAIN.", type: "legs" },
                            { name: "ÉLÉVATIONS LATÉRALES (HALTÈRES)", desc: "3 SÉRIES DE 12-15 RÉPÉTITIONS. COMMENCE AVEC 2-4 KG PAR MAIN.", type: "shoulders" },
                            { name: "PLANCHE (PLANK)", desc: "3 SÉRIES DE 30-60 SECONDES DE MAINTIEN.", type: "core" }
                        ]
                    },
                    cardio: {
                        name: "SÉANCE CARDIO (ENDURANCE, FRACTIONNÉ OU MIXTE)",
                        options: [
                            { name: "TAPIS DE COURSE (FRACTIONNÉ)", desc: "RÉPÈTE 5 FOIS: 2MIN MARCHE RAPIDE (6.0 KM/H, PENTE 2.0), 1MIN COURSE LÉGÈRE (8.0 KM/H, PENTE 1.0).", type: "cardio" },
                            { name: "VÉLO STATIONNAIRE OU VÉLO ELLIPTIQUE (SYNCHRO - FRACTIONNÉ)", desc: "RÉPÈTE 5 FOIS: 3MIN MODÉRÉ (NIV 5-7), 1MIN INTENSE (NIV 8-10).", type: "cardio" },
                            { name: "CARDIO & FONCTIONNEL MIXTE", desc: "10MIN TAPIS/VÉLO + 10MIN ALTERNER MOUNTAIN CLIMBERS/JUMPING JACKS.", type: "cardio" }
                        ]
                    },
                    hiit: {
                        name: "SÉANCE HIIT (HIGH-INTENSITY INTERVAL TRAINING)",
                        desc: "3 À 4 TOURS DE CIRCUIT: 40S EFFORT, 20S REPOS. EX: BURPEES MODIFIÉS, MOUNTAIN CLIMBERS, JUMPING JACKS, KETTLEBELL SWING, FENTES SAUTÉES, MONTÉES DE GENOUX RAPIDES.",
                        exercises: [
                            { name: "BURPEES MODIFIÉS", desc: "40S EFFORT, 20S REPOS", type: "hiit_bodyweight" },
                            { name: "MOUNTAIN CLIMBERS", desc: "40S EFFORT, 20S REPOS", type: "hiit_bodyweight" },
                            { name: "JUMPING JACKS", desc: "40S EFFORT, 20S REPOS", type: "hiit_cardio" },
                            { name: "KETTLEBELL SWING", desc: "40S EFFORT, 20S REPOS", type: "hiit_strength" },
                            { name: "FENTES SAUTÉES", desc: "40S EFFORT, 20S REPOS", type: "hiit_bodyweight" },
                            { name: "MONTÉES DE GENOUX RAPIDES", desc: "40S EFFORT, 20S REPOS", type: "hiit_cardio" }
                        ]
                    }
                }
            },
            phase2: {
                name: "PHASE 2 : PROGRAMME AVANCÉ (4 À 6 SEMAINES SUIVANTES)",
                sessions: {
                    main: {
                        name: "SÉANCE RENFORCEMENT MUSCULAIRE - FULL BODY (AVANCÉE PRINCIPALE)",
                        exercises: [
                            { name: "SOULEVÉ DE TERRE ROUMAIN (RDL HALTÈRES)", desc: "4 SÉRIES DE 10-15 RÉPÉTITIONS. COMMENCE AVEC 6-10 KG PAR MAIN.", type: "legs" },
                            { name: "TRACTIONS ASSISTÉES (MACHINE)", desc: "3-4 SÉRIES DE MAX DE RÉPÉTITIONS. UTILISE LA MACHINE AVEC UN POIDS D'ASSISTANCE ÉLEVÉ.", type: "back" },
                            { name: "PRESSE À CUISSES (LEG PRESS)", desc: "3-4 SÉRIES DE 10-15 RÉPÉTITIONS. COMMENCE AVEC 40-60 KG.", type: "legs" },
                            { name: "DÉVELOPPÉ ÉPAULES (SHOULDER PRESS HALTÈRES OU MACHINE)", desc: "3-4 SÉRIES DE 10-15 RÉPÉTITIONS. HALTÈRES: 4-8 KG PAR MAIN. MACHINE: 10-20 KG.", type: "shoulders" },
                            { name: "ROWING PENCHÉ (HALTÈRES)", desc: "3 SÉRIES DE 10-15 RÉPÉTITIONS. COMMENCE AVEC 6-10 KG PAR MAIN.", type: "back" },
                            { name: "EXTENSIONS TRICEPS (POULIE HAUTE OU HALTÈRE)", desc: "3 SÉRIES DE 12-15 RÉPÉTITIONS. POULIE: 10-15 KG. HALTÈRE: 4-8 KG.", type: "triceps" },
                            { name: "CRUNCHS (ABDOMINALS)", desc: "3 SÉRIES DE 15-20 RÉPÉTITIONS.", type: "core" }
                        ]
                    },
                    cardio: {
                        name: "SÉANCE CARDIO (ENDURANCE, FRACTIONNÉ OU MIXTE) - AVANCÉE",
                        options: [
                            { name: "TAPIS DE COURSE (ENDURANCE À PENTE VARIABLE)", desc: "CYCLE DE 10MIN (5MIN MARCHE 5.5KM/H P2.0, 3MIN MARCHE 6.0KM/H P3.0, 2MIN COURSE 7.5KM/H P1.0) RÉPÉTÉ 4-5 FOIS.", type: "cardio" },
                            { name: "RAMEUR (ROWING MACHINE) - INTERVAL TRAINING", desc: "RÉPÈTE 5 FOIS: 2MIN MODÉRÉ (R3-5), 1MIN INTENSE (R6-7).", type: "cardio" },
                            { name: "CARDIO & FONCTIONNEL MIXTE (AVANCÉ)", desc: "10MIN RAMEUR/ELLIPTIQUE + 10MIN ALTERNER SQUAT/FENTES ALTERNÉES.", type: "cardio" }
                        ]
                    },
                    hiit: {
                        name: "SÉANCE HIIT (HIGH-INTENSITY INTERVAL TRAINING) - AVANCÉE",
                        desc: "3 À 4 TOURS DE CIRCUIT: 45S EFFORT, 15S REPOS. EX: BURPEES AVEC POMPE, BOX JUMPS/STEP-UPS, CORDE À SAUTER, KETTLEBELL GOBLET SQUAT (EXPLOSIF), MOUNTAIN CLIMBERS CROISÉS, SAUTS LATÉRAUX.",
                        exercises: [
                            { name: "BURPEES AVEC POMPE", desc: "45S EFFORT, 15S REPOS", type: "hiit_bodyweight" },
                            { name: "BOX JUMPS / STEP-UPS", desc: "45S EFFORT, 15S REPOS", type: "hiit_bodyweight" },
                            { name: "CORDE À SAUTER", desc: "45S EFFORT, 15S REPOS", type: "hiit_cardio" },
                            { name: "KETTLEBELL GOBLET SQUAT (EXPLOSIF)", desc: "45S EFFORT, 15S REPOS", type: "hiit_strength" },
                            { name: "MOUNTAIN CLIMBERS CROISÉS", desc: "45S EFFORT, 15S REPOS", type: "hiit_bodyweight" },
                            { name: "SAUTS LATÉRAUX", desc: "45S EFFORT, 15S REPOS", type: "hiit_cardio" }
                        ]
                    }
                }
            },
        };

        let workoutProgram = {}; // Sera initialisé avec la valeur par défaut ou sauvegardée
        let previousLevel = 0; // Pour suivre le niveau et déclencher les sons de level-up

        let isAudioActive = true;
        let masterVolume = 0.5;

        // Lecteurs Tone.js et synthèse vocale (accès global)
        let trophySoundPlayer;
        let levelUpPlayer;
        let majorLevelUpPlayer;
        let beepPlayer;
        let startSoundPlayer;
        let loadingSoundLoop;
        let synth;

        // États du Chrono (accès global pour l'opération en arrière-plan)
        let chronoIntervals = [];
        let chronoCurrentTime = 0;
        let chronoCurrentIntervalIndex = -1;
        let isChronoRunning = false;
        let isChronoPaused = false;
        let enableChronoPreCountdown = true;
        let chronoPreCountdownDuration = 10;
        let chronoIntervalTimerRef = null;

        // Variables pour les instances de Chart.js
        let weightChartInstance = null;
        let exerciseChartInstance = null;

        let userId = 'local_user'; // ID utilisateur par défaut pour le stockage local

        // =====================================================================
        // SECTION 2: DONNÉES STATIQUES DE L'APPLICATION (RECETTES, TROPHÉES)
        // =====================================================================

        // --- Données des Trophées ---
        const allTrophies = [
            { id: 't001', name: 'PREMIER PAS', description: 'Atteindre le Niveau 1. Le voyage commence !', levelRequired: 1 },
            { id: 't002', name: 'NOVICE EN FORME', description: 'Atteindre le Niveau 2. Vous prenez le rythme.', levelRequired: 2 },
            { id: 't003', name: 'INITIÉ DU FIT', description: 'Atteindre le Niveau 3. Les efforts paient.', levelRequired: 3 },
            { id: 't004', name: 'FORME CROISSANTE', description: 'Atteindre le Niveau 4. De mieux en mieux !', levelRequired: 4 },
            { id: 't005', name: 'DÉBUTANT AVANCÉ', description: 'Atteindre le Niveau 5. Vous n\'êtes plus un débutant.', levelRequired: 5 },
            { id: 't006', name: 'CONSTANCE MÉRITÉE', description: 'Atteindre le Niveau 6. La régularité, c\'est la clé.', levelRequired: 6 },
            { id: 't007', name: 'ÉLAN DU PROGRÈS', description: 'Atteindre le Niveau 7. Vous sentez la progression.', levelRequired: 7 },
            { id: 't008', name: 'GAINS ASSURÉS', description: 'Atteindre le Niveau 8. Les muscles se dessinent.', levelRequired: 8 },
            { id: 't009', name: 'AVANCÉE RAPIDE', description: 'Atteindre le Niveau 9. Vous brûlez les étapes.', levelRequired: 9 },
            { id: 't010', name: 'DIXIÈME ÉTAPE', description: 'Atteindre le Niveau 10. Un jalon important !', levelRequired: 10 },
            { id: 't011', name: 'MAÎTRE INTERMÉDIAIRE', description: 'Atteindre le Niveau 11. Le fitness devient une habitude.', levelRequired: 11 },
            { id: 't012', name: 'FORCE ÉMERGENTE', description: 'Atteindre le Niveau 12. Vos limites sont repoussées.', levelRequired: 12 },
            { id: 't013', name: 'ENDURANCE ACCRUE', description: 'Atteindre le Niveau 13. Le cardio n\'a plus de secret.', levelRequired: 13 },
            { id: 't014', name: 'EXCELLENCE EN VUE', description: 'Atteindre le Niveau 14. La performance est à portée.', levelRequired: 14 },
            { id: 't015', name: 'DEMI-MAÎTRE', description: 'Atteindre le Niveau 15. Vous êtes sur la bonne voie.', levelRequired: 15 },
            { id: 't016', name: 'DISCIPLINE DE FER', description: 'Atteindre le Niveau 16. Votre engagement est fort.', levelRequired: 16 },
            { id: 't017', name: 'ÉNERGIE DÉCUPLÉE', description: 'Atteindre le Niveau 17. Sentez cette vitalité !', levelRequired: 17 },
            { id: 't018', name: 'HARMONIE CORPS/ESPRIT', description: 'Atteindre le Niveau 18. L\'équilibre est parfait.', levelRequired: 18 },
            { id: 't019', name: 'FORME OPTIMALE', description: 'Atteindre le Niveau 19. Vous rayonnez de santé.', levelRequired: 19 },
            { id: 't020', name: 'DEUXIÈME DIZAINE', description: 'Atteindre le Niveau 20. Double décennie de fitness !', levelRequired: 20 },
            { id: 't021', name: 'EXPERT EN DEVENIR', description: 'Atteindre le Niveau 21. La maîtrise approche.', levelRequired: 21 },
            { id: 't022', name: 'PUISSANCE RÉVÉLÉE', description: 'Atteindre le Niveau 22. Une force insoupçonnée.', levelRequired: 22 },
            { id: 't023', name: 'AGILITÉ MAXIMALE', description: 'Atteindre le Niveau 23. Votre corps est un temple agile.', levelRequired: 23 },
            { id: 't024', name: 'RÉSISTANCE INÉGALÉE', description: 'Atteindre le Niveau 24. Rien ne vous arrête.', levelRequired: 24 },
            { id: 't025', name: 'QUART DE SIÈCLE', description: 'Atteindre le Niveau 25. Vous êtes une machine !', levelRequired: 25 },
            { id: 't026', name: 'PERFECTION EN MARCHE', description: 'Atteindre le Niveau 26. Chaque pas est un succès.', levelRequired: 26 },
            { id: 't027', name: 'FORME INCROYABLE', description: 'Atteindre le Niveau 27. Admirez votre progression !', levelRequired: 27 },
            { id: 't028', name: 'DÉTERMINATION ACÉRÉE', description: 'Atteindre le Niveau 28. Votre volonté est sans faille.', levelRequired: 28 },
            { id: 't029', name: 'INÉPUISABLE', description: 'Atteindre le Niveau 29. L\'énergie vous habite.', levelRequired: 29 },
            { id: 't030', name: 'LE TREINTIÈME', description: 'Atteindre le Niveau 30. Un cap monumental !', levelRequired: 30 },
            { id: 't031', name: 'MAÎTRE ABSOLU', description: 'Atteindre le Niveau 31. Vous êtes une référence.', levelRequired: 31 },
            { id: 't032', name: 'EXPERT LÉGENDAIRE', description: 'Atteindre le Niveau 32. Votre réputation vous précède.', levelRequired: 32 },
            { id: 't033', name: 'OLYMPIEN EN HERBE', description: 'Atteindre le Niveau 33. Digne des plus grands athlètes.', levelRequired: 33 },
            { id: 't034', name: 'CHAMPION INCROYABLE', description: 'Atteindre le Niveau 34. Votre esprit est indomptable.', levelRequired: 34 },
            { id: 't035', name: 'LE PRODIGE', description: 'Atteindre le Niveau 35. Vos prouesses sont inégalées.', levelRequired: 35 },
            { id: 't036', name: 'FORCE DE LA NATURE', description: 'Atteindre le Niveau 36. Vous êtes imparable.', levelRequired: 36 },
            { id: 't037', name: 'FORME DIVINE', description: 'Atteindre le Niveau 37. Votre corps est une œuvre d\'art.', levelRequired: 37 },
            { id: 't038', name: 'CONNAISSANCE SUPRÊME', description: 'Atteindre le Niveau 38. Votre savoir est immense.', levelRequired: 38 },
            { id: 't039', name: 'RÉALISATION PARFAITE', description: 'Atteindre le Niveau 39. Tout est sous contrôle.', levelRequired: 39 },
            { id: 't040', name: 'QUARANTIÈME HORIZON', description: 'Atteindre le Niveau 40. Le ciel est votre limite !', levelRequired: 40 },
            { id: 't041', name: 'LÉGENDE VIVANTE', description: 'Atteindre le Niveau 41. On parlera de vous.', levelRequired: 41 },
            { id: 't042', name: 'INSPIRATION ULTIME', description: 'Atteindre le Niveau 42. Vous inspirez les foules.', levelRequired: 42 },
            { id: 't043', name: 'DÉFI RELEVÉ', description: 'Atteindre le Niveau 43. Chaque obstacle est un tremplin.', levelRequired: 43 },
            { id: 't044', name: 'SUMMUM DE LA FORME', description: 'Atteindre le Niveau 44. Vous êtes au sommet.', levelRequired: 44 },
            { id: 't045', name: 'LE MAÎTRE CULMINANT', description: 'Atteindre le Niveau 45. La perfection incarnée.', levelRequired: 45 },
            { id: 't046', name: 'IMPARABLE', description: 'Atteindre le Niveau 46. Vous êtes invincible !', levelRequired: 46 },
            { id: 't047', name: 'VOLONTÉ DE DIAMANT', description: 'Atteindre le Niveau 47. Votre détermination est inébranlable.', levelRequired: 47 },
            { id: 't048', name: 'ÉCLAT ÉTERNEL', description: 'Atteindre le Niveau 48. Votre aura brille.', levelRequired: 48 },
            { id: 't049', name: 'CONNAISSANCE ABSOLUE', description: 'Atteindre le Niveau 49. Le savoir vous guide.', levelRequired: 49 },
            { id: 't050', name: 'LE CINQUANTIÈME', description: 'Atteindre le Niveau 50. Une performance extraordinaire !', levelRequired: 50 },
            { id: 't051', name: 'GRAND MAÎTRE', description: 'Atteindre le Niveau 51. Vous êtes au-delà de l\'excellence.', levelRequired: 51 },
            { id: 't052', name: 'ARCHITECTE DU CORPS', description: 'Atteindre le Niveau 52. Vous sculptez votre destin.', levelRequired: 52 },
            { id: 't053', name: 'ARTISAN DE LA SANTÉ', description: 'Atteindre le Niveau 53. Votre bien-être est une œuvre.', levelRequired: 53 },
            { id: 't054', name: 'GUERRIER DE LA FORME', description: 'Atteindre le Niveau 54. Combattez pour votre meilleure version.', levelRequired: 54 },
            { id: 't055', name: 'CONQUÉRANT DU PHYSIQUE', description: 'Atteindre le Niveau 55. Chaque jour est une victoire.', levelRequired: 55 },
            { id: 't056', name: 'PIONNIER DU BIEN-ÊTRE', description: 'Atteindre le Niveau 56. Vous ouvrez la voie.', levelRequired: 56 },
            { id: 't057', name: 'PILIER DE LA VITALITÉ', description: 'Atteindre le Niveau 57. Votre énergie est inépuisable.', levelRequired: 57 },
            { id: 't058', name: 'SYNTHÈSE PARFAITE', description: 'Atteindre le Niveau 58. L\'harmonie est atteinte.', levelRequired: 58 },
            { id: 't059', name: 'PERFORMANCE ULTIME', description: 'Atteindre le Niveau 59. Vous défiez les limites.', levelRequired: 59 },
            { id: 't060', name: 'LE SOIXANTIÈME', description: 'Atteindre le Niveau 60. Incroyable persévérance !', levelRequired: 60 },
            { id: 't061', name: 'LÉGENDAIRE INDOMPTABLE', description: 'Atteindre le Niveau 61. Votre nom résonne.', levelRequired: 61 },
            { id: 't062', name: 'MYTHIQUE', description: 'Atteindre le Niveau 62. Votre parcours est une épopée.', levelRequired: 62 },
            { id: 't063', name: 'CHRONIQUE VIVANTE', description: 'Atteindre le Niveau 63. Chaque jour écrit l\'histoire.', levelRequired: 63 },
            { id: 't064', name: 'PATRON DES RECORDS', description: 'Atteindre le Niveau 64. Les records s\'inclinent.', levelRequired: 64 },
            { id: 't065', name: 'LE NÉMÉSIS DE LA FAIBLESSE', description: 'Atteindre le Niveau 65. Plus rien ne vous arrête.', levelRequired: 65 },
            { id: 't066', name: 'VOLONTÉ D\'ACIER', description: 'Atteindre le Niveau 66. Votre détermination est inébranlable.', levelRequired: 66 },
            { id: 't067', name: 'MÉTÉORE DE LA FORME', description: 'Atteindre le Niveau 67. Votre progression est fulgurante.', levelRequired: 67 },
            { id: 't068', name: 'AU-DELÀ DES LIMITES', description: 'Atteindre le Niveau 68. Vous transcendez tout.', levelRequired: 68 },
            { id: 't069', name: 'VISIONNAIRE DU FITNESS', description: 'Atteindre le Niveau 69. Votre vision est claire.', levelRequired: 69 },
            { id: 't070', name: 'LE SOIXANTE-DIXIÈME', description: 'Atteindre le Niveau 70. Une ascension sans fin !', levelRequired: 70 },
            { id: 't071', name: 'IMMORTEL DE LA FORME', description: 'Atteindre le Niveau 71. Votre dévouement est éternel.', levelRequired: 71 },
            { id: 't072', name: 'INVICTUS', description: 'Atteindre le Niveau 72. Vous êtes invaincu.', levelRequired: 72 },
            { id: 't073', name: 'MAJESTÉ DU PHYSIQUE', description: 'Atteindre le Niveau 73. Votre présence est imposante.', levelRequired: 73 },
            { id: 't074', name: 'SOUVERAIN DE LA SANTÉ', description: 'Atteindre le Niveau 74. Vous régnez sur votre bien-être.', levelRequired: 74 },
            { id: 't075', name: 'FORCE COLISEUM', description: 'Atteindre le Niveau 75. Digne d\'une arène antique.', levelRequired: 75 },
            { id: 't076', name: 'MYSTÈRE DE LA RÉUSSITE', description: 'Atteindre le Niveau 76. Votre succès est fascinant.', levelRequired: 76 },
            { id: 't077', name: 'PERFECTION DE L\'ÊTRE', description: 'Atteindre le Niveau 77. Corps et âme alignés.', levelRequired: 77 },
            { id: 't078', name: 'AURORE DE LA GRANDEUR', description: 'Atteindre le Niveau 78. Chaque jour est un nouveau chef-d\'œuvre.', levelRequired: 78 },
            { id: 't079', name: 'COURONNE ÉTERNELLE', description: 'Atteindre le Niveau 79. Votre legs perdurera.', levelRequired: 79 },
            { id: 't080', name: 'LE QUATRE-VINGTIÈME', description: 'Atteindre le Niveau 80. Une légende se construit !', levelRequired: 80 },
            { id: 't081', name: 'DIEU DU FITNESS', description: 'Atteindre le Niveau 81. Votre puissance est divine.', levelRequired: 81 },
            { id: 't082', name: 'TITAN DE LA FORME', description: 'Atteindre le Niveau 82. Une force colossale.', levelRequired: 82 },
            { id: 't083', name: 'HÉROS ABSOLU', description: 'Atteindre le Niveau 83. Vous êtes l\'incarnation du triomphe.', levelRequired: 83 },
            { id: 't084', name: 'DÉFIANT LES MORTELS', description: 'Atteindre le Niveau 84. Plus rien ne vous est impossible.', levelRequired: 84 },
            { id: 't085', name: 'LE PHÉNIX DE LA SANTÉ', description: 'Atteindre le Niveau 85. Vous renaissez de vos efforts.', levelRequired: 85 },
            { id: 't086', name: 'CONSTELLATION DE MUSCLES', description: 'Atteindre le Niveau 86. Chaque muscle brille.', levelRequired: 86 },
            { id: 't087', name: 'L\'AURORE BORÉALE', description: 'Atteindre le Niveau 87. Votre beauté est naturelle.', levelRequired: 87 },
            { id: 't088', name: 'LA FULGURANCE', description: 'Atteindre le Niveau 88. Votre vitesse est inégalée.', levelRequired: 88 },
            { id: 't089', name: 'L\'INCONNU', description: 'Atteindre le Niveau 89. Le monde vous attend.', levelRequired: 89 },
            { id: 't090', name: 'LE NONANTIÈME', description: 'Atteindre le Niveau 90. À l\'aube de l\'immortalité !', levelRequired: 90 },
            { id: 't091', name: 'L\'ASCENSION', description: 'Atteindre le Niveau 91. Vous touchez les étoiles.', levelRequired: 91 },
            { id: 't092', name: 'LA CONQUÊTE FINALE', description: 'Atteindre le Niveau 92. La victoire est proche.', levelRequired: 92 },
            { id: 't093', name: 'LA PERFECTION ATTEINTE', description: 'Atteindre le Niveau 93. Chaque aspect est maîtrisé.', levelRequired: 93 },
            { id: 't094', name: 'LE ZÉNITH', description: 'Atteindre le Niveau 94. Vous êtes au sommet du monde.', levelRequired: 94 },
            { id: 't095', name: 'LE MYSTÈRE ÉCLAIRCI', description: 'Atteindre le Niveau 95. Les secrets sont révélés.', levelRequired: 95 },
            { id: 't096', name: 'LE DESTIN ACCOMPLI', description: 'Atteindre le Niveau 96. Votre destinée est scellée.', levelRequired: 96 },
            { id: 't097', name: 'L\'APOTHÉOSE', description: 'Atteindre le Niveau 97. Vous êtes glorifié.', levelRequired: 97 },
            { id: 't098', name: 'L\'HÉRITAGE', description: 'Atteindre le Niveau 98. Votre histoire sera contée.', levelRequired: 98 },
            { id: 't099', name: 'L\'INFINI', description: 'Atteindre le Niveau 99. Les possibilités sont sans fin.', levelRequired: 99 },
            { id: 't100', name: 'MAÎTRE ULTIME DE POXEL', description: 'Atteindre le Niveau 100. Félicitations, Poxel vous couronne !', levelRequired: 100 },
            { id: 't101', name: 'AU-DELÀ DE LA CENTAINE I', description: 'Atteindre le Niveau 101. Une force continue.', levelRequired: 101 },
            { id: 't102', name: 'AU-DELÀ DE LA CENTAINE II', description: 'Atteindre le Niveau 102. La puissance croît.', levelRequired: 102 },
            { id: 't103', name: 'AU-DELÀ DE LA CENTAINE III', description: 'Atteindre le Niveau 103. L\'énergie pure.', levelRequired: 103 },
            { id: 't104', name: 'AU-DELÀ DE LA CENTAINE IV', description: 'Atteindre le Niveau 104. La maîtrise s\'étend.', levelRequired: 104 },
            { id: 't105', name: 'AU-DELÀ DE LA CENTAINE V', description: 'Atteindre le Niveau 105. Les profondeurs de la forme.', levelRequired: 105 },
            { id: 't106', name: 'AU-DELÀ DE LA CENTAINE VI', description: 'Atteindre le Niveau 106. La discipline absolue.', levelRequired: 106 },
            { id: 't107', name: 'AU-DELÀ DE LA CENTAINE VII', description: 'Atteindre le Niveau 107. Le corps résiste à tout.', levelRequired: 107 },
            { id: 't108', name: 'AU-DELÀ DE LA CENTAINE VIII', description: 'Atteindre le Niveau 108. L\'esprit ne faiblit pas.', levelRequired: 108 },
            { id: 't109', name: 'AU-DELÀ DE LA CENTAINE IX', description: 'Atteindre le Niveau 109. La sagesse du guerrier.', levelRequired: 109 },
            { id: 't110', name: 'AU-DELÀ DE LA CENTAINE X', description: 'Atteindre le Niveau 110. Une décennie de plus de puissance !', levelRequired: 110 },
        ];


        const recipeTemplates = { /* ... (identique au code React précédent) ... */
            proteins: [
                { name: "POULET", type: "lean_meat", base_portion_g: 150, allergens: ["NONE"] },
                { name: "SAUMON", type: "fatty_fish", base_portion_g: 120, allergens: ["FISH"] },
                { name: "LENTILLES", type: "legume", base_portion_g: 200, allergens: ["NONE"], cooked_form: "g cuites" },
                { name: "OEUFS", type: "egg", base_portion_qty: 3, base_portion_unit: "oeufs", allergens: ["EGG"] },
                { name: "TOFU", type: "plant_protein", base_portion_g: 180, allergens: ["SOY"] },
                { name: "VIANDE ROUGE MAIGRE", type: "red_meat", base_portion_g: 150, allergens: ["NONE"] },
                { name: "FROMAGE BLANC", type: "dairy_protein", base_portion_g: 200, allergens: ["MILK"] },
                { name: "WHEY PROTEIN", type: "supplement_protein", base_portion_g: 30, allergens: ["MILK"] }
            ],
            breakfastProteins: [
                { name: "OEUFS (EN PRÉPARATION SUCRÉE)", type: "egg", base_portion_unit: "oeufs", base_portion_qty: 2, allergens: ["EGG"] },
                { name: "YAOURT GREC", type: "dairy_protein", base_portion_g: 150, allergens: ["MILK"] },
                { name: "FROMAGE BLANC", type: "dairy_protein", base_portion_g: 150, allergens: ["MILK"] },
                { name: "WHEY PROTEIN", type: "supplement_protein", base_portion_g: 20, allergens: ["MILK"] }
            ],
            carbs: [
                { name: "RIZ BASMATI", type: "complex_carb", base_portion_g: 60, glycemic_index: "medium", cooked_form: "g secs" },
                { name: "QUINOA", type: "complex_carb", base_portion_g: 60, glycemic_index: "low", cooked_form: "g secs" },
                { name: "PATATE DOUCE", type: "complex_carb", base_portion_g: 200, glycemic_index: "low" },
                { name: "PÂTES COMPLÈTES", type: "complex_carb", base_portion_g: 70, glycemic_index: "medium", cooked_form: "g secs" },
                { name: "FLOCONS D'AVOINE", type: "complex_carb", base_portion_g: 50, glycemic_index: "low", cooked_form: "g secs" },
                { name: "PAIN COMPLÈTE", type: "complex_carb", base_portion_g: 80, glycemic_index: "medium" },
                { name: "SEMOULE COMPLÈTE", type: "complex_carb", base_portion_g: 60, glycemic_index: "medium", cooked_form: "g secs" },
            ],
            vegetables: [
                { name: "BROCOLI", type: "vegetable" }, { name: "ÉPINARDS", type: "vegetable" },
                { name: "HARICOTS VERTS", type: "vegetable" }, { name: "COURGETTES", type: "vegetable" },
                { name: "POIVRONS", type: "vegetable" }, { name: "CAROTTES", type: "vegetable" },
                { name: "CHOU-FLEUR", type: "vegetable" }, { name: "TOMATES CERISES", type: "vegetable" }
            ],
            breakfastSweetAdditions: [
                { name: "BANANE", type: "fruit" }, { name: "BAIES MÉLANGÉES", type: "fruit" },
                { name: "POMME", type: "fruit" }, { name: "DATTES", type: "fruit" }
            ],
            flavors: [
                "CLASSIQUE (SEL, POIVRE, HERBES)", "ASIATIQUE (SAUCE SOJA LÉGÈRE, GINGEMBRE)",
                "MÉDITERRANÉEN (HUILE D'OLIVE, CITRON, ORIGAN)", "MEXICAIN (ÉPICES FAJITAS, CORIANDRE)"
            ],
            supplements: [
                { name: "HUILE D'OLIVE EXTRA VIERGE", type: "fat" }, { name: "AVOCAT", type: "fat" },
                { name: "NOIX DE CAJOU", type: "fat" }, { name: "AMANDES", type: "fat" },
                { name: "HUILE DE COCO", type: "fat" }
            ],
            recipeTypes: {
                petit_dejeuner_sucre_oeufs: {
                    name: (protein, carb, veggie1) => `FLOCONS D'AVOINE PROTEINES AUX ${veggie1.name.toUpperCase()} & OEUFS`,
                    description: (mealType, poste, sport, userProfile) => `UN PETIT-DÉJEUNER ÉQUILIBRÉ ET RICHE POUR L'ÉNERGIE. IDÉAL POUR UN CONTEXTE DE ${poste.toUpperCase()} AVEC ${sport.toUpperCase()} APRÈS.`,
                    ingredients: (protein, carb, veggie1, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${cPortion} DE ${carb.name.toUpperCase()}`,
                        `${pPortion} DE ${protein.name.toUpperCase()}`,
                        `${veggie1.name.toUpperCase()} (EN TRANCHES)`,
                        `${Math.round(5 * numPeople)}g HUILE DE COCO`, // Scaled
                        `1 PINCÉE DE CANNELLE`
                    ],
                    preparation: [
                        "1. MÉLANGEZ LES FLOCONS D'AVOINE AVEC DE L'EAU OU DU LAIT VÉGÉTAL. CUIRE JUSQU'À CONSISTANCE DÉSIRÉE.",
                        "2. FAITES CUIRE LES OEUFS (BROUILLÉS OU MOLLETS).",
                        "3. AJOUTEZ LES TRANCHES DE FRUITS. SI BESOIN, INTÉGREZ L'HUILE DE COCO ET LA CANNELLE."
                    ]
                },
                petit_dejeuner_sucre_yaourt: {
                    name: (protein, carb, veggie1) => `${protein.name.toUpperCase()} BOWL AVEC ${carb.name.toUpperCase()} ET ${veggie1.name.toUpperCase()}`,
                    description: (mealType, poste, sport, userProfile) => `UN BOWL RAFRAÎCHISSANT ET NUTRITIF. PARFAIT POUR COMMENCER UNE JOURNÉE DE ${poste.toUpperCase()} AVEC OU SANS SPORT.`,
                    ingredients: (protein, carb, veggie1, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${pPortion} DE ${protein.name.toUpperCase()}`,
                        `${cPortion} DE ${carb.name.toUpperCase()}`,
                        `${Math.round(100 * numPeople)}g DE ${veggie1.name.toUpperCase()}`, // Scaled
                        `${Math.round(10 * numPeople)}g GRAINES DE CHIA`, // Scaled
                        `${Math.round(1 * numPeople)} CUIL. À CAFÉ DE MIEL (OPTIONNEL)` // Scaled
                    ],
                    preparation: [
                        "1. MÉLANGEZ LE ${protein.name.toUpperCase()} AVEC LES FLOCONS D'AVOINE/CÉRÉALES.",
                        "2. AJOUTEZ LES FRUITS FRAIS OU CONGELÉS ET LES GRAINES DE CHIA.",
                        "3. SI DÉSIRÉ, AJOUTEZ UNE CUIL. À CAFÉ DE MIEL."
                    ]
                },
                petit_dejeuner_sucre_porridge: {
                    name: (protein, carb, veggie1) => `PORRIDGE ÉNERGÉTIQUE AU ${veggie1.name.toUpperCase()} ET ${protein.name.toUpperCase()}`,
                    description: (mealType, poste, sport, userProfile) => `UN PORRIDGE RICHE EN ÉNERGIE POUR LES MATINS EXIGEANTS DE ${poste.toUpperCase()}.`,
                    ingredients: (protein, carb, veggie1, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${cPortion} DE ${carb.name.toUpperCase()} (CÉRÉALES/FLOCONS)`,
                        `${pPortion} DE ${protein.name.toUpperCase()} (WHEY OU FROMAGE BLANC)`,
                        `${Math.round(1 * numPeople)} ${veggie1.name.toUpperCase()}`, // Suppose 1 fruit par personne, adapté par le nombre de personnes
                        `${Math.round(10 * numPeople)}g GRAINES DE LIN`, // Scaled
                        `${Math.round(200 * numPeople)}ml LAIT VÉGÉTAL` // Scaled
                    ],
                    preparation: [
                        "1. FAIRE CUIRE LES FLOCONS D'AVOINE AVEC LE LAIT VÉGÉTAL JUSQU'À ÉPAISSISSEMENT.",
                        "2. INCORPORER LA PROTÉINE (SI WHEY) OU LE FROMAGE BLANC.",
                        "3. GARNIR AVEC LE FRUIT ET LES GRAINES DE LIN."
                    ]
                },
                repas_complet_viande_riz_legumes: {
                    name: (protein, carb, veggie1, veggie2, flavor) => `${protein.name.toUpperCase()} GRILLÉ, RIZ & LÉGUMES SAUTÉS (${flavor.toUpperCase()})`,
                    description: (mealType, poste, sport, userProfile) => `UN REPAS ÉQUILIBRÉ POUR SOUTENIR L'ÉNERGIE PENDANT OU APRÈS UN POSTE DE ${poste.toUpperCase()}.`,
                    ingredients: (protein, carb, veggie1, veggie2, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${pPortion} DE ${protein.name.toUpperCase()}`,
                        `${cPortion} DE ${carb.name.toUpperCase()}`,
                        `${Math.round(150 * numPeople)}g DE ${veggie1.name.toUpperCase()}`, // Scaled
                        `${Math.round(150 * numPeople)}g DE ${veggie2.name.toUpperCase()}`, // Scaled
                        `${Math.round(10 * numPeople)}ml ${supplement.name.toUpperCase()}` // Scaled
                    ],
                    preparation: [
                        "1. CUIRE LE RIZ SELON LES INSTRUCTIONS.",
                        "2. FAIRE GRILLER OU SAUTER LE ${protein.name.toUpperCase()}.",
                        "3. FAIRE SAUTER LES LÉGUMES AVEC L'HUILE OU LES CUIRE À LA VAPEUR. ASSAISONNER AVEC LE STYLE ${flavor.toUpperCase()}."
                    ]
                },
                repas_complet_poisson_patate_legumes: {
                    name: (protein, carb, veggie1, veggie2, flavor) => `${protein.name.toUpperCase()} AU FOUR, ${carb.name.toUpperCase()} & ${veggie1.name.toUpperCase()} (${flavor.toUpperCase()})`,
                    description: (mealType, poste, sport, userProfile) => `UN REPAS DIGESTE ET RICHE EN OMÉGA-3. EXCELLENT POUR LA RÉCUPÉRATION.`,
                    ingredients: (protein, carb, veggie1, veggie2, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${pPortion} DE ${protein.name.toUpperCase()}`,
                        `${cPortion} DE ${carb.name.toUpperCase()}`,
                        `${Math.round(200 * numPeople)}g DE ${veggie1.name.toUpperCase()}`, // Scaled
                        `${Math.round(5 * numPeople)}ml ${supplement.name.toUpperCase()}` // Scaled
                    ],
                    preparation: [
                        "1. PRÉCHAUDER LE FOUR. PLACER LE ${protein.name.toUpperCase()} SUR UNE PLAQUE DE CUISSON AVEC L'HUILE ET LES ASSAISONNEMENTS.",
                        "2. CUIRE LA ${carb.name.toUpperCase()} (VAPEUR OU FOUR).",
                        "3. VAPEUR OU FAIRE SAUTER LES ${veggie1.name.toUpperCase()}. SERVIR CHAUD."
                    ]
                },
                repas_vegetarien_legumineuses_quinoa_legumes: {
                    name: (protein, carb, veggie1, veggie2, flavor) => `CURRY DE ${protein.name.toUpperCase()} ET ${veggie1.name.toUpperCase()} AVEC ${carb.name.toUpperCase()}`,
                    description: (mealType, poste, sport, userProfile) => `UN PLAT VÉGÉTARIEN NUTRITIF ET SATISFAISANT. PARFAIT POUR UN JOUR SANS VIANDE.`,
                    ingredients: (protein, carb, veggie1, veggie2, supplement, pPortion, cPortion, numPeople) => [ // Ajout de numPeople
                        `${pPortion} DE ${protein.name.toUpperCase()}`,
                        `${cPortion} DE ${carb.name.toUpperCase()}`,
                        `${Math.round(150 * numPeople)}g DE ${veggie1.name.toUpperCase()}`, // Scaled
                        `${Math.round(150 * numPeople)}g DE ${veggie2.name.toUpperCase()}`, // Scaled
                        `${Math.round(10 * numPeople)}ml ${supplement.name.toUpperCase()}`, // Scaled
                        `${Math.round(100 * numPeople)}ml LAIT DE COCO`, // Scaled
                        `ÉPICES CURRY`
                    ],
                    preparation: [
                        "1. CUIRE LE RIZ SELON LES INSTRUCTIONS.",
                        "2. DANS UNE GRANDE POÊLE, FAIRE SAUTER LES LÉGUMES ET LES ${protein.name.toUpperCase()} AVEC L'HUILE ET LES ÉPICES CURRY.",
                        "3. AJOUTER LE LAIT DE COCO ET LAISSER MIJOTER QUELQUES MINUTES. SERVIR AVEC LE ${carb.name.toUpperCase()}."
                    ]
                },
                collation: {
                    name: (snack) => `${snack.name.toUpperCase()} RAPIDE`,
                    description: (mealType, poste, sport, userProfile) => `UNE COLLATON RAPIDE ET ÉNERGISANTE, ADAPTÉE À VOTRE ACTIVITÉ (${sport.toUpperCase()}) ET TYPE DE POSTE (${poste.toUpperCase()}).`,
                }
            },
            snacks: [
                { name: "FRUIT FRAIS ET AMANDES", type: "fruit_nuts", base_portion: { 'pomme_qty': 1, 'amandes_g': 30 } },
                { name: "YAOURT GREC ET BAIES", type: "dairy_fruit", base_portion: { 'yaourt_g': 150, 'baies_g': 50 } },
                { name: "SHAKE PROTÉINÉ", type: "protein_shake", base_portion: { 'scoop_protein_qty': 1, 'lait_ml': 200 } },
                { name: "GALETTES DE RIZ ET PURÉE DE CACAHUÈTE", type: "carb_fat", base_portion: { 'galettes_qty': 2, 'cacahuete_g': 20 } },
                { name: "OEUFS DURS", type: "egg", base_portion: { 'oeufs_qty': 2 } }
            ]
        };

        const sleepRoutines = { /* ... (identique au code React précédent) ... */
            '6h-18h': {
                name: "ROUTINE JOUR (6H-18H)",
                details: [
                    "COUCHER : 22H00 - 23H00.",
                    "RÉVEIL : 05H00 - 06H00.",
                    "ASSURER 7-8H DE SOMMEIL DE QUALITÉ. ÉVITER LES ÉCRANS AVANT LE COUCHER."
                ]
            },
            '7h-18h': {
                name: "ROUTINE JOUR (7H-18H)",
                details: [
                    "COUCHER : 22H00 - 23H00.",
                    "RÉVEIL : 06H00 - 07H00.",
                    "OBJECTIF 7-8H DE SOMMEIL. PRIVILÉGIER UN RITUEL DE DÉTENTE PRÉ-SOMMEIL."
                ]
            },
            '18h-6h': {
                name: "ROUTINE NUIT (18H-6H)",
                details: [
                    "SOMMEIL PRINCIPAL APRÈS LE POSTE : 07H00 - 14H00/15H00 (7-8H).",
                    "SIESTE PRÉ-POSTE (OPTIONNEL) : 17H00 - 17H45 (45 MIN) POUR BOOSTER LA VIGILANCE.",
                    "UTILISER DES RIDEAUX OCCULTANTS ET UN MASQUE DE SOMMEIL POUR OPTIMISER LE REPOS EN JOURNÉE."
                ]
            },
            'repos': {
                name: "JOUR DE REPOS (RÉCUPÉRATION)",
                details: [
                    "MAINTENIR UN HORAIRE DE SOMMEIL PROCHE DES JOURS DE TRAVAIL POUR NE PAS PERTURBER LE RYTHME CIRCADIEN.",
                    "COUCHER : VERS 23H00.",
                    "RÉVEIL : VERS 08H00-09H00.",
                    "POSSIBILITÉ DE SIÈSTE COURTE (20-30 MIN) EN DÉBUT D'APRÈS-MIDI SI NÉCESSAIRE."
                ]
            },
            'repos_sport': {
                name: "JOUR DE REPOS (SPORT)",
                details: [
                    "COUCHER : VERS 22H30-23H30.",
                    "RÉVEIL : VERS 07H00-08H00.",
                    "SOMMEIL OPTIMAL POUR LA RÉCUPÉRATION MUSCULAIRE. ÉVITER LES EXCITANTS APRÈS L'ENTRAÎNEMENT."
                ]
            }
        };

        // =====================================================================
        // SECTION 3: FONCTIONS UTILITAIRES ET DE GESTION DE L'ÉTAT
        // =====================================================================

        // --- Fonctions de gestion du localStorage ---
        /**
         * Sauvegarde les données dans le localStorage.
         * @param {string} key - Clé sous laquelle stocker les données.
         * @param {any} data - Les données à stocker.
         */
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                console.log(`[LocalStorage] Données sauvegardées pour '${key}'.`);
            } catch (e) {
                console.error(`[LocalStorage] Erreur lors de l'enregistrement pour '${key}':`, e);
                showMessage(`ERREUR: Impossible de sauvegarder ${key}.`, 'error');
            }
        }

        /**
         * Charge les données depuis le localStorage.
         * @param {string} key - Clé des données à charger.
         * @param {any} defaultValue - Valeur par défaut si les données ne sont pas trouvées ou sont corrompues.
         * @returns {any} Les données chargées ou la valeur par défaut.
         */
        function loadFromLocalStorage(key, defaultValue) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`[LocalStorage] Erreur lors du chargement pour '${key}':`, e);
                showMessage(`ATTENTION: Données corrompues pour ${key}. Chargement par défaut.`, 'warning');
                return defaultValue;
            }
        }

        /**
         * Supprime une clé du localStorage.
         * @param {string} key - Clé à supprimer.
         */
        function removeFromLocalStorage(key) {
            try {
                localStorage.removeItem(key);
                console.log(`[LocalStorage] Données supprimées pour '${key}'.`);
            } catch (e) {
                console.error(`[LocalStorage] Erreur lors de la suppression pour '${key}':`, e);
                showMessage(`ERREUR: Impossible de supprimer ${key}.`, 'error');
            }
        }

        // Initialiser l'état global à partir du localStorage
        function initializeGlobalState() {
            console.log("[INITIALISATION] Chargement de l'état global depuis localStorage...");
            userProfile = loadFromLocalStorage('userProfile', {
                height: '', weight: '', imc: null, imcCategory: '', proteinNeeds: 'N/A',
                currentXP: 0, earnedTrophies: [], hideExerciseHistory: false, apiKey: ''
            });
            weeklyMealPlan = loadFromLocalStorage('weeklyMealPlan', { semaine: [] });
            workoutLogs = loadFromLocalStorage('workoutLogs', []);
            weightHistory = loadFromLocalStorage('weightHistory', []);
            intervalSequences = loadFromLocalStorage('intervalSequences', []);
            shifts = loadFromLocalStorage('shifts', []);
            // Charger le programme d'entraînement personnalisé si existant, sinon utiliser la valeur par défaut
            workoutProgram = loadFromLocalStorage('savedWorkoutProgram', JSON.parse(JSON.stringify(defaultWorkoutProgramStructure)));

            // Initialiser previousLevel avec le niveau actuel de l'utilisateur
            previousLevel = calculateLevelAndXP(userProfile.currentXP).level;

            const savedChronoState = loadFromLocalStorage('chronoState', {});
            chronoIntervals = savedChronoState.intervals || [];
            chronoCurrentTime = savedChronoState.currentTime || 0;
            chronoCurrentIntervalIndex = savedChronoState.currentIntervalIndex !== undefined ? savedChronoState.currentIntervalIndex : -1;
            isChronoRunning = savedChronoState.isRunning || false;
            isChronoPaused = savedChronoState.isPaused || false;
            enableChronoPreCountdown = savedChronoState.enablePreCountdown !== undefined ? savedChronoState.enablePreCountdown : true;
            chronoPreCountdownDuration = savedChronoState.preCountdownDuration || 10;

            if (!Array.isArray(userProfile.earnedTrophies)) {
                userProfile.earnedTrophies = [];
                console.warn("[INITIALISATION] earnedTrophies n'était pas un tableau, réinitialisé.");
            }
            console.log("[INITIALISATION] État global chargé.");
        }

        /**
         * Met à jour l'état du chrono dans le localStorage.
         */
        function updateLocalStorageChronoState() {
            saveToLocalStorage('chronoState', {
                intervals: chronoIntervals, currentTime: chronoCurrentTime, currentIntervalIndex: chronoCurrentIntervalIndex,
                isRunning: isChronoRunning, isPaused: isChronoPaused, enablePreCountdown: enableChronoPreCountdown,
                preCountdownDuration: chronoPreCountdownDuration
            });
        }


        // --- Système de Notifications et Messages ---
        /**
         * Affiche un message général (info, succès, erreur, avertissement, chrono, tip) en bas à droite.
         * @param {string} msg - Le message à afficher.
         * @param {'info'|'success'|'error'|'warning'|'chrono'|'tip'} type - Le type de message pour le style.
         */
        function showMessage(msg, type = 'info') {
            const container = document.getElementById('notification-container-bottom-right');
            const notification = document.createElement('div');
            notification.className = `notification general ${type}`;
            const iconMap = {
                'success': '🎉', 'error': '❌', 'warning': '⚠️', 'info': 'ℹ️', 'chrono': '⏱️', 'tip': '💡'
            };
            notification.innerHTML = `
                <span class="text-2xl">${iconMap[type] || 'ℹ️'}</span>
                <p class="font-bold text-sm sm:text-base">${String(msg).toUpperCase()}</p>
            `;
            container.appendChild(notification);

            void notification.offsetWidth; // Trigger reflow to ensure animation plays
            notification.classList.add('show');

            const duration = type === 'trophy' ? 12000 : (type === 'tip' ? 20000 : 5000); // 20 seconds for tips
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, duration);
        }

        /**
         * Affiche une notification de trophée (haut gauche).
         * @param {string} trophyName - Nom du trophée.
         * @param {string} description - Description du trophée.
         */
        function showTrophyNotification(trophyName, description) {
            const container = document.getElementById('notification-container-trophy');
            const notification = document.createElement('div');
            notification.className = 'notification trophy';
            notification.innerHTML = `
                <span class="text-4xl">🏆</span>
                <div>
                    <p class="font-bold text-lg sm:text-xl">TROPHÉE DÉBLOQUÉ !</p>
                    <p class="text-yellow-300 text-sm sm:text-base">${String(trophyName).toUpperCase()}</p>
                    <p class="text-gray-200 text-xs sm:text-sm">${String(description).toUpperCase()}</p>
                </div>
            `;
            container.appendChild(notification);
            playTrophySound();

            void notification.offsetWidth;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true });
            }, 12000);
        }

        // --- Fonctions Audio (Tone.js & SpeechSynthesis) ---
        let audioContextStartedOnce = false;

        async function initializeAudioContextNonBlocking() {
            if (Tone.context.state === 'running' || audioContextStartedOnce) return;
            try {
                await Tone.start();
                audioContextStartedOnce = true;
                isAudioActive = true;
                Tone.Master.mute = false;
                Tone.Master.volume.value = masterVolume === 0 ? -Infinity : 20 * Math.log10(masterVolume);
                document.getElementById('audio-inactive-message').classList.add('hidden');
            } catch (e) {
                isAudioActive = false;
                Tone.Master.mute = true;
                document.getElementById('audio-inactive-message').classList.remove('hidden');
                document.getElementById('audio-inactive-message').textContent = "AUDIO DÉSACTIVÉ. CLIQUEZ OU APPUYEZ SUR UNE TOUCHE POUR ACTIVER LE SON ET LA SYNTHÈSE VOCALE.";
            }
        }

        function handleUserGestureToStartAudio() {
            window.removeEventListener('click', handleUserGestureToStartAudio);
            window.removeEventListener('keydown', handleUserGestureToStartAudio);
            initializeAudioContextNonBlocking();
        }

        function setupAudioPlayers() {
            trophySoundPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 } }).toDestination();
            levelUpPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.05, sustain: 0.1, release: 0.2 } }).toDestination();
            majorLevelUpPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.6 }, volume: -6 }).toDestination();
            beepPlayer = new Tone.Oscillator(440, "sine").toDestination();
            startSoundPlayer = new Tone.PolySynth(Tone.Synth).toDestination();

            loadingSoundLoop = new Tone.Loop(time => {
                if (Tone.context && Tone.context.state === 'running') {
                    new Tone.MembraneSynth().toDestination().triggerAttackRelease("C3", "16n", time);
                }
            }, "8n");
            loadingSoundLoop.stop();

            synth = window.speechSynthesis;
            Tone.Master.volume.value = masterVolume === 0 ? -Infinity : 20 * Math.log10(masterVolume);
            Tone.Master.mute = !isAudioActive;
        }

        function toggleAudioActive() {
            isAudioActive = !isAudioActive;
            if (isAudioActive) {
                initializeAudioContextNonBlocking();
                showMessage("SON ACTIVÉ !", "success");
            } else {
                Tone.Master.mute = true;
                showMessage("SON DÉSACTIVÉ.", "info");
            }
            // Fix: Get the main content container before re-rendering the options view
            const mainContent = document.getElementById('main-content');
            renderOptionsView(mainContent);
        }

        function playTrophySound() {
            if (isAudioActive && Tone.context.state === 'running') {
                trophySoundPlayer.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n", Tone.context.currentTime);
            }
        }

        function playLevelUpSound(level) {
            if (isAudioActive && Tone.context.state === 'running') {
                const now = Tone.context.currentTime;
                if (level > previousLevel) { // Only play if level has actually increased
                    if (level % 10 === 0) { // Specific sound for levels 10, 20, 30...
                        majorLevelUpPlayer.triggerAttackRelease(["C4", "E4", "G4", "C5", "E5"], "2n", now);
                    } else { // General level up sound
                        levelUpPlayer.triggerAttackRelease("C4", "16n", now);
                        levelUpPlayer.triggerAttackRelease("E4", "16n", now + 0.1);
                        levelUpPlayer.triggerAttackRelease("G4", "16n", now + 0.2);
                        levelUpPlayer.triggerAttackRelease("C5", "8n", now + 0.3);
                    }
                }
            }
        }

        function playBeep(freq = 440, duration = 0.1) {
            if (isAudioActive && Tone.context.state === 'running') {
                beepPlayer.stop();
                beepPlayer.start(Tone.context.currentTime);
                beepPlayer.frequency.setValueAtTime(freq, Tone.context.currentTime);
                beepPlayer.stop(Tone.context.currentTime + duration);
            }
        }

        function playMarioKartStartSound() {
    // Vérifie si l'audio est actif et si le contexte Tone.js est en cours d'exécution
    if (isAudioActive && Tone.context.state === 'running') {
        const now = Tone.context.currentTime;
        const beepSynth = new Tone.MembraneSynth().toDestination(); // Pour les bips percussifs
        const goSynth = new Tone.Synth().toDestination(); // Pour le son "Go!" plus mélodique

        // Premier bip (semblable au "3")
        beepSynth.triggerAttackRelease("G4", "8n", now);

        // Deuxième bip (semblable au "2")
        beepSynth.triggerAttackRelease("C5", "8n", now + 0.7); // 0.7 secondes après le premier

        // Troisième bip (semblable au "1")
        beepSynth.triggerAttackRelease("E5", "8n", now + 1.4); // 0.7 secondes après le deuxième

        // Son "GO!" (plus grave et un peu plus long, comme le coup de sifflet)
        goSynth.triggerAttackRelease("C4", "0.5", now + 2.1); // 0.7 secondes après le troisième bip
    }
}


        // MODIFICATION ICI : La fonction speak envoie maintenant le texte à Kodular
        function speak(text) {
            if (isAudioActive) {
                // Utilise la synthèse vocale du navigateur si disponible et active
                if (synth) {
                    synth.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'fr-FR';
                    synth.speak(utterance);
                }
                // Envoie le texte à Kodular via la fonction parlerAvecKodular
                parlerAvecKodular(text);
            }
        }

        // La fonction parlerAvecKodular doit maintenant accepter un argument texte
        function parlerAvecKodular(texte) {
          if (window.AppInventor && window.AppInventor.setWebViewString) {
            window.AppInventor.setWebViewString(texte);
          } else {
            // Replaced alert with showMessage for consistency and better UX
            // showMessage("KODULAR NON DÉTECTÉ, TEXTE : " + texte, 'warning'); // Commenté pour éviter double notification si Kodular n'est pas là
          }
        }


        // --- Fonctions Utilitaires Générales ---
        function generateUniqueId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function formatDateToYYYYMMDD(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDayContextString(shiftType, workoutType) {
            let context = "";
            const sType = String(shiftType || '');
            const wType = String(workoutType || '');

            switch (sType) {
                case '6h-18h': context = "Travail de Jour (6H-18H)"; break;
                case '7h-18h': context = "Travail de Jour (7H-18H)"; break;
                case '18h-6h': context = "Travail de Nuit (18H-6H)"; break;
                case 'repos': context = "Jour de Repos"; break;
                case 'repos_sport': context = "Jour de Repos (SPORT)"; break;
                default: context = "Contexte Inconnu"; break;
            }
            if (wType && wType !== 'aucun') {
                context += ` - Sport: ${wType.toUpperCase().replace('_', ' ')}`;
            }
            return context;
        }

        function getMealMomentContext(mealType, shiftType, sportType) {
            let moment = "";
            const sType = String(shiftType || '');
            const spType = String(sportType || '');

            if (mealType === 'petit_dejeuner') {
                moment = "PETIT-DÉJEUNER";
                if (sType === '18h-6h') moment += " POST-NUIT";
                else if (spType !== 'aucun') moment += " PRÉ-ENTRAÎNEMENT";
            } else if (mealType === 'dejeuner') {
                moment = "DÉJEUNER";
                if (sType === '18h-6h') moment += " PENDANT LE POSTE DE NUIT";
                else if (spType !== 'aucun') moment += " POST-ENTRAÎNEMENT";
                else if (sType.includes('jour')) moment += " JOURNÉE DE TRAVAIL";
            } else if (mealType === 'diner') {
                moment = "DÎNER";
                if (sType === '18h-6h') moment += " PRÉ-POSTE DE NUIT";
                else if (spType !== 'aucun') moment += " POST-ENTRAÎNEMENT";
                else if (sType.includes('jour')) moment += " APRÈS JOURNÉE DE TRAVAIL";
            } else if (mealType === 'collation_matin') {
                moment = "COLLAT. MATIN";
            } else if (mealType === 'collation_apresmidi') {
                moment = "COLLAT. APRÈS-MIDI";
            } else if (mealType === 'collation_unique') {
                if (sType === '18h-6h') moment = "COLLAT. PENDANT POSTE DE NUIT";
                else if (sType === '7h-18h') moment = "COLLAT. APRÈS-MIDI";
                else if (spType !== 'aucun') moment = "COLLAT. POST-SPORT";
                else if (sType.includes('repos')) moment = "COLLAT. LÉGÈRE";
            }
            return moment;
        }

        // Conseils nutritionnels spécifiques mappés aux contextes
        const specificMealAdvice = {
            'petit_dejeuner': {
                '18h-6h': "CONSEIL : APRÈS UN POSTE DE NUIT, PRIVILÉGIE UN REPAS NUTRITIF POUR FAVORISER LA RÉCUPÉRATION ET UN SOMMEIL DE QUALITÉ. LES PROTÉINES ET GLUCIDES LENTS SONT CLÉS.",
                'default': "CONSEIL : UN PETIT-DÉJEUNER ÉQUILIBRÉ EST ESSENTIEL POUR L'ÉNERGIE DU MATIN. VARIE LES SOURCES DE PROTÉINES ET FIBRES."
            },
            'dejeuner': {
                '18h-6h': "CONSEIL : PENDANT UN POSTE DE NUIT, OPTE POUR DES PLATS FACILES À DIGÉRER, RICHES EN PROTÉINES ET LÉGUMES POUR MAINTENIR TON ÉNERGIE SANS ALOURDIR.",
                'repos_sport': "CONSEIL : APRÈS LE SPORT, RECONSTITUE TES RÉSERVES. CE REPAS DEVRAIT ÊTRE RICHE EN GLUCIDES COMPLEXES POUR L'ÉNERGIE ET EN PROTÉINES POUR LA RÉPARATION MUSCULAIRE.",
                'default': "CONSEIL : POUR UN DÉJEUNER OPTIMAL EN JOURNÉE DE TRAVAIL, PRIVILÉGIE UN PLAT ÉQUILIBRÉ QUI APPORTE UNE ÉNERGIE DURABLE SANS CAUSER DE COUP DE BARRE."
            },
            'diner': {
                '18h-6h': "CONSEIL : AVANT UN POSTE DE NUIT, CHOISIS UN DÎNER CONSISTANT MAIS FACILE À DIGÉRER POUR TE DONNER L'ÉNERGIE NÉCESSAIRE SANS PERTURBER TON DÉBUT DE SOMMEIL PRÉ-POSTE.",
                'repos_sport': "CONSEIL : LE DÎNER APRÈS UNE SÉANCE DE SPORT DOIT COMPLÉTER LA RÉCUPÉRATION. CONCENTRE-TOI SUR LES PROTÉINES POUR LA RÉPARATION ET LES GLUCIDES POUR REFAIRE LE PLEIN.",
                'default': "CONSEIL : UN DÎNER LÉGER EST IDÉAL POUR FAVORISER UNE BONNE DIGESTION ET UN SOMMEIL RÉPARATEUR APRÈS UNE JOURNÉE DE TRAVAIL. PRIVILÉGIE LES LÉGUMES ET PROTÉINES MAIGRES."
            },
            'collation': {
                '6h-18h_matin': "CONSEIL : CETTE COLLATON MATINALE EST CLÉ POUR MAINTENIR TON ÉNERGIE ET ÉVITER LES BAISSES DE GLYCÉMIE JUSQU'AU DÉJEUNUR.",
                '6h-18h_apresmidi': "CONSEIL : LA COLLATON DE L'APRÈS-MIDI AIDE À GÉRER LA FAIM ET À SOUTENIR TON ÉNERGIE JUSQU'AU DÎNER, SANS ALOURDIR AVANT LA FIN DU POSTE.",
                '18h-6h_pendant': "CONSEIL : UNE COLLATON PENDANT LA NUIT EST LÉGÈRE ET ÉNERGISANTE POUR MAINTENIR TA VIGILANCE SANS PERTURBER TA DIGESTION.",
                '7h-18h_apresmidi': "CONSEIL : LA COLLATON DE L'APRÈS-MIDI EST PARFAITE POUR SOUTENIR TON ÉNERGIE LORS DES JOURS DE LONG POSTE OU DE REPOS ACTIF.",
                'repos_sport_post': "CONSEIL : UNE COLLATON POST-SPORT EST CRUCIALE POUR UNE RÉCUPÉRATION RAPIDE. PRIVILÉGIE UN MIX DE PROTÉINES ET GLUCIDES.",
                'repos_default': "CONSEIL : UNE COLLATON LÉGÈRE EN JOUR DE REPOS PEUT AIDER À GÉRER LA FAIM ET APPORTER DES NUTRIENTS SUPPLÉMENTAIRES."
            }
        };

        // --- Calcul de l'XP et du Niveau ---
        function getLevelThresholds(level) {
            if (level === 0) return { current: 0, next: 100 };
            let xp = 0;
            let prevLevelThreshold = 0;
            for (let i = 1; i <= level; i++) {
                prevLevelThreshold = xp;
                xp += (i * 50 + 50);
            }
            return { current: prevLevelThreshold, next: xp };
        }

        function calculateLevelAndXP(totalXP) {
            let level = 0;
            let xpNeededForNextLevel = 100;

            while (totalXP >= xpNeededForNextLevel) {
                level++;
                xpNeededForNextLevel += (level * 50 + 50);
            }

            const { current: xpCurrentLevelThreshold, next: xpNextLevelThreshold } = getLevelThresholds(level);
            const xpProgressInCurrentLevel = totalXP - xpCurrentLevelThreshold;
            const xpForThisLevel = xpNextLevelThreshold - xpCurrentLevelThreshold;
            const xpRemainingForNextLevel = xpNextLevelThreshold - totalXP;

            return {
                level: level,
                xpCurrentLevel: xpProgressInCurrentLevel,
                xpForThisLevel: xpForThisLevel,
                xpToNextLevel: xpRemainingForNextLevel
            };
        }

        // =====================================================================
        // SECTION 4: LOGIQUE PRINCIPALE DE L'APPLICATION
        // =====================================================================

        async function initializeApp() {
            isLoadingApp = true;
            renderLoadingScreen();
            let currentLoadProgress = 0;
            const updateProgress = (target) => {
                const diff = target - currentLoadProgress;
                const step = diff / 10;
                const interval = setInterval(() => {
                    currentLoadProgress += step;
                    if (currentLoadProgress >= target) {
                        currentLoadProgress = target;
                        clearInterval(interval);
                    }
                    loadingProgress = Math.min(100, Math.floor(currentLoadProgress));
                    document.getElementById('loading-progress-bar').style.width = `${loadingProgress}%`;
                    document.getElementById('loading-progress-text').textContent = `${loadingProgress}% CHARGEMENT...`;
                }, 50);
            };

            try {
                updateProgress(20);
                setupAudioPlayers();
                updateProgress(40);
                initializeGlobalState(); // Cette fonction charge maintenant workoutProgram
                updateXPBar();
                updateProfileDisplay();
                updateProgress(60);

                userId = 'local_user';
                document.getElementById('user-id-value').textContent = userId;
                document.getElementById('user-id-display').classList.remove('hidden');

                renderPage(currentPage);
                attachEventListeners();
                renderLucideIcons();

                updateProgress(80);

                window.addEventListener('click', handleUserGestureToStartAudio, { once: true });
                window.addEventListener('keydown', handleUserGestureToStartAudio, { once: true });
                initializeAudioContextNonBlocking();

                updateProgress(100);

            } catch (error) {
                console.error("L'initialisation de l'application a échoué:", error);
                showMessage(`ERREUR D'INITIALISATION: ${error.message}`, 'error');
            } finally {
                if (loadingSoundLoop && loadingSoundLoop.state === 'started') {
                    loadingSoundLoop.stop();
                }
                setTimeout(() => {
                    isLoadingApp = false;
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('loading-message').classList.add('hidden');

                    if (!isAudioActive && Tone.context.state !== 'running') {
                        document.getElementById('audio-inactive-message').classList.remove('hidden');
                        document.getElementById('audio-inactive-message').textContent = "AUDIO DÉSACTIVÉ. CLIQUEZ OU APPUYEZ SUR UNE TOUCHE POUR ACTIVER LE SON ET LA SYNTHÈSE VOCALE.";
                    } else if (isAudioActive && Tone.context.state === 'running') {
                        document.getElementById('audio-inactive-message').classList.add('hidden');
                    }
                }, 1000);
            }
        }

        // --- Fonctions de Rendu pour chaque Page/Vue ---
        function renderLoadingScreen() {
            document.getElementById('loading-progress-bar').style.width = `${loadingProgress}%`;
            document.getElementById('loading-progress-text').textContent = `${loadingProgress}% CHARGEMENT...`;
            const audioInactiveMessage = document.getElementById('audio-inactive-message');
            if (audioInactiveMessage) {
                audioInactiveMessage.classList.toggle('hidden', isAudioActive || loadingProgress < 100);
            }
        }

        function renderPage(pageName) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';

            if (weightChartInstance) { weightChartInstance.destroy(); weightChartInstance = null; }
            if (exerciseChartInstance) { exerciseChartInstance.destroy(); exerciseChartInstance = null; }

            document.querySelectorAll('.nav-item').forEach(button => {
                const isActive = button.dataset.page === pageName;
                button.classList.toggle('bg-blue-600', isActive);
                button.classList.toggle('text-white', isActive);
                button.classList.toggle('font-semibold', isActive);
                button.classList.toggle('border-blue-800', isActive);
                button.classList.toggle('shadow-inner', isActive);
                button.classList.toggle('text-gray-200', !isActive);
                button.classList.toggle('hover:bg-gray-700', !isActive);
                button.classList.toggle('hover:text-yellow-300', !isActive);
                button.classList.toggle('border-gray-700', !isActive);
            });

            currentPage = pageName;

            switch (pageName) {
                case 'daily_plan': renderDailyPlanView(mainContent); break;
                case 'workout': renderWorkoutView(mainContent); break;
                case 'recipes': renderRecipeView(mainContent); break;
                case 'chrono': renderChronoIntervalleView(mainContent); break;
                case 'progress': renderProgressView(mainContent); break;
                case 'trophies': renderTrophyRoomView(mainContent); break;
                case 'options': renderOptionsView(mainContent); break;
                default: renderDailyPlanView(mainContent); break;
            }
            renderLucideIcons();
        }

        function updateXPBar() {
            const { level, xpCurrentLevel, xpForThisLevel, xpToNextLevel } = calculateLevelAndXP(userProfile.currentXP);
            const progressBar = document.getElementById('xp-bar-fill');
            const progressText = document.getElementById('xp-bar-text');

            const progressPercentage = xpForThisLevel > 0 ? ((xpForThisLevel - xpToNextLevel) / xpForThisLevel) * 100 : 0;
            const actualProgress = Math.max(0, Math.min(100, progressPercentage));

            progressBar.style.width = `${actualProgress}%`;
            progressText.textContent = `LVL ${level} : ${xpCurrentLevel}/${xpForThisLevel} XP`;

            // Play level up sound only if level has actually increased
            if (level > previousLevel) {
                playLevelUpSound(level);
                speak(`Félicitations, vous avez atteint le niveau ${level} !`);
            }
            previousLevel = level; // Update previousLevel for the next check

            checkAndAwardTrophies(level);
        }

        function checkAndAwardTrophies(currentLevel) {
            let earnedTrophies = userProfile.earnedTrophies || [];
            let newTrophiesEarned = [];

            allTrophies.forEach(trophy => {
                if (currentLevel >= trophy.levelRequired && !earnedTrophies.some(t => t.id === trophy.id)) {
                    newTrophiesEarned.push(trophy);
                    earnedTrophies.push({ id: trophy.id, name: trophy.name, description: trophy.description, levelRequired: trophy.levelRequired, timestamp: new Date().toISOString() });
                }
            });

            if (newTrophiesEarned.length > 0) {
                userProfile.earnedTrophies = earnedTrophies;
                saveToLocalStorage('userProfile', userProfile);

                newTrophiesEarned.forEach(trophy => showTrophyNotification(trophy.name, trophy.description));
                if (currentPage === 'trophies') renderTrophyRoomView(document.getElementById('main-content'));
            }
        }


        // --- Gestion du Profil ---
        function updateProfileDisplay() {
            const heightInput = document.getElementById('userHeight');
            const weightInput = document.getElementById('userWeight');
            const imcDisplay = document.getElementById('imc-display');
            const imcValue = document.getElementById('imc-value');
            const imcCategory = document.getElementById('imc-category');
            const proteinNeeds = document.getElementById('protein-needs');

            heightInput.value = userProfile.height;
            weightInput.value = userProfile.weight;

            if (userProfile.imc && userProfile.imcCategory && userProfile.proteinNeeds) {
                imcValue.textContent = userProfile.imc;
                imcCategory.textContent = userProfile.imcCategory;
                proteinNeeds.textContent = `${userProfile.proteinNeeds} G/JOUR`;
                imcDisplay.classList.remove('hidden');
            } else {
                imcDisplay.classList.add('hidden');
            }
        }

        async function handleSaveProfile() {
            const height = document.getElementById('userHeight').value;
            const weight = document.getElementById('userWeight').value;

            if (!height || !weight) {
                showMessage("ERREUR: TAILLE ET POIDS REQUIS POUR L'IMC.", 'error');
                return;
            }

            const currentHeight = parseFloat(height);
            const currentWeight = parseFloat(weight);
            const currentImc = (currentWeight / ( (currentHeight / 100) * (currentHeight / 100) )).toFixed(2);
            let currentImcCategory;
            const imcVal = parseFloat(currentImc);

            const imcCategories = [
                { threshold: 16.5, category: 'INSUFFISANCE PONDÉRALE (DÉNUTRITION SÉVÈRE)' },
                { threshold: 18.5, category: 'INSUFFISANCE PONDÉRALE' },
                { threshold: 25, category: 'POIDS NORMAL' },
                { threshold: 27, category: 'SURPOIDS (PRÉ-OBÉSITÉ)' },
                { threshold: 30, category: 'OBÉSITÉ CLASSE I' },
                { threshold: 35, category: 'OBÉSITÉ CLASSE II (SÉVÈRE)' },
                { threshold: 40, category: 'OBÉSITÉ CLASSE III (MORBIDE OU MASSIVE)' },
                { threshold: Infinity, category: 'OBÉSITÉ CLASSE III (MORBIDE OU MASSIVE)' } // Fallback for values >= 40
            ];


            for (const cat of imcCategories) {
                if (imcVal < cat.threshold) {
                    currentImcCategory = cat.category;
                    break;
                }
            }

            const proteinMultiplier = 1.6;
            const currentProteinNeeds = (currentWeight * proteinMultiplier).toFixed(0);

            let newXP = userProfile.currentXP;
            const oldWeight = parseFloat(userProfile.weight) || 0;
            const oldImcCategory = userProfile.imcCategory || '';

            if (oldWeight > 0 && currentWeight !== oldWeight) {
                const weightDiff = oldWeight - currentWeight;
                const oldImcIndex = imcCategories.findIndex(c => c.category === oldImcCategory);
                const currentImcIndex = imcCategories.findIndex(c => c.category === currentImcCategory);

                if (currentImcIndex < oldImcIndex) {
                    newXP += 50; showMessage(`XP GAGNÉE: AMÉLIORATION DE L'IMC !`, 'success');
                } else if (currentImcIndex > oldImcIndex) {
                    newXP = Math.max(0, newXP - 30); showMessage(`XP PERDUE: DÉTÉRIORATION DE L'IMC.`, 'warning');
                }

                if (currentImcCategory === 'POIDS NORMAL') {
                    if (!oldImcCategory.includes('POIDS NORMAL')) {
                         newXP += 100; showMessage(`XP GAGNÉE: ENTRÉE DANS LA CATÉGORIE DE POIDS NORMAL !`, 'success');
                    } else {
                        newXP += 5; showMessage(`XP GAGNÉE: MAINTIEN DANS LA CATÉGORIE DE POIDS NORMAL !`, 'success');
                    }
                } else if (currentImcCategory.includes('INSUFFISANCE PONDÉRALE') && weightDiff < 0) {
                    newXP += Math.round(Math.abs(weightDiff) * 10); showMessage(`XP GAGNÉE: PRISE DE POIDS VERS LA NORMALITÉ !`, 'success');
                } else if ((currentImcCategory.includes('SURPOIDS') || currentImcCategory.includes('OBÉSITÉ')) && weightDiff > 0) {
                    newXP += Math.round(weightDiff * 10); showMessage(`XP GAGNÉE: PERTE DE POIDS VERS LA NORMALITÉ !`, 'success');
                } else if (currentImcCategory.includes('INSUFFISANCE PONDÉRALE') && weightDiff > 0) {
                     newXP = Math.max(0, newXP - Math.round(weightDiff * 5)); showMessage(`XP PERDUE: PERTE DE POIDS À PARTIR DE LA NORMALITÉ !`, 'warning');
                } else if ((currentImcCategory.includes('SURPOIDS') || currentImcCategory.includes('OBÉSITÉ')) && weightDiff < 0) {
                     newXP = Math.max(0, newXP - Math.round(Math.abs(weightDiff) * 5)); showMessage(`XP PERDUE: PRISE DE POIDS À PARTIR DE LA NORMALITÉ !`, 'warning');
                }
            }

            userProfile = {
                ...userProfile,
                height: currentHeight, weight: currentWeight, imc: currentImc, imcCategory: currentImcCategory,
                proteinNeeds: currentProteinNeeds, currentXP: newXP, updatedAt: new Date().toISOString()
            };

            saveToLocalStorage('userProfile', userProfile);
            updateProfileDisplay();
            updateXPBar();

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayFormatted = formatDateToYYYYMMDD(today);

            const existingEntryIndex = weightHistory.findIndex(entry => formatDateToYYYYMMDD(new Date(entry.date)) === todayFormatted);
            if (existingEntryIndex !== -1) {
                weightHistory[existingEntryIndex] = { ...weightHistory[existingEntryIndex], weight: currentWeight, imc: currentImc, imcCategory: currentImcCategory, timestamp: new Date().toISOString() };
            } else {
                weightHistory.push({ id: generateUniqueId(), date: new Date().toISOString(), weight: currentWeight, imc: currentImc, imcCategory: currentImcCategory, timestamp: new Date().toISOString() });
            }
            saveToLocalStorage('weightHistory', weightHistory);
            if (currentPage === 'progress') renderProgressView(document.getElementById('main-content'));
        }


        // --- Vue du Planning Quotidien ---
        function renderDailyPlanView(container) {
            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">MON PLANNING</h2>
                    <div class="mb-6 space-y-4 p-4 rounded-lg border-2 border-blue-700 bg-gray-700">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">AJOUTER UN POSTE :</h3>
                        <div class="relative">
                        <label for="shiftDate" class="block text-white-200 text-sm font-bold mb-2">DATE DU POSTE :</label> 
                        <input type="date" id="shiftDate" class="input-retro pr-10" style="color: #ffffff;" value="" />
                        <i data-lucide="calendar" class="absolute right-11 top-12 -translate-y-1/2 text-white pointer-events-none" style="width:15px; height:18px;"></i> 
                        </div>
                        <div><label for="shiftType" class="block text-gray-200 text-sm font-bold mb-2">TYPE DE POSTE :</label>
                            <select id="shiftType" class="select-retro">
                                <option value="6h-18h">POSTE JOUR (6H-18H)</option><option value="7h-18h">POSTE JOUR (7H-18H)</option>
                                <option value="18h-6h">POSTE NUIT (18H-6H)</option><option value="repos">JOUR DE REPOS</option>
                                <option value="repos_sport">JOUR DE REPOS (SPORT)</option>
                            </select>
                        </div>
                        <div><label for="workoutType" class="block text-gray-200 text-sm font-bold mb-2">SÉANCE SPORT PRÉVUE :</label>
                            <select id="workoutType" class="select-retro">
                                <option value="aucun">AUCUNE</option><option value="renforcement">RENFORCEMENT MUSCULAIRE</option>
                                <option value="cardio">CARDIO</option><option value="hiit">HIIT</option>
                                <option value="repos_actif">RÉCUPÉRATION ACTIVE / FLEXIBILITÉ</option>
                            </select>
                        </div>
                        <button id="add-shift-btn" class="btn-retro w-full">AJOUTER POSTE</button>
                    </div>
                    <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">TON PLAN POUR LES JOURS PLANIFIÉS :</h3>
                    <div id="shifts-list" class="space-y-6"></div>
                </div>`;
            container.innerHTML = html;

            const shiftDateInput = document.getElementById('shiftDate');
            const shiftTypeSelect = document.getElementById('shiftType');
            const workoutTypeSelect = document.getElementById('workoutType');
            const addShiftBtn = document.getElementById('add-shift-btn');
            const shiftsListDiv = document.getElementById('shifts-list');

            addShiftBtn.onclick = async () => {
                const date = shiftDateInput.value;
                const type = shiftTypeSelect.value;
                const workout = workoutTypeSelect.value;

                if (!date || !type) { showMessage("ERREUR: DATE ET TYPE DE POSTE REQUIS.", 'error'); return; }

                const dateObj = new Date(date);
                dateObj.setHours(0, 0, 0, 0);

                if (shifts.some(s => formatDateToYYYYMMDD(new Date(s.date)) === formatDateToYYYYMMDD(dateObj))) {
                    showMessage("ERREUR: POSTE DÉJÀ ENREGISTRÉ POUR CETTE DATE.", 'error'); return;
                }

                shifts.push({ id: generateUniqueId(), date: dateObj.toISOString(), type: type, workoutType: workout, createdAt: new Date().toISOString() });
                saveToLocalStorage('shifts', shifts);
                showMessage("SUCCÈS: POSTE AJOUTÉ !", 'success');
                shiftDateInput.value = ''; workoutTypeSelect.value = 'aucun';
                renderDailyPlanView(container);
            };

            renderShiftsList(shiftsListDiv, shifts);
        }

        function renderShiftsList(container, shiftsData) {
            container.innerHTML = '';
            if (shiftsData.length === 0) { container.innerHTML = '<p class="text-gray-400">AUCUN POSTE ENREGISTRÉ. AJOUTE TON PREMIER POSTE CI-DESSOUS !</p>'; return; }

            const sortedShifts = [...shiftsData].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            sortedShifts.forEach(shift => {
                const dateObj = new Date(shift.date);
                const dateString = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
                const routine = sleepRoutines[String(shift.type)] || sleepRoutines['repos'];
                const mealForThisDay = weeklyMealPlan?.semaine?.find(d => d.date === formatDateToYYYYMMDD(dateObj));

                const shiftDiv = document.createElement('div');
                shiftDiv.className = "bg-gray-700 p-4 rounded-lg border-4 border-purple-500 shadow-lg";
                shiftDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <h4 class="text-lg sm:text-xl font-bold text-yellow-300">${dateString} - POSTE: ${String(shift.type).toUpperCase()}</h4>
                        <button class="btn-retro-red text-sm px-3 py-1 mt-2 sm:mt-0 delete-shift-btn" data-id="${shift.id}">SUPPRIMER</button>
                    </div>
                    ${String(shift.workoutType) !== 'aucun' ? `<div class="mb-3 p-2 bg-blue-800 rounded-md border border-purple-400"><p class="text-sm sm:text-base font-medium text-white">SÉANCE SPORT : ${String(shift.workoutType).toUpperCase().replace('_', ' ')} PRÉVUE</p></div>` : ''}
                    <div class="mb-4">
                        <h5 class="font-semibold text-base sm:text-lg text-yellow-300 mb-2">¤ ROUTINE SOMMEIL : ${String(routine.name).toUpperCase()}</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">${routine.details.map(detail => `<li>${String(detail).toUpperCase()}</li>`).join('')}</ul>
                    </div>
                    <div class="mb-4">
                        <h5 class="font-semibold text-base sm:text-lg text-yellow-300 mb-2">{'}'}  PLAN REPAS SUGGÉRÉ :</h5>
                        ${mealForThisDay ? `<ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                ${mealForThisDay.petit_dejeuner ? `<li>**PETIT-DÉJEUNER :** ${String(mealForThisDay.petit_dejeuner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.dejeuner ? `<li>**DÉJEUNER :** ${String(mealForThisDay.dejeuner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.diner ? `<li>**DÎNER :** ${String(mealForThisDay.diner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_matin ? `<li>**COLLAT. MATIN :** ${String(mealForThisDay.collation_matin.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_apresmidi ? `<li>**COLLAT. APRÈS-MIDI :** ${String(mealForThisDay.collation_apresmidi.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_unique ? `<li>**COLLAT. UNIQUE :** ${String(mealForThisDay.collation_unique.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                            </ul>` : `<p class="text-gray-400">PLAN DE REPAS NON DISPONIBLE POUR CE JOUR. GÉNÉREZ UN PLAN HEBDOMADAIRE DANS L'ONGLET "RECETTES".</p>`}
                    </div>`;
                container.appendChild(shiftDiv);
            });

            container.querySelectorAll('.delete-shift-btn').forEach(button => {
                button.onclick = async (event) => {
                    const idToDelete = event.target.dataset.id;
                    if (await showConfirmModal("CONFIRMER LA SUPPRESSION DU POSTE ?")) {
                        shifts = shifts.filter(s => s.id !== idToDelete);
                        saveToLocalStorage('shifts', shifts);
                        showMessage("SUCCÈS: POSTE SUPPRIMÉ !", 'success');
                        renderDailyPlanView(document.getElementById('main-content'));
                    }
                };
            });
        }


        // --- Vue d'Entraînement ---
        function renderWorkoutView(container) {
            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">PROGRAMME SPORTIF</h2>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700">
                        <h3 class="font-semibold text-xl sm:text-2xl mb-3 text-yellow-300">LIGNES DIRECTRICES SPORTIVES :</h3>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base space-y-1">
                            <li>3-4 SESSIONS PAR SEMAINE (FORCÉ / CARDIO OU ALTERNANCE HIIT).</li>
                            <li>10-15 MIN D'ÉCHAUFFEMENT AVANT CHAQUE SÉANCE.</li>
                            <li>5-10 MIN DE RÉCUPÉRATION ET D'ÉTireMENTS APRÈS CHAQUE SÉANCE.</li>
                            <li>LES JOURS DE REPOS ACTIF (MARCHE, ÉTIREMENTS DOUX) FORTEMENT RECOMMANDÉS POUR LA RÉCUPÉRATION (SCLÉROSE EN PLAQUES).</li>
                            <li>HYDRATATION CONSTANTE.</li>
                        </ul>
                    </div>
                    <div class="mb-6 mt-6"><label for="phaseSelect" class="block text-gray-200 text-sm font-bold mb-2">CHOISIR UNE PHASE :</label>
                        <select id="phaseSelect" class="select-retro">
                            <option value="phase1">${String(workoutProgram.phase1?.name || 'PHASE 1').toUpperCase()}</option>
                            <option value="phase2">${String(workoutProgram.phase2?.name || 'PHASE 2').toUpperCase()}</option>
                        </select>
                    </div>
                    <div id="workout-phase-content" class="space-y-6"></div>
                </div>`;
            container.innerHTML = html;

            const phaseSelect = document.getElementById('phaseSelect');
            const workoutPhaseContent = document.getElementById('workout-phase-content');

            let selectedPhase = loadFromLocalStorage('selectedWorkoutPhase', 'phase1');
            // Assurer que la phase sélectionnée existe dans le nouveau programme
            if (!workoutProgram[selectedPhase]) {
                selectedPhase = 'phase1'; // Revenir à la phase 1 par défaut si la phase précédente n'existe plus
                saveToLocalStorage('selectedWorkoutPhase', selectedPhase);
            }
            phaseSelect.value = selectedPhase;

            function renderPhaseContent(phase) {
                const currentPhaseData = workoutProgram[phase];
                if (!currentPhaseData || !currentPhaseData.sessions || !currentPhaseData.sessions.main || !currentPhaseData.sessions.cardio || !currentPhaseData.sessions.hiit) {
                    workoutPhaseContent.innerHTML = '<p class="text-gray-400 text-center">CONTENU DE LA PHASE INDISPONIBLE. VEUILLEZ IMPORTER UN PROGRAMME VALIDE ET COMPLET.</p>';
                    return;
                }

                const generateExerciseHtml = (ex, index) => `
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 rounded-md border-2 border-blue-700 bg-gray-800 shadow-md">
                        <div class="flex-1">
                            <p class="font-medium text-gray-100 text-base sm:text-lg">${index + 1}. ${String(ex.name).toUpperCase()}</p>
                            <p class="text-sm text-gray-400 italic">${String(ex.desc).toUpperCase()}</p>
                        </div>
                        <button class="btn-retro-green text-sm px-4 py-2 mt-2 sm:mt-0 log-workout-btn" data-exercise-name="${ex.name}" data-exercise-type="${ex.type}">ENREGISTRER</button>
                    </div>`;

                let phaseHtml = `
                    <h3 class="text-xl sm:text-2xl font-bold text-blue-400">${String(currentPhaseData.name).toUpperCase()}</h3>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-yellow-300">PRINCIPES GÉNÉRAUX DE L'ENTRAÎNEMENT :</h4>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base space-y-1">
                            <li>ÉCOUTEZ VOTRE CORPS : NE JAMAIS FORCER SI VOUS AVEZ MAL.</li><li>LA FORME AVANT LA CHARGE : CONCENTREZ-VOUS SUR L'EXÉCUTION CORRECTE.</li>
                            <li>SURCHARGE PROGRESSIVE : AUGMENTEZ LA CHARGE OU LES RÉPÉTITIONS LORSQUE VOUS ÊTES À L'AISE.</li><li>HYDRATATION : BUVEZ DE L'EAU AVANT, PENDANT ET APRÈS CHAQUE SÉANCE.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-yellow-300">${String(currentPhaseData.sessions.main.name).toUpperCase()}</h4>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-blue-400">ÉCHAUFFEMENT (10-15 MIN) % :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base mb-4 space-y-1">
                            <li>**CARDIO LÉGER (5-7 MIN):** TAPIS DE COURSE (MARCHE RAPIDE 5,0 KM/H, INCLINAISON 1,0) OU VÉLO/ELLIPTIQUE (NIVEAU 3-5).</li>
                            <li>**MOBILISATIONS ARTICULAIRES DYNAMIQUES (5-8 MIN):** CERCLES DE BRAS, ROTATIONS DU TORSE, FENTES (À VIDE), ROTATIONS DE HANCHE, CERCLES DE CHEVILLES ET DE POIGNETS (10-15 RÉPÉTITIONS CHACUN).</li>
                        </ul>
                        <div class="space-y-3">${currentPhaseData.sessions.main.exercises.map(generateExerciseHtml).join('')}</div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-blue-400">RÉCUPÉRATION (5-10 MIN) ,  :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base space-y-1">
                            <li>**ÉTIREMENTS DOUX :** MAINTENEZ CHAQUE ÉTIREMENT PENDANT 20-30 SECONDES, SANS DOULEUR. CONCENTREZ-VOUS SUR LES ISCHIO-JAMBIERS, LES QUADRICÈPES, LES PECTORAUX, LE DOS, LES ÉPAULES ET LES BRAS.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-yellow-300">${String(currentPhaseData.sessions.cardio.name).toUpperCase()}</h4>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-blue-400">ÉCHAUFFEMENT (10-15 MIN) % :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base mb-4 space-y-1">
                            <li>**CARDIO LÉGER (5-7 MIN):** TAPIS DE COURSE (MARCHE RAPIDE 5,0 KM/H, INCLINAISON 1,0) OU VÉLO/ELLIPTIQUE (NIVEAU 3-5).</li>
                            <li>**MOBILISATIONS ARTICULAIRES DYNAMIQUES (5-8 MIN):** CERCLES DE BRAS, ROTATIONS DU TORSE, FENTES (À VIDE), ROTATIONS DE HANCHE, CERCLES DE CHEVILLES ET DE POIGNETS (10-15 RÉPÉTITIONS CHACUN).</li>
                        </ul>
                        <div class="space-y-3">${currentPhaseData.sessions.cardio.options.map(generateExerciseHtml).join('')}</div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-blue-400">RÉCUPÉRATION (5-10 MIN) ,  :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base space-y-1">
                            <li>**ÉTIREMENTS DOUX :** MAINTENEZ CHAQUE ÉTIREMENT PENDANT 20-30 SECONDES, SANS DOULEUR. CONCENTREZ-SIO-JAMBIERS, LES QUADRICÈPES, LES PECTORAUX, LE DOS, LES ÉPAULES ET LES BRAS.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-yellow-300">${String(currentPhaseData.sessions.hiit.name).toUpperCase()}</h4>
                        <p class="text-sm sm:text-base text-gray-300 mb-4">${String(currentPhaseData.sessions.hiit.desc).toUpperCase()}</p>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-blue-400">ÉCHAUFFEMENT (10-15 MIN) % :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base mb-4 space-y-1">
                            <li>**MOBILISATIONS ARTICULAIRES DYNAMIQUES (5-7 MIN):** CERCLES DE BRAS, ROTATIONS DU TORSE, FENTES (À VIDE), ROTATIONS DE HANCHE, CERCLES DE CHEVILLES ET DE POIGNETS (10-15 RÉPÉTITIONS CHACUN).</li>
                        </ul>
                        <div class="space-y-3">${currentPhaseData.sessions.hiit.exercises.map(generateExerciseHtml).join('')}</div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-blue-400">RÉCUPÉRATION (5-10 MIN) ,  :</h5>
                        <ul class="list-disc list-inside text-gray-300 text-sm sm:text-base space-y-1">
                            <li>**RETOUR AU CALME :** MARCHE LÉGÈRE ET RESPIRATION PROFONDE.</li>
                            <li>**ÉTIREMENTS DOUX :** AXÉS SUR LES MUSCLES PRINCIPAUX SOLLICITÉS.</li>
                        </ul>
                    </div>`;
                workoutPhaseContent.innerHTML = phaseHtml;
                renderLucideIcons();

                workoutPhaseContent.querySelectorAll('.log-workout-btn').forEach(button => {
                    button.onclick = (event) => showLogWorkoutModal({ name: event.target.dataset.exerciseName, type: event.target.dataset.exerciseType });
                });
            }

            phaseSelect.onchange = (event) => {
                selectedPhase = event.target.value;
                saveToLocalStorage('selectedWorkoutPhase', selectedPhase);
                renderPhaseContent(selectedPhase);
            };

            renderPhaseContent(selectedPhase);
        }

        async function generateAndShowDifficultyTip(feeling, exerciseName) {
            const LLM_PROMPT = `
                Tu es un coach sportif expert et bienveillant.
                Waeky vient d'enregistrer un exercice : "${exerciseName.toUpperCase()}" avec un ressenti de difficulté : "${feeling.toUpperCase()}".

                Génère un conseil court (maximum 2 phrases) et motivant, adapté à ce ressenti.
                - Si "FACILE", encourage à augmenter la difficulté (poids, répétitions, vitesse, durée) ou à varier.
                - Si "MOYEN", encourage à maintenir l'effort et la constance, ou à envisager une légère progression.
                - Si "DIFFICILE", encourage à persévérer, à se reposer, ou à ajuster la charge/intensité pour éviter le surentraînement.

                FORMAT DE RÉPONSE ATTENDU (STRICTEMENT EN JSON) :
                {
                  "tip": "TON CONSEIL (EN MAJUSCULES)"
                }
            `.trim();

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: LLM_PROMPT }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "tip": { "type": "STRING" }
                            },
                            required: ["tip"]
                        }
                    }
                };
                const apiKey = userProfile.apiKey || "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur HTTP lors de la génération du conseil: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const rawResult = await response.text();
                const parsedContent = JSON.parse(JSON.parse(rawResult).candidates[0].content.parts[0].text);
                showMessage(parsedContent.tip, 'tip');

            } catch (error) {
                console.error("Erreur lors de la génération du conseil de difficulté:", error);
                showMessage(`CONSEIL IA INDISPONIBLE: ${error.message}`, 'warning');
            }
        }


        function showLogWorkoutModal(currentExercise) {
            let modalHtml = `
                <div id="log-workout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 font-vt323">
                    <div class="bg-gray-800 p-6 rounded-lg border-4 border-purple-500 shadow-xl w-full max-w-md text-white">
                        <h3 class="text-2xl sm:text-3xl font-bold text-yellow-300 mb-4 text-center">ENREGISTRER L'ENTRAÎNEMENT</h3>
                        <p class="text-lg sm:text-xl mb-4 text-center">${String(currentExercise?.name).toUpperCase()}</p>
                        <div class="space-y-4">
                            <div><label for="logSets" class="block text-gray-200 text-sm font-bold mb-2">SÉRIES / ROUNDS :</label><input type="text" id="logSets" class="input-retro" placeholder="EX: 3 ou 5 ROUNDS" /></div>
                            <div><label for="logReps" class="block text-gray-200 text-sm font-bold mb-2">RÉPÉTITIONS / DURÉE :</label><input type="text" id="logReps" class="input-retro" placeholder="EX: 12 ou 30 MIN" /></div>
                            <div><label for="logWeight" class="block text-gray-200 text-sm font-bold mb-2">POIDS (KG, LAISSER VIDE SI NON APPLICABLE) :</label><input type="number" id="logWeight" class="input-retro" placeholder="EX: 50" /></div>
                            <div><label for="logFeeling" class="block text-gray-200 text-sm font-bold mb-2">RESSENTI :</label>
                                <select id="logFeeling" class="select-retro">
                                    <option value="Facile">FACILE</option><option value="Moyen">MOYEN</option><option value="Difficile">DIFFICILE</option>
                                </select>
                            </div>
                            <div><label for="logNotes" class="block text-gray-200 text-sm font-bold mb-2">NOTES (OPTIONNEL) :</label><textarea id="logNotes" class="input-retro h-24" placeholder="EX: SENTI TRÈS FORT SUR CETTE SÉANCE..."></textarea></div>
                        </div>
                        <div class="flex justify-between mt-6 space-x-4">
                            <button id="cancel-log-btn" class="btn-retro-red w-1/2">ANNULER</button>
                            <button id="save-log-btn" class="btn-retro-green w-1/2">ENREGISTRER</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('global-modals-container').innerHTML = modalHtml;

            document.getElementById('cancel-log-btn').onclick = () => document.getElementById('log-workout-modal').remove();
            document.getElementById('save-log-btn').onclick = async () => {
                const sets = document.getElementById('logSets').value;
                const reps = document.getElementById('logReps').value;
                const weight = document.getElementById('logWeight').value;
                const feeling = document.getElementById('logFeeling').value;
                const notes = document.getElementById('logNotes').value;

                if (!sets || !reps) { showMessage("ERREUR: VEUILLEZ REMPLIR LES SÉRIES ET LES RÉPÉTITIONS.", 'error'); return; }

                const loggedWeight = parseFloat(weight) || 0;
                const loggedSets = String(sets).trim();
                const loggedReps = String(reps).trim();

                const logDate = new Date();
                const currentPhase = document.getElementById('phaseSelect').value;
                const workoutPhaseName = workoutProgram[currentPhase]?.name || 'PHASE INCONNUE'; // Gérer le cas où la phase n'existe plus

                workoutLogs.push({
                    id: generateUniqueId(), date: logDate.toISOString(), exerciseName: currentExercise.name,
                    phase: workoutPhaseName, sets: loggedSets, reps: loggedReps, weight: loggedWeight,
                    workoutType: currentExercise.type, notes: notes, feeling: feeling, timestamp: new Date().toISOString()
                });
                saveToLocalStorage('workoutLogs', workoutLogs);
                showMessage("SUCCÈS: ENTRAÎNEMENT ENREGISTRÉ !", 'success');

                let xpGained = 5;
                const numericSets = parseFloat(loggedSets) || 0;
                if (numericSets > 0) xpGained += Math.min(10, Math.round(numericSets * 2));

                if (currentExercise.type && (currentExercise.type === 'hiit' || currentExercise.type.startsWith('hiit_') || currentExercise.type === 'cardio')) {
                    const numericRepsMatch = loggedReps.match(/(\d+(\.\d+)?)/);
                    if (numericRepsMatch) xpGained += Math.min(20, Math.round(parseFloat(numericRepsMatch[0]) / 2));
                } else {
                    const numericReps = parseFloat(loggedReps);
                    if (!isNaN(numericReps) && numericReps > 0) xpGained += Math.min(20, Math.round((numericSets * numericReps) / 10));
                }

                if (!isNaN(loggedWeight) && loggedWeight > 0) xpGained += 20;

                if (currentExercise.type && ['chest', 'back', 'shoulders', 'legs', 'arms', 'triceps', 'biceps', 'glutes'].includes(currentExercise.type) && !isNaN(loggedWeight) && loggedWeight > 0) {
                    const maxHistoricalWeight = workoutLogs.filter(log => log.exerciseName === currentExercise.name).map(log => parseFloat(String(log.weight || 0))).filter(w => w > 0).reduce((max, log) => Math.max(max, log), 0);
                    if (loggedWeight >= maxHistoricalWeight) {
                        playTrophySound();
                        showMessage(`NOUVEAU RECORD PERSONNEL DE POIDS POUR "${String(currentExercise.name).toUpperCase()}" (${loggedWeight}KG)! FÉLICITATIONS!`, 'success');
                    }
                }

                userProfile.currentXP = (userProfile.currentXP || 0) + xpGained;
                saveToLocalStorage('userProfile', userProfile);
                updateXPBar();

                // Generate and show difficulty tip
                if (userProfile.apiKey) { // Only try to generate tip if API key is available
                    generateAndShowDifficultyTip(feeling, currentExercise.name);
                } else {
                    showMessage("CONSEIL DE DIFFICULTÉ NON GÉNÉRÉ: CLÉ API MANQUANTE.", 'info');
                }


                document.getElementById('log-workout-modal').remove();
            };
        }


        // --- Vue des Recettes ---
        async function generateInternalMeal(mealType, dayContext, otherMealsToday = [], currentMealToReplace = null, allowMeatFish, userProfileData, numberOfPeople = 1) {
            const finalNumberOfPeople = (mealType === 'petit_dejeuner' || mealType.startsWith('collation')) ? 1 : numberOfPeople;

            const userProfileForPrompt = {
                imc: userProfileData.imc, imcCategory: userProfileData.imcCategory,
                proteinNeeds: userProfileData.proteinNeeds, weight: userProfileData.weight
            };

            const mealSpecificConstraints = [];
            let imcAdaptation = "";
            if (userProfileForPrompt.imcCategory.includes('INSUFFISANCE PONDÉRALE')) {
                imcAdaptation = "Waeky est en insuffisance pondérale. Assure un apport calorique suffisant et des nutriments denses pour favoriser une prise de poids saine.";
            } else if (userProfileForPrompt.imcCategory.includes('SURPOIDS') || userProfileForPrompt.imcCategory.includes('OBÉSITÉ')) {
                imcAdaptation = `Waeky est en catégorie d'IMC "${userProfileForPrompt.imcCategory}". Privilégie des recettes moins caloriques, plus riches en fibres et en protéines maigres pour favoriser la perte de poids et la satiété. Réduis les portions de glucides et lipides si nécessaire.`;
            } else {
                imcAdaptation = "Waeky a un poids normal. Maintiens un équilibre macro-nutritionnel pour soutenir son niveau d'activité sans excès.";
            }
            mealSpecificConstraints.push(imcAdaptation);

            let mealContextDescription = "";
            if (mealType === 'petit_dejeuner') {
                mealContextDescription = "Petit-déjeuner";
                mealSpecificConstraints.push("Doit être à tendance sucrée, évitant les saveurs salées.");
                mealSpecificConstraints.push("Les œufs peuvent être utilisés UNIQUEMENT s'ils sont intégrés dans des préparations comme des galettes, crêpes ou porridges, PAS en tant que plat principal (ex: œufs brouillés, omelette).");
                mealSpecificConstraints.push("PAS DE PÂTES, DE SEMOULE, NI DE SAUCE TOMATE.");
                mealSpecificConstraints.push("Privilégiez les fruits, flocons d'avoine, yaourt grec, ou whey protéine pour les bases.");
            } else if (mealType === 'dejeuner') {
                mealContextDescription = "Déjeuner";
                mealSpecificConstraints.push("Doit être un repas équilibré pour soutenir l'énergie pendant la journée.");
            } else if (mealType === 'diner') {
                mealContextDescription = "Dîner";
                mealSpecificConstraints.push("Doit être un repas digeste favorisant un bon sommeil.");
            } else if (mealType.startsWith('collation')) {
                mealContextDescription = "Collation";
                mealSpecificConstraints.push("Doit être rapide, facile à transporter et énergétique.");
            }

            if (!allowMeatFish) {
                mealSpecificConstraints.push("Utilise une source de protéines végétarienne (lentilles, tofu, pois chiches, œufs - si applicable au repas, produits laitiers) ou laitière. Ne propose PAS de viande ou de poisson.");
            } else {
                mealSpecificConstraints.push("Tu peux utiliser n'importe quelle source de protéines. Pour des raisons de budget, privilégie des options économiques comme les légumineuses, les œufs (if applicable au repas), ou les produits laitiers, en alternance avec la viande/poisson.");
            }

            const sportImpact = dayContext.sport !== 'aucun'
                ? `Waeky a une séance de sport de type '${dayContext.sport}' prévue. Les glucides complexes et les protéines sont importants pour l'énergie et la récupération.`
                : `Waeky n'a pas de sport prévu ce jour. Les repas doivent rester équilibrés.`;

            const posteImpact = `Waeky est en poste de type '${dayContext.poste}'. Pense à adapter la digestion et l'énergie en fonction de cet horaire.`;


            const LLM_PROMPT = `
            Tu es un nutritionniste et chef culinaire expert, travaillant pour 'FitQuest'.
            Ta mission est de créer une recette détaillée et adaptée pour Waeky, un agent de sécurité avec un emploi du temps exigeant.

            CONTEXTE DE WAEKY :
            - IMC: ${userProfileForPrompt.imc} (Catégorie: ${userProfileForPrompt.imcCategory})
            - Poids: ${userProfileForPrompt.weight} kg
            - Besoin en protéines estimé: ${userProfileForPrompt.proteinNeeds} g/jour
            - Ce repas est pour ${finalNumberOfPeople} personne(s).

            PLANNING DU JOUR :
            - Poste: ${dayContext.poste}
            - Sport: ${dayContext.sport} (${sportImpact})
            - ${posteImpact}

            TYPE DE REPAS À CRÉER : ${mealContextDescription.toUpperCase()}

            CONTRAINTES SPÉCIFIQUES :
            ${mealSpecificConstraints.map(c => `- ${c}`).join('\n')}
            - Les ingrédients doivent inclure les quantités précises et EXPLICITEMENT ADAPTÉES pour ${finalNumberOfPeople} personne(s). Chaque ingrédient doit avoir une quantité et une unité claires et réalistes.
            - Les étapes de préparation doivent être TRÈS DÉTAILLÉES, numérotées, et facilement reproductibles par un débutant complet en cuisine. Chaque étape doit être claire, concise et fournir suffisamment de détails pour l'exécution.
            - La portion de Waeky doit être spécifiquement adaptée à son IMC (${userProfileForPrompt.imcCategory}) et ses besoins en protéines (${userProfileForPrompt.proteinNeeds} g/jour), pour 1 personne.

            FORMAT DE RÉPONSE ATTENDU (STRICTEMENT EN JSON) :
            {
              "title": "TITRE DE LA RECETTE (EN MAJUSCULES)",
              "description_du_plat": "DESCRIPTION DU PLAT ADAPTÉE AU CONTEXTE (EN MAJUSCULES)",
              "ingredients_label": "INGRÉDIENTS (POUR X PERS)",
              "ingredients_list": ["QUANTITÉ UNITÉ INGRÉDIENT", "QUANTITÉ UNITÉ INGRÉDIENT", ...],
              "preparation_steps": ["ÉTAPE 1. DESCRIPTION DÉTAILLÉE.", "ÉTAPE 2. DESCRIPTION DÉTAILLÉE.", ...],
              "ma_portion_waeky": "TA PORTION (POUR WAEKY) : QUANTITÉ PROTÉINE, QUANTITÉ GLUCIDE, ET UNE GRANDE PORTION DE LÉGUMES/FRUITS VARIES, POUR 1 PERSONNE.",
              "conseils_reutilisation_economie": "CONSEILS POUR FAIRE DES RESTES OU ÉCONOMISER (EN MAJUSCULES).",
              "notes": "NOTES SUPPLÉMENTAIRES (ALLERGÈNES, ASTUCES, ETC.) (EN MAJUSCULES)."
            }

            GÉNÈRE LA RECETTE DÉTAILLÉE :
            `.trim();

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: LLM_PROMPT }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" }, "description_du_plat": { "type": "STRING" },
                                "ingredients_label": { "type": "STRING" }, "ingredients_list": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "preparation_steps": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "ma_portion_waeky": { "type": "STRING" }, "conseils_reutilisation_economie": { "type": "STRING" },
                                "notes": { "type": "STRING" }
                            },
                            required: ["title", "description_du_plat", "ingredients_label", "ingredients_list", "preparation_steps", "ma_portion_waeky", "conseils_reutilisation_economie", "notes"]
                        }
                    }
                };
                const apiKey = userProfile.apiKey || "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `Erreur HTTP: ${response.status} ${response.statusText}`;
                    if (response.status === 401 || response.status === 403) errorMessage += " - PROBLÈME D'AUTHENTIFICATION API. VÉRIFIEZ L'ACCÈS À L'API GEMINI. (CODE 401/403)";
                    else if (errorText) errorMessage += ` - ${errorText}`;
                    throw new Error(errorMessage);
                }

                const rawResult = await response.text();
                let parsedContent = null;
                try {
                    const result = JSON.parse(rawResult);
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        parsedContent = JSON.parse(result.candidates[0].content.parts[0].text);
                    } else {
                        throw new Error("Réponse de l'IA mal formée ou vide.");
                    }
                } catch (parseError) {
                    console.error("Erreur d'analyse du JSON de la réponse LLM ou de la structure des candidats:", parseError);
                    console.error("JSON brut causant l'erreur:", rawResult);
                    const fallbackTitle = `${mealContextDescription.toUpperCase()} SIMPLIFIÉ (ERREUR IA)`;
                    const fallbackDesc = `UNE ERREUR EST SURVENUE LORS DE LA GÉNÉRATION. VOICI UNE RECETTE BASIQUE.`;
                    const fallbackIngredients = [`QUANTITÉS À DÉFINIR SELON TON APPÉTIT`, `PROTÉINES VARIÉES`, `GLUCIDES COMPLÈXES`, `LÉGUMES DE SAISON`];
                    const fallbackPreparation = ["1. PRÉPARE LES INGRÉDIENTS. 2. CUISINE SELON TES MÉTHODES HABITUELLES."];
                    const fallbackPortion = "TA PORTION (POUR WAEKY) : PROTÉINES, GLUCIDES, ET LÉGUMES ADAPTÉS. POUR 1 PERSONNE.";
                    const fallbackConseils = "AJUSTE LES QUANTITÉS SELON TES BESOINS. ESSAIE DE RÉUTILISER LES RESTES.";
                    const fallbackNotes = "LA RECETTE A ÉTÉ SIMPLIFIÉE EN RAISON D'UN PROBLÈME DE COMMUNICATION AVEC L'IA. VÉRIFIEZ LE PROMPT OU L'API.";
                    parsedContent = { title: fallbackTitle, description_du_plat: fallbackDesc, ingredients_label: `INGRÉDIENTS (POUR ${finalNumberOfPeople} PERS)`, ingredients_list: fallbackIngredients, preparation_steps: fallbackPreparation, ma_portion_waeky: fallbackPortion, conseils_reutilisation_economie: fallbackConseils, notes: fallbackNotes };
                }

                return {
                    id: generateUniqueId(),
                    title: String(parsedContent.title || '').toUpperCase(),
                    description_du_plat: String(parsedContent.description_du_plat || '').toUpperCase(),
                    ingredients_label: String(parsedContent.ingredients_label || `INGRÉDIENTS (POUR ${finalNumberOfPeople} PERS)`).toUpperCase(), // Ensure label is present and scaled
                    ingredients_list: (parsedContent.ingredients_list || []).map(item => String(item).toUpperCase()),
                    preparation_steps: (parsedContent.preparation_steps || []).map(step => String(step).toUpperCase()),
                    ma_portion_waeky: String(parsedContent.ma_portion_waeky || '').toUpperCase(),
                    conseils_reutilisation_economie: String(parsedContent.conseils_reutilisation_economie || '').toUpperCase(),
                    notes: String(parsedContent.notes || '').toUpperCase(),
                };

            } catch (error) {
                console.error("Erreur fatale lors de l'appel LLM ou de l'analyse JSON générale:", error);
                const fallbackTitle = `${mealContextDescription.toUpperCase()} (ERREUR SYSTÈME)`;
                const fallbackDesc = `UNE ERREURE CRITIQUE EST SURVENUE. VEUILLEZ RÉESSAYER.`;
                const fallbackIngredients = [`VÉRIFIEZ VOTRE CONNEXION INTERNET`, `CONTACTEZ LE SUPPORT SI LE PROBLÈME PERSISTE`];
                const fallbackPreparation = ["1. ESSAYEZ DE RE-GÉNÉRER LE PLAN.", "2. ASSUREZ-VOUS QUE VOTRE PROFIL EST COMPLET."];
                const fallbackPortion = "INDISPONIBLE EN RAISON D'UNE ERREUR.";
                const fallbackConseils = "PAS DE CONSEILS DISPONIBLES.";
                const fallbackNotes = "ERREUR DE COMMUNICATION MAJEURE AVEC L'IA. VEUILLEZ VÉRIFIER VOTRE CONNEXION.";

                return {
                    id: generateUniqueId(), title: fallbackTitle, description_du_plat: fallbackDesc,
                    ingredients_label: `INGRÉDIENTS (POUR ${finalNumberOfPeople} PERS)`, ingredients_list: fallbackIngredients,
                    preparation_steps: fallbackPreparation, ma_portion_waeky: fallbackPortion,
                    conseils_reutilisation_economie: fallbackConseils, notes: fallbackNotes
                };
            }
        }


        function renderRecipeView(container) {
            let numPeople = loadFromLocalStorage('recipeNumPeople', 1);
            let allowMeatFish = loadFromLocalStorage('recipeAllowMeatFish', true);
            let regeneratingMeal = null;

            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">PLAN DE REPAS</h2>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">GÉNÉRER MON PLAN DE REPAS :</h3>
                        <div class="mb-4"><label for="numPeople" class="block text-gray-200 text-sm font-bold mb-2">POUR COMBIEN DE PERSONNES ?</label><input type="number" id="numPeople" value="${numPeople}" min="1" class="input-retro" /></div>
                        <div class="mb-4 flex items-center">
                            <input type="checkbox" id="allowMeatFish" ${allowMeatFish ? 'checked' : ''} class="mr-2 h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" />
                            <label for="allowMeatFish" class="text-gray-200 text-sm font-bold">AUTORISER VIANDE ET POISSON (PLUS ÉCONOMIQUE SANS)</label>
                        </div>
                        <button id="generate-plan-btn" class="btn-retro-purple w-full flex items-center justify-center">
                            <span id="generate-plan-spinner" class="spinner mr-2 hidden"></span>
                            <span id="generate-plan-text">GÉNÉRER PLAN DE REPAS</span>
                        </button>
                        <p class="text-xs text-gray-400 mt-2 text-center">LE PLAN SERA GÉNÉRÉ UNIQUEMENT POUR LES JOURS AVEC DES POSTES ENREGISTRÉS DANS L'ONGLET "PLANNING".</p>
                    </div>
                    <div id="weekly-meal-plan-content"></div>
                </div>`;
            container.innerHTML = html;

            const numPeopleInput = document.getElementById('numPeople');
            const allowMeatFishCheckbox = document.getElementById('allowMeatFish');
            const generatePlanBtn = document.getElementById('generate-plan-btn');
            const generatePlanSpinner = document.getElementById('generate-plan-spinner');
            const generatePlanText = document.getElementById('generate-plan-text');
            const weeklyMealPlanContentDiv = document.getElementById('weekly-meal-plan-content');

            numPeople = loadFromLocalStorage('recipeNumPeople', 1);
            allowMeatFish = loadFromLocalStorage('recipeAllowMeatFish', true);
            numPeopleInput.value = numPeople;
            allowMeatFishCheckbox.checked = allowMeatFish;

            numPeopleInput.onchange = (e) => { numPeople = Math.max(1, parseInt(e.target.value) || 1); saveToLocalStorage('recipeNumPeople', numPeople); };
            allowMeatFishCheckbox.onchange = (e) => { allowMeatFish = e.target.checked; saveToLocalStorage('recipeAllowMeatFish', allowMeatFish); };

            generatePlanBtn.onclick = async () => {
                generatePlanBtn.disabled = true; generatePlanSpinner.classList.remove('hidden'); generatePlanText.textContent = 'GÉNÉRATION...';
                showMessage("GÉNÉRATION DU PLAN DE REPAS EN COURS... CELA PEUT PRENDRE QUELQUES INSTANTS.", 'info');

                try {
                    if (!userProfile.height || !userProfile.weight) { showMessage("ERREUR: VEUILLEZ REMPLIR VOTRE TAILLE ET VOTRE POIDS DANS LE PROFIL POUR GÉNÉRER DES RECETTES PRÉCISES.", 'error'); return; }

                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    const fetchedShifts = (loadFromLocalStorage('shifts', []) || []).filter(s => new Date(s.date).getTime() >= today.getTime());

                    if (fetchedShifts.length === 0) { showMessage("AUCUN POSTE ENREGISTRÉ POUR LES JOURS À VENIR. VEUILLEZ AJOUTER DES POSTES DANS L'ONGLET 'PLANNING' POUR GÉNÉRER UN PLAN DE REPAS.", 'warning'); return; }

                    const newMealPlan = { semaine: [] };
                    const userProfileData = { height: parseFloat(userProfile.height), weight: parseFloat(userProfile.weight), imc: userProfile.imc, imcCategory: userProfile.imcCategory, proteinNeeds: userProfile.proteinNeeds };

                    for (const shift of fetchedShifts) {
                        const day = new Date(shift.date); const dateKey = formatDateToYYYYMMDD(day);
                        const dayContext = { poste: shift.type, sport: shift.workoutType };
                        const mealsForDay = {};
                        const mealOrder = ['petit_dejeuner', 'collation_matin', 'dejeuner', 'collation_apresmidi', 'diner', 'collation_unique'];

                        for (const mealType of mealOrder) {
                            let addMeal = true;
                            // Logic for collations based on shift type and sport
                            if (mealType === 'collation_matin') {
                                if (dayContext.poste === '18h-6h' || (dayContext.poste === 'repos' && dayContext.sport === 'aucun')) {
                                    addMeal = false;
                                }
                            } else if (mealType === 'collation_apresmidi') {
                                if (dayContext.poste === '18h-6h' || (dayContext.poste === 'repos' && dayContext.sport === 'aucun')) {
                                    addMeal = false;
                                }
                            } else if (mealType === 'collation_unique') {
                                // Collation unique is primarily for night shifts.
                                // It should NOT be generated if morning/afternoon collations are generated.
                                if (dayContext.poste === '18h-6h') {
                                    addMeal = true;
                                } else {
                                    addMeal = false;
                                }
                            }

                            if (!addMeal) continue; // Skip generating this meal type

                            const generatedMeal = await generateInternalMeal(mealType, dayContext, Object.values(mealsForDay), null, allowMeatFish, userProfileData, numPeople);
                            mealsForDay[mealType] = generatedMeal;
                        }
                        newMealPlan.semaine.push({ date: dateKey, dayContext: dayContext, ...mealsForDay });
                    }

                    newMealPlan.semaine.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                    weeklyMealPlan = newMealPlan;
                    saveToLocalStorage('weeklyMealPlan', weeklyMealPlan);
                    showMessage("SUCCÈS: PLAN DE REPAS GÉNÉRÉ ET ENREGISTRÉ !", 'success');
                    speak("Plan de repas généré !");
                    renderRecipeView(container);

                } catch (error) {
                    console.error("Erreur lors de la génération du plan de repas:", error);
                    showMessage(`ERREUR: Échec de la génération du plan. ${error.message}`, 'error');
                } finally {
                    generatePlanBtn.disabled = false; generatePlanSpinner.classList.add('hidden'); generatePlanText.textContent = 'GÉNÉRER PLAN DE REPAS';
                }
            };

            function renderWeeklyMealPlan() {
                if (!weeklyMealPlan || !weeklyMealPlan.semaine || weeklyMealPlan.semaine.length === 0) {
                    weeklyMealPlanContentDiv.innerHTML = `<p class="text-gray-400 text-center">AUCUN PLAN DE REPAS GÉNÉRÉ. CLIQUEZ SUR "GÉNÉRER PLAN DE REPAS" CI-DESSUS.</p>`;
                    return;
                }

                let mealsHtml = `<div class="space-y-6"><h3 class="text-xl sm:text-2xl text-yellow-300 mb-3 text-center">TON PLAN DE REPAS :</h3>`;

                weeklyMealPlan.semaine.forEach((dayData) => {
                    mealsHtml += `
                        <div class="bg-gray-700 p-4 rounded-lg border-4 border-purple-500 shadow-lg">
                            <h4 class="text-lg sm:text-xl font-bold text-yellow-300 mb-3">${new Date(dayData.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase()} - ${getDayContextString(dayData.dayContext.poste, dayData.dayContext.sport)}</h4>
                            <div class="space-y-4">`;
                    const mealOrder = ['petit_dejeuner', 'collation_matin', 'dejeuner', 'collation_apresmidi', 'diner', 'collation_unique'];
                    mealOrder.forEach(mealType => {
                        const meal = dayData[mealType];
                        if (meal) {
                            const momentContext = getMealMomentContext(mealType, dayData.dayContext.poste, dayData.dayContext.sport);
                            const adviceKey = mealType.includes('collation')
                                ? `${mealType.replace('_unique', '')}_${dayData.dayContext.poste === '18h-6h' ? 'pendant' : (dayData.dayContext.sport !== 'aucun' ? 'post' : 'default')}`
                                : dayData.dayContext.poste === '18h-6h' ? '18h-6h' : (dayData.dayContext.sport !== 'aucun' ? 'repos_sport' : 'default');
                            const advice = specificMealAdvice[mealType]?.[adviceKey] || specificMealAdvice[mealType]?.default || "CONSEIL GÉNÉRAL : MANGEZ ÉQUILIBRÉ.";

                            const isRegeneratingCurrentMeal = regeneratingMeal && regeneratingMeal.dateKey === dayData.date && regeneratingMeal.mealType === mealType;

                            mealsHtml += `
                                <div class="bg-gray-800 p-3 rounded-md border-2 border-blue-700 shadow-md">
                                    <div class="flex justify-between items-center mb-2">
                                        <h5 class="font-semibold text-base sm:text-lg text-blue-400">${momentContext} : ${String(meal.title || 'RECETTE NON DÉFINIE').toUpperCase()}</h5>
                                        <button class="btn-retro-red text-sm px-2 py-1 ml-2 flex items-center justify-center regenerate-meal-btn" data-date="${dayData.date}" data-meal-type="${mealType}" ${isRegeneratingCurrentMeal ? 'disabled' : ''}>
                                            ${isRegeneratingCurrentMeal ? `<span class="spinner w-4 h-4"></span>` : `<i data-lucide="rotate-ccw" style="width:16px; height:16px;"></i>`}
                                            <span class="ml-1 hidden sm:inline">RÉGÉNÉRER</span>
                                        </button>
                                    </div>
                                    <p class="text-gray-300 text-sm italic mb-2">${String(meal.description_du_plat || 'DESCRIPTION INDISPONIBLE').toUpperCase()}</p>
                                    <p class="text-sm font-medium text-yellow-300">${String(meal.ingredients_label || 'INGRÉDIENTS').toUpperCase()} :</p>
                                    <ul class="list-disc list-inside text-gray-300 text-xs pl-2 space-y-1">${(meal.ingredients_list || []).map(ingredient => `<li>${String(ingredient).toUpperCase()}</li>`).join('')}</ul>
                                    <p class="text-sm font-medium text-yellow-300 mt-2">PRÉPARATION :</p>
                                    <ol class="list-decimal list-inside text-gray-300 text-xs pl-2 space-y-1">${(meal.preparation_steps || []).map(step => `<li>${String(step).toUpperCase()}</li>`).join('')}</ol>
                                    <p class="text-sm font-medium text-yellow-300 mt-2">PORTION WAEKY :</p>
                                    <p class="text-gray-300 text-xs">${String(meal.ma_portion_waeky || 'PORTION INDISPONIBLE').toUpperCase()}</p>
                                    <p class="text-sm font-medium text-yellow-300 mt-2">CONSEILS ÉCONOMIE :</p>
                                    <p class="text-gray-300 text-xs">${String(meal.conseils_reutilisation_economie || 'CONSEILS INDISPONIBLES').toUpperCase()}</p>
                                    <p class="text-blue-200 text-xs mt-3">${advice}</p>
                                </div>`;
                        }
                    });
                    mealsHtml += `</div></div>`;
                });
                mealsHtml += `</div>`;
                weeklyMealPlanContentDiv.innerHTML = mealsHtml;
                renderLucideIcons();

                weeklyMealPlanContentDiv.querySelectorAll('.regenerate-meal-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const dateKey = event.currentTarget.dataset.date;
                        const mealType = event.currentTarget.dataset.mealType;
                        const dayContext = shifts.find(s => formatDateToYYYYMMDD(new Date(s.date)) === dateKey);

                        if (!dayContext) { showMessage("ERREUR: Contexte de jour non trouvé pour la régénération du repas.", 'error'); return; }

                        regeneratingMeal = { dateKey, mealType };
                        renderRecipeView(container);

                        try {
                            const userProfileData = { height: parseFloat(userProfile.height), weight: parseFloat(userProfile.weight), imc: userProfile.imc, imcCategory: userProfile.imcCategory, proteinNeeds: userProfile.proteinNeeds };
                            const regeneratedMeal = await generateInternalMeal(mealType, dayContext, [], null, allowMeatFish, userProfileData, numPeople);

                            const dayIndex = weeklyMealPlan.semaine.findIndex(d => d.date === dateKey);
                            if (dayIndex !== -1) {
                                weeklyMealPlan.semaine[dayIndex][mealType] = regeneratedMeal;
                                saveToLocalStorage('weeklyMealPlan', weeklyMealPlan);
                                showMessage(`SUCCÈS: Repas "${regeneratedMeal.title}" régénéré pour le ${dateKey} !`, 'success');
                                speak("Repas régénéré !");
                                regeneratingMeal = null;
                                renderRecipeView(container);
                            }
                        } catch (error) {
                            console.error("Erreur lors de la régénération du repas:", error);
                            showMessage(`ERREUR: Échec de la régénération du repas. ${error.message}`, 'error');
                            regeneratingMeal = null;
                            renderRecipeView(container);
                        }
                    };
                });
            }

            renderWeeklyMealPlan();
        }


        // --- Vue du Chronomètre d'Intervalles ---
        function renderChronoIntervalleView(container) {
            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">CHRONOMÈTRE D'INTERVALLES</h2>
                    <div class="text-center mb-6 p-4 rounded-lg border-2 border-blue-700 bg-gray-700">
                        <p class="text-2xl sm:text-3xl text-yellow-300 mb-2">INTERVALLE ACTUEL :</p>
                        <p id="chrono-instruction" class="text-3xl sm:text-4xl font-bold text-white mb-4"></p>
                        <div id="chrono-display" class="text-6xl sm:text-7xl font-bold text-purple-400 bg-[#131313] p-4 rounded-lg border-4 border-purple-600 inline-block shadow-inner-lg">00:00</div>
                        <div class="flex justify-center gap-4 mt-6 flex-wrap">
                            <button id="start-chrono-btn" class="btn-retro-green px-6 py-3">DÉMARRER</button>
                            <button id="pause-chrono-btn" class="btn-retro-purple px-6 py-3">PAUSE</button>
                            <button id="reset-chrono-btn" class="btn-retro-red px-6 py-3">RÉINITIALISER</button>
                        </div>
                    </div>
                    <div class="mb-6 space-y-4 p-4 rounded-lg border-2 border-blue-700 bg-gray-700">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">GESTION DES INTERVALLES :</h3>
                        <div class="flex flex-col sm:flex-row gap-3 items-end">
                            <div class="flex-1 w-full"><label for="newDurationMinutes" class="block text-gray-200 text-sm font-bold mb-1">DURÉE (MINUTES) :</label><input type="number" id="newDurationMinutes" value="" class="input-retro" placeholder="EX: 1" /></div>
                            <div class="flex-1 w-full"><label for="newInstruction" class="block text-gray-200 text-sm font-bold mb-1">INSTRUCTION :</label><input type="text" id="newInstruction" value="" class="input-retro" placeholder="EX: VITESSE 8, PENTE 2" /></div>
                            <button id="add-interval-btn" class="btn-retro w-full sm:w-auto px-5 py-2">AJOUTER</button>
                        </div>
                        <div class="mt-4 p-3 rounded-lg border-2 border-purple-500 bg-gray-800">
                            <h4 class="text-lg sm:text-xl font-bold text-yellow-300 mb-2">OPTIONS DE DÉPART :</h4>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="enablePreCountdown" ${enableChronoPreCountdown ? 'checked' : ''} class="mr-2 h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" />
                                <label for="enablePreCountdown" class="text-gray-200 text-sm font-bold">ACTIVER COMPTE À REBOURS DE PRÉ-DÉPART</label>
                            </div>
                            <div id="pre-countdown-duration-setting" ${!enableChronoPreCountdown ? 'class="hidden"' : ''}>
                                <label for="chronoPreCountdownDuration" class="block text-gray-200 text-sm font-bold mb-1">DURÉE PRÉ-DÉPART (SECONDES) :</label>
                                <input type="number" id="chronoPreCountdownDuration" value="${chronoPreCountdownDuration}" min="1" class="input-retro w-full sm:w-1/2" />
                            </div>
                        </div>
                        <div id="intervals-list" class="mt-4 p-3 rounded-lg border-2 border-purple-500 bg-gray-800"></div>
                    </div>
                    <div class="mb-6 space-y-4 p-4 rounded-lg border-2 border-blue-700 bg-gray-700">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">SAUVEGARDER ET CHARGER :</h3>
                        <div class="flex flex-col sm:flex-row gap-3 items-end">
                            <div class="flex-1 w-full"><label for="sequenceName" class="block text-gray-200 text-sm font-bold mb-1">NOM DE LA SÉQUENCE :</label><input type="text" id="sequenceName" value="" class="input-retro" placeholder="EX: HIIT DU MATIN" /></div>
                            <button id="save-sequence-btn" class="btn-retro w-full sm:w-auto px-5 py-2">SAUVEGARDER</button>
                            <button id="load-sequence-btn" class="btn-retro-green w-full sm:w-auto px-5 py-2">CHARGER</button>
                        </div>
                    </div>
                </div>`;
            container.innerHTML = html;

            const chronoDisplay = document.getElementById('chrono-display');
            const chronoInstruction = document.getElementById('chrono-instruction');
            const startChronoBtn = document.getElementById('start-chrono-btn');
            const pauseChronoBtn = document.getElementById('pause-chrono-btn');
            const resetChronoBtn = document.getElementById('reset-chrono-btn');
            const newDurationMinutesInput = document.getElementById('newDurationMinutes');
            const newInstructionInput = document.getElementById('newInstruction');
            const addIntervalBtn = document.getElementById('add-interval-btn');
            const intervalsListDiv = document.getElementById('intervals-list');
            const enablePreCountdownCheckbox = document.getElementById('enablePreCountdown');
            const preCountdownDurationSetting = document.getElementById('pre-countdown-duration-setting');
            const chronoPreCountdownDurationInput = document.getElementById('chronoPreCountdownDuration');
            const saveSequenceBtn = document.getElementById('save-sequence-btn');
            const loadSequenceBtn = document.getElementById('load-sequence-btn');

            chronoPreCountdownDurationInput.value = chronoPreCountdownDuration;

            function renderIntervalsList() {
                intervalsListDiv.innerHTML = '';
                if (chronoIntervals.length === 0) { intervalsListDiv.innerHTML = '<p class="text-gray-400">AUCUNE INTERVALLE AJOUTÉE.</p>'; return; }
                let listHtml = `<h4 class="text-lg sm:text-xl font-bold text-yellow-300 mb-2">SÉQUENCE ACTUELLE :</h4><ul class="space-y-2">`;
                chronoIntervals.forEach((interval, index) => {
                    listHtml += `
                        <li class="flex justify-between items-stretch bg-[#131313] p-2 rounded-md border border-gray-700">
                            <span class="text-gray-100 text-base sm:text-lg">${Math.floor(interval.duration / 60)}MIN${interval.duration % 60 > 0 ? ` ${interval.duration % 60}S` : ''} - ${String(interval.instruction).toUpperCase()}</span>
                            <button class="btn-retro-red text-xs px-2 py-1 remove-interval-btn" data-index="${index}">X</button>
                        </li>`;
                });
                listHtml += `</ul>`;
                intervalsListDiv.innerHTML = listHtml;

                intervalsListDiv.querySelectorAll('.remove-interval-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const indexToRemove = parseInt(event.target.dataset.index);
                        if (await showConfirmModal("CONFIRMER LA SUPPRESSION DE L'INTERVALLE ?")) {
                            chronoIntervals.splice(indexToRemove, 1);
                            updateLocalStorageChronoState();
                            showMessage("INTERVALLE SUPPRIMÉE !", 'success');
                            renderIntervalsList();
                        }
                    };
                });
            }

            function updateChronoDisplay() {
                const displayTime = chronoCurrentIntervalIndex === -1 ? `PRÊT: ${String(chronoCurrentTime).padStart(2, '0')}` : `${String(Math.floor(chronoCurrentTime / 60)).padStart(2, '0')}:${String(chronoCurrentTime % 60).padStart(2, '0')}`;
                const currentInstruction = chronoCurrentIntervalIndex === -1 ? "COMPTE À REBOURS PRÉ-DÉPART" : String(chronoIntervals[chronoCurrentIntervalIndex]?.instruction || "FIN DE SÉQUENCE").toUpperCase();

                chronoDisplay.textContent = displayTime;
                chronoInstruction.textContent = currentInstruction;

                startChronoBtn.disabled = isChronoRunning && !isChronoPaused;
                pauseChronoBtn.disabled = !isChronoRunning || isChronoPaused;
                resetChronoBtn.disabled = !isChronoRunning && chronoCurrentIntervalIndex === -1 && chronoCurrentTime === 0;
            }

            function chronoLoop() {
                if (!isChronoRunning || isChronoPaused) { clearInterval(chronoIntervalTimerRef); chronoIntervalTimerRef = null; return; }

                chronoCurrentTime--;

                if (chronoCurrentIntervalIndex === -1) {
                    if (chronoCurrentTime <= 0) {
                        chronoCurrentIntervalIndex = 0;
                        chronoCurrentTime = chronoIntervals[0].duration;
                        speak(String(chronoIntervals[0].instruction).toUpperCase()); // Appelle speak() pour Kodular
                        showMessage(String(chronoIntervals[0].instruction).toUpperCase(), 'chrono');
                    } else if (chronoCurrentTime <= 3 && chronoCurrentTime > 0) {
                        playMarioKartStartSound(); // Changed to Mario Kart sound
                    }
                } else {
                    if (chronoCurrentTime <= 0) {
                        const nextIndex = chronoCurrentIntervalIndex + 1;
                        if (nextIndex < chronoIntervals.length) {
                            chronoCurrentIntervalIndex = nextIndex;
                            chronoCurrentTime = chronoIntervals[nextIndex].duration;
                            speak(String(chronoIntervals[nextIndex].instruction).toUpperCase()); // Appelle speak() pour Kodular
                            showMessage(String(chronoIntervals[nextIndex].instruction).toUpperCase(), 'chrono');
                            playBeep(1000, 0.2);
                        } else {
                            isChronoRunning = false; isChronoPaused = false; chronoCurrentIntervalIndex = -1; chronoCurrentTime = 0;
                            speak("SÉQUENCE TERMINÉE!"); showMessage("SÉQUENCE TERMINÉE !", 'success');
                            clearInterval(chronoIntervalTimerRef); chronoIntervalTimerRef = null;
                        }
                    } else if (chronoCurrentTime <= 10 && chronoCurrentTime > 0) {
                        playBeep(880, 0.05);
                    }
                }
                updateLocalStorageChronoState();
                updateChronoDisplay();
            }

            addIntervalBtn.onclick = () => {
                const duration = newDurationMinutesInput.value; const instruction = newInstructionInput.value;
                if (duration === '' || instruction.trim() === '') { showMessage("ERREUR: LA DURÉE ET L'INSTRUCTION SONT REQUISES.", 'error'); return; }
                chronoIntervals.push({ duration: parseInt(duration) * 60, instruction: instruction.trim() });
                newDurationMinutesInput.value = ''; newInstructionInput.value = '';
                updateLocalStorageChronoState(); showMessage("INTERVALLE AJOUTÉE !", 'success'); renderIntervalsList();
            };

            enablePreCountdownCheckbox.onchange = (e) => {
                enableChronoPreCountdown = e.target.checked;
                preCountdownDurationSetting.classList.toggle('hidden', !enableChronoPreCountdown);
                updateLocalStorageChronoState();
            };

            chronoPreCountdownDurationInput.onchange = (e) => {
                chronoPreCountdownDuration = Math.max(1, parseInt(e.target.value) || 1);
                updateLocalStorageChronoState();
            };

            startChronoBtn.onclick = () => {
                if (chronoIntervals.length === 0) { showMessage("ERREUR: AJOUTEZ DES INTERVALLES AVANT DE COMMENCER.", 'error'); return; }
                if (isChronoRunning && !isChronoPaused) return;

                isChronoRunning = true; isChronoPaused = false; chronoCurrentIntervalIndex = -1;

                if (enableChronoPreCountdown) chronoCurrentTime = chronoPreCountdownDuration;
                else { chronoCurrentIntervalIndex = 0; chronoCurrentTime = chronoIntervals[0].duration; speak(String(chronoIntervals[0].instruction).toUpperCase()); showMessage(String(chronoIntervals[0].instruction).toUpperCase(), 'chrono'); }

                updateLocalStorageChronoState(); updateChronoDisplay(); showMessage("CHRONO DÉMARRÉ !", 'chrono');
                if (!chronoIntervalTimerRef) chronoIntervalTimerRef = setInterval(chronoLoop, 1000);
            };

            pauseChronoBtn.onclick = () => {
                isChronoPaused = true; updateLocalStorageChronoState(); updateChronoDisplay();
                showMessage("CHRONO EN PAUSE.", 'info'); clearInterval(chronoIntervalTimerRef); chronoIntervalTimerRef = null;
            };

            resetChronoBtn.onclick = () => {
                isChronoRunning = false; isChronoPaused = false; chronoCurrentIntervalIndex = -1; chronoCurrentTime = 0;
                updateLocalStorageChronoState(); updateChronoDisplay(); showMessage("CHRONO RÉINITIALISÉ.", 'success');
                clearInterval(chronoIntervalTimerRef); chronoIntervalTimerRef = null;
            };

            saveSequenceBtn.onclick = () => {
                const modalDiv = document.createElement('div');
                modalDiv.id = 'save-sequence-modal'; modalDiv.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50';
                modalDiv.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg border-4 border-purple-500 shadow-xl w-full max-w-md text-white">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300">SAUVEGARDER LA SÉQUENCE</h3>
                        <label for="saveSequenceName" class="block text-gray-200 text-sm font-bold mb-2">NOM :</label>
                        <input type="text" id="saveSequenceName" class="input-retro" placeholder="DONNEZ UN NOM À VOTRE SÉQUENCE" value="${document.getElementById('sequenceName').value}" />
                        <div class="flex justify-end space-x-4 mt-6">
                            <button id="cancel-save-sequence-btn" class="btn-retro-red">ANNULER</button>
                            <button id="confirm-save-sequence-btn" class="btn-retro-green">SAUVEGARDER</button>
                        </div>
                    </div>`;
                document.getElementById('global-modals-container').appendChild(modalDiv);

                document.getElementById('cancel-save-sequence-btn').onclick = () => modalDiv.remove();
                document.getElementById('confirm-save-sequence-btn').onclick = () => {
                    const name = document.getElementById('saveSequenceName').value;
                    if (!name.trim()) { showMessage("ERREUR: NOM DE LA SÉQUENCE REQUIS.", 'error'); return; }
                    if (chronoIntervals.length === 0) { showMessage("ERREUR: AJOUTEZ DES INTERVALLES AVANT DE SAUVEGARDER.", 'error'); return; }
                    intervalSequences.push({ id: generateUniqueId(), name: name.trim(), intervals: JSON.stringify(chronoIntervals) });
                    saveToLocalStorage('intervalSequences', intervalSequences);
                    showMessage("SUCCÈS: SÉQUENCE ENREGISTRÉE !", 'success'); modalDiv.remove();
                    document.getElementById('sequenceName').value = '';
                };
            };

            loadSequenceBtn.onclick = () => {
                const modalDiv = document.createElement('div');
                modalDiv.id = 'load-sequence-modal'; modalDiv.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50';
                let sequencesListHtml = intervalSequences.length === 0 ? '<p class="text-gray-400">AUCUNE SÉQUENCE ENREGISTRÉE.</p>' : `
                        <ul class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            ${intervalSequences.map(seq => `
                                <li class="flex justify-between items-center bg-gray-700 p-2 rounded-md border border-gray-600">
                                    <span class="text-gray-100 text-base sm:text-lg">${String(seq.name).toUpperCase()}</span>
                                    <div>
                                        <button class="btn-retro-green text-xs px-2 py-1 mr-2 load-sequence-item-btn" data-id="${seq.id}">CHARGER</button>
                                        <button class="btn-retro-red text-xs px-2 py-1 delete-sequence-item-btn" data-id="${seq.id}">SUPPRIMER</button>
                                    </div>
                                </li>`).join('')}
                        </ul>`;
                modalDiv.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg border-4 border-purple-500 shadow-xl w-full max-w-sm text-white">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4 text-yellow-300">CHARGER LA SÉQUENCE</h3>
                        ${sequencesListHtml}
                        <div class="flex justify-end mt-6"><button id="close-load-sequence-btn" class="btn-retro-red">FERMER</button></div>
                    </div>`;
                document.getElementById('global-modals-container').appendChild(modalDiv);

                modalDiv.querySelectorAll('.load-sequence-item-btn').forEach(button => {
                    button.onclick = (event) => {
                        const idToLoad = event.target.dataset.id;
                        const sequence = intervalSequences.find(s => s.id === idToLoad);
                        if (sequence) {
                            chronoIntervals = JSON.parse(sequence.intervals);
                            updateLocalStorageChronoState();
                            showMessage(`SUCCÈS: SÉQUENCE "${String(sequence.name).toUpperCase()}" CHARGÉE !`, 'success');
                            modalDiv.remove();
                            isChronoRunning = false; isChronoPaused = false; chronoCurrentIntervalIndex = -1; chronoCurrentTime = 0;
                            updateChronoDisplay(); renderIntervalsList();
                        } else { showMessage("ERREUR: SÉQUENCE INTROUVABLE.", 'error'); }
                    };
                });
                modalDiv.querySelectorAll('.delete-sequence-item-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const idToDelete = event.target.dataset.id;
                        if (await showConfirmModal("CONFIRMER LA SUPPRESSION DE LA SÉQUENCE ?")) {
                            intervalSequences = intervalSequences.filter(s => s.id !== idToDelete);
                            saveToLocalStorage('intervalSequences', intervalSequences);
                            showMessage("SUCCÈS: SÉQUENCE SUPPRIMÉE !", 'success');
                            modalDiv.remove(); loadSequenceBtn.click();
                        }
                    };
                });
                document.getElementById('close-load-sequence-btn').onclick = () => modalDiv.remove();
            };

            renderIntervalsList();
            updateChronoDisplay();
            if (isChronoRunning && !isChronoPaused && !chronoIntervalTimerRef) {
                chronoIntervalTimerRef = setInterval(chronoLoop, 1000);
            }
        }


        // --- Vue de Progression ---
        function renderProgressView(container) {
            let selectedExerciseForChart = loadFromLocalStorage('selectedExerciseForChart', 'SÉLECTIONNER UN EXERCICE');
            let selectedExerciseMetrics = loadFromLocalStorage('selectedExerciseMetrics', ['Volume']);
            const hideExerciseHistory = userProfile.hideExerciseHistory;

            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">MA PROGRESSION</h2>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-3">HISTORIQUE DE POIDS :</h3>
                        <div style="width: 100%; max-width: 1000px; margin: 0 auto;"><canvas id="weight-chart"></canvas></div>
                        <p id="weight-chart-message" class="text-gray-400 text-center mt-2 hidden">AUCUN HISTORIQUE DE POIDS ENCORE.</p>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-3">PROGRESSION PAR EXERCICE :</h3>
                        <label for="exerciseSelectChart" class="block text-gray-200 text-sm font-bold mb-2">CHOISIR UN EXERCICE :</label>
                        <select id="exerciseSelectChart" class="select-retro mb-4">
                            <option value="SÉLECTIONNER UN EXERCICE">SÉLECTIONNER UN EXERCICE</option>
                        </select>
                        <div class="mb-4">
                            <h4 class="text-base sm:text-lg font-bold text-gray-200 mb-2">MÉTRIQUES À AFFICHER :</h4>
                            <div id="metric-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2"></div>
                        </div>
                        <div style="width: 100%; max-width: 1000px; margin: 0 auto;"><canvas id="exercise-chart"></canvas></div>
                        <p id="exercise-chart-message" class="text-gray-400 text-center mt-2 hidden">SÉLECTIONNEZ UN EXERCICE ET AU MOINS UNE MÉTRIQUE POUR VOIR LE GRAPHIQUE DE PROGRESSION.</p>
                    </div>
                    <div id="workout-logs-section" class="${hideExerciseHistory ? 'hidden' : ''}">
                        <h3 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-3">HISTORIQUE DES ENTRAÎNEMENTS :</h3>
                        <div id="workout-logs-list" class="space-y-4"></div>
                    </div>
                </div>`;
            container.innerHTML = html;

            const weightChartCanvas = document.getElementById('weight-chart');
            const weightChartMessage = document.getElementById('weight-chart-message');
            const exerciseSelectChart = document.getElementById('exerciseSelectChart'); // Corrected ID
            const metricCheckboxes = document.getElementById('metric-checkboxes');
            const exerciseChartCanvas = document.getElementById('exercise-chart');
            const exerciseChartMessage = document.getElementById('exercise-chart-message');
            const workoutLogsListDiv = document.getElementById('workout-logs-list');
            const workoutLogsSection = document.getElementById('workout-logs-section');

            function renderWeightChart() {
                if (weightChartInstance) weightChartInstance.destroy();
                if (weightHistory.length === 0) { weightChartMessage.classList.remove('hidden'); weightChartCanvas.classList.add('hidden'); return; }
                weightChartMessage.classList.add('hidden'); weightChartCanvas.classList.remove('hidden');

                const labels = weightHistory.map(entry => new Date(entry.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
                const weights = weightHistory.map(entry => entry.weight);
                const imcs = weightHistory.map(entry => entry.imc);

                const ctx = weightChartCanvas.getContext('2d');
                weightChartInstance = new Chart(ctx, {
                    type: 'line', data: { labels: labels, datasets: [{ label: 'POIDS (KG)', data: weights, borderColor: '#FCD34D', backgroundColor: 'rgba(252, 211, 77, 0.2)', borderWidth: 2, fill: false, tension: 0.3, pointBackgroundColor: '#FCD34D', pointBorderColor: '#fff', pointBorderWidth: 1, pointRadius: 5 }, { label: 'IMC', data: imcs, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.2)', borderWidth: 2, fill: false, tension: 0.3, yAxisID: 'y1', pointBackgroundColor: '#8B5CF6', pointBorderColor: '#fff', pointBorderWidth: 1, pointRadius: 5 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                        plugins: { title: { display: true, text: 'HISTORIQUE POIDS ET IMC', color: '#E2E8F0', font: { family: 'VT323', size: 20 } },
                            tooltip: { callbacks: { title: ctx => `DATE: ${ctx[0].label}`, label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y !== null ? ctx.parsed.y + (ctx.dataset.label === 'POIDS (KG)' ? ' KG' : '') : ''}` },
                                titleFont: { family: 'VT323', size: 14 }, bodyFont: { family: 'VT323', size: 12 }, backgroundColor: 'rgba(45, 55, 72, 0.9)', borderColor: '#A78BFA', borderWidth: 1, borderRadius: 6 } },
                        scales: {
                            x: { title: { display: true, text: 'DATE', color: '#E2E8F0', font: { family: 'VT323', size: 16 } }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            y: { title: { display: true, text: 'POIDS (KG)', color: '#E2E8F0', font: { family: 'VT323', size: 16 } }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'IMC', color: '#E2E8F0', font: { family: 'VT323', size: 16 } }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }

            const uniqueExerciseNames = ['SÉLECTIONNER UN EXERCICE', ...new Set(workoutLogs.map(log => log.exerciseName))].sort();
            exerciseSelectChart.innerHTML = uniqueExerciseNames.map(name => `<option value="${name}" ${name === selectedExerciseForChart ? 'selected' : ''}>${name}</option>`).join('');

            const metrics = ['Répétitions/Durée', 'Séries/Rounds', 'Poids', 'Volume'];
            metricCheckboxes.innerHTML = metrics.map(metric => `
                <label class="flex items-center text-gray-300 text-sm sm:text-base">
                    <input type="checkbox" data-metric="${metric}" ${selectedExerciseMetrics.includes(metric) ? 'checked' : ''} class="mr-2 h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" />
                    ${metric.toUpperCase()}
                </label>`).join('');

            exerciseSelectChart.onchange = (e) => { selectedExerciseForChart = e.target.value; saveToLocalStorage('selectedExerciseForChart', selectedExerciseForChart); renderExerciseChart(); };
            metricCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const metric = e.target.dataset.metric;
                    if (e.target.checked) { if (!selectedExerciseMetrics.includes(metric)) selectedExerciseMetrics.push(metric); }
                    else { selectedExerciseMetrics = selectedExerciseMetrics.filter(m => m !== metric); }
                    saveToLocalStorage('selectedExerciseMetrics', selectedExerciseMetrics); renderExerciseChart();
                };
            });

            function renderExerciseChart() {
                if (exerciseChartInstance) exerciseChartInstance.destroy();
                if (!selectedExerciseForChart || selectedExerciseForChart === 'SÉLECTIONNER UN EXERCICE' || selectedExerciseMetrics.length === 0) {
                    exerciseChartMessage.classList.remove('hidden'); exerciseChartCanvas.classList.add('hidden'); return;
                }

                const filteredLogs = workoutLogs.filter(log => log.exerciseName === selectedExerciseForChart).sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                if (filteredLogs.length === 0) {
                    exerciseChartMessage.textContent = `AUCUNE DONNÉE POUR "${selectedExerciseForChart.toUpperCase()}".`;
                    exerciseChartMessage.classList.remove('hidden'); exerciseChartCanvas.classList.add('hidden'); return;
                }

                exerciseChartMessage.classList.add('hidden'); exerciseChartCanvas.classList.remove('hidden');

                const labels = filteredLogs.map(log => new Date(log.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
                const datasets = [];
                const colors = ['#FCD34D', '#A78BFA', '#10B981', '#EF4444'];

                selectedExerciseMetrics.forEach((metric, index) => {
                    let data = []; let label = metric.toUpperCase(); let yAxisID = `y${index}`;

                    if (metric === 'Volume') {
                        data = filteredLogs.map(log => {
                            const sets = parseFloat(String(log.sets)) || 0;
                            let reps = parseFloat(String(log.reps)) || 0;
                            const weight = parseFloat(String(log.weight)) || 0;
                            if (String(log.reps).toUpperCase().includes('MIN')) reps = parseFloat(String(log.reps).match(/(\d+(\.\d+)?)\s*MIN/i)[1]) * 60;
                            else if (String(log.reps).toUpperCase().includes('SEC')) reps = parseFloat(String(log.reps).match(/(\d+(\.\d+)?)\s*SEC/i)[1]);
                            return (sets * reps * (weight > 0 ? weight : 1));
                        });
                        label = 'VOLUME (KG OU UNITÉ TEMPS)';
                    } else if (metric === 'Poids') {
                        data = filteredLogs.map(log => log.weight); label = 'POIDS (KG)';
                    } else if (metric === 'Séries/Rounds') {
                        data = filteredLogs.map(log => parseFloat(String(log.sets)) || 0); label = 'SÉRIES / ROUNDS';
                    } else if (metric === 'Répétitions/Durée') {
                        data = filteredLogs.map(log => {
                            let reps = parseFloat(String(log.reps)) || 0;
                            if (String(log.reps).toUpperCase().includes('MIN')) reps = parseFloat(String(log.reps).match(/(\d+(\.\d+)?)\s*MIN/i)[1]);
                            else if (String(log.reps).toUpperCase().includes('SEC')) reps = parseFloat(String(log.reps).match(/(\d+(\.\d+)?)\s*SEC/i)[1]);
                            return reps;
                        });
                        label = 'RÉPÉTITIONS / DURÉE';
                    }
                    datasets.push({ label: label, data: data, borderColor: colors[index % colors.length], backgroundColor: Chart.helpers.color(colors[index % colors.length]).alpha(0.2).rgbString(), borderWidth: 2, fill: false, tension: 0.3, pointBackgroundColor: colors[index % colors.length], pointBorderColor: '#fff', pointBorderWidth: 1, pointRadius: 5, yAxisID: yAxisID });
                });

                const ctx = exerciseChartCanvas.getContext('2d');
                exerciseChartInstance = new Chart(ctx, {
                    type: 'line', data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                        plugins: { title: { display: true, text: `PROGRESSION POUR ${selectedExerciseForChart.toUpperCase()}`, color: '#E2E8F0', font: { family: 'VT323', size: 20 } },
                            tooltip: { callbacks: { title: ctx => `DATE: ${ctx[0].label}`, label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y !== null ? ctx.parsed.y + (ctx.dataset.label === 'POIDS (KG)' ? ' KG' : (ctx.dataset.label.includes('DURÉE') || (ctx.dataset.label.includes('VOLUME') && !ctx.dataset.label.includes('KG')) ? ' s' : '')) : ''}` },
                                titleFont: { family: 'VT323', size: 14 }, bodyFont: { family: 'VT323', size: 12 }, backgroundColor: 'rgba(45, 55, 72, 0.9)', borderColor: '#A78BFA', borderWidth: 1, borderRadius: 6 } },
                        scales: {
                            x: { title: { display: true, text: 'DATE', color: '#E2E8F0', font: { family: 'VT323', size: 16 } }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            y: { title: { display: true, text: datasets[0]?.label || 'VALEUR', color: '#E2E8F0', font: { family: 'VT323', size: 16 } }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            ...(selectedExerciseMetrics.length > 1 && {
                                y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, title: { display: true, text: datasets[1]?.label || 'VALEUR', color: '#E2E8F0', font: { family: 'VT323', size: 16 } } },
                                y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, title: { display: true, text: datasets[2]?.label || 'VALEUR', color: '#E2E8F0', font: { family: 'VT323', size: 16 } } },
                                y3: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#CBD5E0', font: { family: 'VT323', size: 12 } }, title: { display: true, text: datasets[3]?.label || 'VALEUR', color: '#E2E8F0', font: { family: 'VT323', size: 16 } } }
                            })
                        }
                    }
                });
            }

            renderWeightChart();
            renderExerciseChart();

            if (!hideExerciseHistory) {
                workoutLogsListDiv.innerHTML = '';
                if (workoutLogs.length === 0) { workoutLogsListDiv.innerHTML = '<p class="text-gray-400 text-center">AUCUN ENTRAÎNEMENT ENREGISTRÉ. COMMENCEZ À JOURNALISER VOS SÉANCES !</p>'; }
                else {
                    let logsHtml = `<div class="space-y-4">`;
                    workoutLogs.forEach((log) => {
                        const logDate = new Date(log.date);
                        logsHtml += `
                            <div class="bg-gray-700 p-4 rounded-lg border-2 border-blue-700 shadow-md">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                                    <p class="text-sm sm:text-base text-gray-200 font-bold">${logDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase()}</p>
                                    <button class="btn-retro-red text-xs px-2 py-1 mt-2 sm:mt-0 delete-log-btn" data-id="${log.id}">SUPPRIMER</button>
                                </div>
                                <div class="text-gray-300 text-sm">
                                    <p>EXERCICE : <span class="font-medium">${String(log.exerciseName).toUpperCase()}</span></p>
                                    <p>SÉRIES : <span class="font-medium">${String(log.sets).toUpperCase()}</span></p>
                                    <p>RÉPÉTITIONS : <span class="font-medium">${String(log.reps).toUpperCase()}</span></p>
                                    ${log.weight && log.weight !== '' && parseFloat(log.weight) > 0 ? `<p>POIDS : <span class="font-medium">${String(log.weight).toUpperCase()} KG</span></p>` : ''}
                                    <p>RESSENTI : <span class="font-medium">${String(log.feeling).toUpperCase()}</span></p>
                                    ${log.notes && log.notes !== '' ? `<p>NOTES : <span class="italic">${String(log.notes).toUpperCase()}</span></p>` : ''}
                                    <p class="text-xs text-gray-400 mt-2">PHASE : ${String(log.phase).toUpperCase()}</p>
                                </div>
                            </div>`;
                    });
                    logsHtml += `</div>`;
                    workoutLogsListDiv.innerHTML = logsHtml;

                    workoutLogsListDiv.querySelectorAll('.delete-log-btn').forEach(button => {
                        button.onclick = async (event) => {
                            const idToDelete = event.target.dataset.id;
                            if (await showConfirmModal("CONFIRMER LA SUPPRESSION DU JOURNAL ?")) {
                                workoutLogs = workoutLogs.filter(log => log.id !== idToDelete);
                                saveToLocalStorage('workoutLogs', workoutLogs);
                                showMessage("SUCCÈS: JOURNAL SUPPRIMÉ !", 'success');
                                renderProgressView(container);
                            }
                        };
                    });
                }
            } else {
                workoutLogsSection.innerHTML = '';
            }
        }


        // --- Vue des Trophées ---
        function renderTrophyRoomView(container) {
            const currentLevel = calculateLevelAndXP(userProfile.currentXP).level;
            const earnedTrophies = allTrophies.filter(trophy => currentLevel >= trophy.levelRequired);
            const upcomingTrophies = allTrophies.filter(trophy => currentLevel < trophy.levelRequired).sort((a, b) => a.levelRequired - b.levelRequired);

            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">SALLE DES TROPHÉES</h2>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-3">MES TROPHÉES GAGNÉS (${earnedTrophies.length}) :</h3>
                        <div id="earned-trophies-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${earnedTrophies.length === 0 ? `<p class="text-gray-400 text-center col-span-full">AUCUN TROPHÉE GAGNÉ POUR L'INSTANT. ATTEIGNEZ LE NIVEAU 1 POUR VOTRE PREMIER !</p>` : earnedTrophies.map(trophy => `
                                <div class="bg-gray-800 p-3 rounded-lg border-2 border-green-500 shadow-md text-center">
                                    <span class="text-4xl">🏆</span>
                                    <p class="text-lg font-bold text-yellow-300 mt-2">${String(trophy.name).toUpperCase()}</p>
                                    <p class="text-sm text-gray-300">${String(trophy.description).toUpperCase()}</p>
                                    <p class="text-xs text-blue-400 mt-1">NIVEAU REQUIS : ${trophy.levelRequired}</p>
                                </div>`).join('')}
                        </div>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">TROPHÉES À VENIR (${upcomingTrophies.length}) :</h3>
                        <div id="upcoming-trophies-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${upcomingTrophies.length === 0 ? `<p class="text-gray-400 text-center col-span-full">VOUS AVEZ GAGNÉ TOUS LES TROPHÉES DISPONIBLES !</p>` : upcomingTrophies.map(trophy => `
                                <div class="bg-gray-800 p-3 rounded-lg border-2 border-gray-500 shadow-md text-center opacity-70">
                                    <span class="text-4xl">🔒</span>
                                    <p class="text-lg font-bold text-gray-400 mt-2">${String(trophy.name).toUpperCase()}</p>
                                    <p class="text-sm text-gray-500 italic">${String(trophy.description).toUpperCase()}</p>
                                    <p class="text-xs text-red-400 mt-1">NIVEAU REQUIS : ${trophy.levelRequired}</p>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
            container.innerHTML = html;
        }


        // --- Vue des Options ---
        function renderOptionsView(container) {
            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-yellow-300 mb-4 text-center">OPTIONS</h2>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">RÉGLAGES AUDIO :</h3>
                        <div class="flex items-center justify-center mb-4">
                            <label for="masterVolume" class="block text-gray-200 text-sm font-bold mr-3">VOLUME GLOBAL :</label>
                            <input type="range" id="masterVolume" min="0" max="1" step="0.05" value="${masterVolume}" class="w-full accent-purple-500" />
                            <span id="volume-display" class="ml-3 text-gray-300">${(masterVolume * 100).toFixed(0)}%</span>
                        </div>
                        <button id="toggle-audio-btn" class="btn-retro ${isAudioActive ? 'btn-retro-red' : 'btn-retro-green'} w-full">${isAudioActive ? "DÉSACTIVER LE SON" : "ACTIVER LE SON"}</button>
                        <p class="text-xs text-gray-400 mt-2 text-center">${isAudioActive ? "LE SON EST ACTUELLEMENT ACTIVÉ." : "LE SON EST ACTUELLEMENT DÉSACTIVÉ. Cliquez pour activer et profiter des effets sonores et de la synthèse vocale !"}</p>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">RÉGLAGES D'AFFICHAGE :</h3>
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="toggleExerciseHistory" ${userProfile.hideExerciseHistory ? '' : 'checked'} class="mr-2 h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" />
                            <label for="toggleExerciseHistory" class="text-gray-200 text-sm font-bold">AFFICHER L'HISTORIQUE DES EXERCICES</label>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center">Désactivez pour masquer la section "Historique des entraînements" dans la page "ÉVOLUTION".</p>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">GESTION DU PROGRAMME SPORTIF :</h3>
                        <label for="workoutProgramInput" class="block text-gray-200 text-sm font-bold mb-2">COLLEZ VOTRE PROGRAMME SPORTIF JSON ICI :</label>
                        <textarea id="workoutProgramInput" class="input-retro h-48 mb-4" placeholder="COLLER LE JSON DE VOTRE PROGRAMME SPORTIF..."></textarea>
                        <button id="import-workout-program-btn" class="btn-retro-purple w-full mb-2">IMPORTER PROGRAMME</button>
                        <button id="export-workout-program-btn" class="btn-retro w-full mb-2">EXPORTER PROGRAMME ACTUEL</button>
                        <button id="reset-workout-program-btn" class="btn-retro-red w-full">RÉINITIALISER PROGRAMME PAR DÉFAUT</button>
                        <p class="text-xs text-gray-400 mt-2 text-center">L'IMPORTATION remplace le programme actuel. L'EXPORTATION télécharge le programme actif. La RÉINITIALISATION restaure le programme d'origine de l'application.</p>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-blue-700 bg-gray-700 mb-6">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">ACCÈS API :</h3>
                        <div class="mb-4"><label for="apiKeyInput" class="block text-gray-200 text-sm font-bold mb-2">CLÉ API :</label><input type="text" id="apiKeyInput" class="input-retro" placeholder="ENTREZ VOTRE CLÉ API ICI" value="${userProfile.apiKey}" /></div>
                        <button id="save-api-key-btn" class="btn-retro-green w-full">ENREGISTRER LA CLÉ API</button>
                        <p class="text-xs text-gray-400 mt-2 text-center">STATUT API: <span id="api-status" class="font-bold ${userProfile.apiKey ? 'text-green-400' : 'text-red-400'}">${userProfile.apiKey ? 'CONNECTÉ' : 'DÉCONNECTÉ'}</span></p>
                        <p class="text-xs text-gray-400 mt-1 text-center">LA CLÉ API EST NÉCESSAIRE POUR LA GÉNÉRATION AVANCÉE DE RECETTES ET D'AUTRES FONCTIONNALITÉS.</p>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-purple-500 bg-gray-700">
                        <h3 class="text-xl sm:text-2xl text-yellow-300 mb-3">INFORMATIONS :</h3>
                        <p class="text-gray-300 text-sm sm:text-base">FitQuest est une application conçue pour t'aider à optimiser ton entraînement, ta nutrition et ton sommeil, spécifiquement adaptée aux exigences des agents de sécurité. Ton assistant personnel Waeky te guidera à travers les différentes phases de ton parcours fitness.</p>
                        <p class="text-gray-300 text-sm sm:text-base mt-3">VERSION : 1.0 (BÊTA)</p>
                        <p class="text-gray-300 text-sm sm:text-base mt-1">DÉVELOPPÉ PAR : POXEL CORPORATION</p>
                    </div>
                </div>`;
            container.innerHTML = html;

            const masterVolumeInput = document.getElementById('masterVolume');
            const volumeDisplay = document.getElementById('volume-display');
            const toggleAudioBtn = document.getElementById('toggle-audio-btn');
            const toggleExerciseHistoryCheckbox = document.getElementById('toggleExerciseHistory');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiStatusSpan = document.getElementById('api-status');
            const workoutProgramInput = document.getElementById('workoutProgramInput');
            const importWorkoutProgramBtn = document.getElementById('import-workout-program-btn');
            const exportWorkoutProgramBtn = document.getElementById('export-workout-program-btn'); // New
            const resetWorkoutProgramBtn = document.getElementById('reset-workout-program-btn'); // New

            masterVolumeInput.oninput = (e) => {
                masterVolume = parseFloat(e.target.value);
                volumeDisplay.textContent = `${(masterVolume * 100).toFixed(0)}%`;
                if (Tone.Master) Tone.Master.volume.value = masterVolume === 0 ? -Infinity : 20 * Math.log10(masterVolume);
            };
            toggleAudioBtn.onclick = toggleAudioActive;

            toggleExerciseHistoryCheckbox.checked = !userProfile.hideExerciseHistory;
            toggleExerciseHistoryCheckbox.onchange = (e) => {
                userProfile.hideExerciseHistory = !e.target.checked;
                saveToLocalStorage('userProfile', userProfile);
                showMessage(`HISTORIQUE DES EXERCICES : ${userProfile.hideExerciseHistory ? 'MASQUÉ' : 'AFFICHÉ'}`, 'info');
                if (currentPage === 'progress') renderProgressView(document.getElementById('main-content'));
            };

            saveApiKeyBtn.onclick = () => {
                userProfile.apiKey = apiKeyInput.value.trim();
                saveToLocalStorage('userProfile', userProfile);
                if (userProfile.apiKey) {
                    apiStatusSpan.textContent = 'CONNECTÉ'; apiStatusSpan.classList.remove('text-red-400'); apiStatusSpan.classList.add('text-green-400');
                    showMessage("CLÉ API ENREGISTRÉE !", 'success');
                } else {
                    apiStatusSpan.textContent = 'DÉCONNECTÉ'; apiStatusSpan.classList.remove('text-green-400'); apiStatusSpan.classList.add('text-red-400');
                    showMessage("CLÉ API EFFACÉE.", 'warning');
                }
            };

            importWorkoutProgramBtn.onclick = handleImportWorkoutProgram;
            exportWorkoutProgramBtn.onclick = handleExportWorkoutProgram; // New
            resetWorkoutProgramBtn.onclick = handleResetWorkoutProgram; // New

            async function handleImportWorkoutProgram() {
                const jsonString = workoutProgramInput.value.trim();
                if (!jsonString) {
                    showMessage("ERREUR: LE CHAMP D'IMPORTATION EST VIDE.", 'error');
                    return;
                }

                try {
                    const importedProgram = JSON.parse(jsonString);

                    // Basic validation: check for 'phase1' and 'phase2' structure
                    if (!importedProgram.phase1 || !importedProgram.phase2 ||
                        !importedProgram.phase1.sessions || !importedProgram.phase2.sessions ||
                        !importedProgram.phase1.sessions.main || !importedProgram.phase2.sessions.main) {
                        showMessage("ERREUR: LE PROGRAMME IMPORTÉ N'A PAS LE FORMAT ATTENDU (DOIT CONTENIR 'phase1' ET 'phase2' AVEC DES SESSIONS).", 'error');
                        return;
                    }

                    // Replace the global workoutProgram
                    workoutProgram = importedProgram;
                    saveToLocalStorage('savedWorkoutProgram', workoutProgram); // Save the new program

                    // Reset selected phase to default if the current one doesn't exist in the new program
                    let currentSelectedPhase = loadFromLocalStorage('selectedWorkoutPhase', 'phase1');
                    if (!workoutProgram[currentSelectedPhase]) {
                        saveToLocalStorage('selectedWorkoutPhase', 'phase1');
                    }

                    showMessage("SUCCÈS: PROGRAMME SPORTIF IMPORTÉ ET MIS À JOUR !", 'success');
                    speak("Programme sportif mis à jour !");
                    renderPage('workout'); // Re-render the workout page with the new program
                } catch (e) {
                    console.error("Erreur lors de l'importation du programme sportif:", e);
                    showMessage(`ERREUR: FORMAT JSON INVALIDE. VÉRIFIEZ VOTRE PROGRAMME. ${e.message}`, 'error');
                }
            }

            // New function to export the current workout program
            function handleExportWorkoutProgram() {
                try {
                    const programJson = JSON.stringify(workoutProgram, null, 2); // Pretty print JSON
                    const blob = new Blob([programJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'poxel_workout_program.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage("SUCCÈS: PROGRAMME SPORTIF EXPORTÉ !", 'success');
                } catch (e) {
                    console.error("Erreur lors de l'exportation du programme sportif:", e);
                    showMessage(`ERREUR: ÉCHEC DE L'EXPORTATION DU PROGRAMME. ${e.message}`, 'error');
                }
            }

            // New function to reset the workout program to default
            async function handleResetWorkoutProgram() {
                if (await showConfirmModal("CONFIRMER LA RÉINITIALISATION DU PROGRAMME SPORTIF ? TOUTES LES MODIFICATIONS SERONT PERDUES.")) {
                    workoutProgram = JSON.parse(JSON.stringify(defaultWorkoutProgramStructure)); // Deep copy the default structure
                    removeFromLocalStorage('savedWorkoutProgram'); // Remove custom program from localStorage
                    saveToLocalStorage('selectedWorkoutPhase', 'phase1'); // Ensure default phase is selected

                    showMessage("SUCCÈS: PROGRAMME SPORTIF RÉINITIALISÉ AUX VALEURS PAR DÉFAUT !", 'success');
                    speak("Programme sportif réinitialisé !");
                    renderPage('workout'); // Re-render the workout page with the default program
                }
            }
        }

        // --- Modales Globales (Boîte de dialogue de confirmation) ---
        function showConfirmModal(message) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 font-vt323";
                modal.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg border-4 border-purple-500 shadow-xl w-full max-w-sm text-white text-center">
                        <p class="text-xl sm:text-2xl mb-4 text-yellow-300">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-no" class="btn-retro-green px-4 py-2">ANNULER</button>
                            <button id="confirm-yes" class="btn-retro-red px-4 py-2">CONFIRMER</button>
                        </div>
                    </div>`;
                document.getElementById('global-modals-container').appendChild(modal);

                document.getElementById('confirm-yes').onclick = () => { modal.remove(); resolve(true); };
                document.getElementById('confirm-no').onclick = () => { modal.remove(); resolve(false); };
            });
        }


        // --- Écouteurs d'événements pour la Navigation ---
        function attachEventListeners() {
            document.querySelectorAll('.nav-item').forEach(button => {
                button.onclick = (event) => renderPage(event.currentTarget.dataset.page);
            });

            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) saveProfileBtn.onclick = handleSaveProfile;
        }


        // --- Chargement Initial ---
        window.onload = initializeApp;
    </script>
</body>
</html>
