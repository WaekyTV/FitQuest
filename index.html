<!DOCTYPE html>
<html lang="fr">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>FitQuest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=VT323&amp;display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
   /* CSS Variables for theming */
        :root {
            /* Base Colors (Default - Current Dark) */
            --color-bg-body: #1a202c; /* bg-gray-900 */
            --color-bg-card: #2d3748; /* card-retro bg, also used for some gray-700/800 */
            --color-bg-input: #131313; /* input-retro bg */
            --color-bg-list-item: #131313; /* For chrono list items */
            --color-bg-table-header: #4a5568; /* table-retro th */
            --color-bg-table-row-border: #4a5568; /* table-retro td border */
            --color-bg-accent-light: #4a5568; /* bg-gray-600 for calories display */

            --color-text-primary: #e2e8f0; /* text-white */
            --color-text-secondary: #cbd5e0; /* text-gray-200 */
            --color-text-tertiary: #a0aec0; /* text-gray-400 */
            --color-text-italic: #a0aec0; /* text-gray-400 italic */

            --color-accent-yellow: #fcd34d; /* text-yellow-300, yellow-500 border */
            --color-accent-blue: #2563eb; /* btn-retro, blue-700 border */
            --color-accent-purple: #9333ea; /* btn-retro-purple, purple-500 border */
            --color-accent-green: #16a34a; /* btn-retro-green, green-600 */
            --color-accent-red: #dc2626; /* btn-retro-red, red-600 */
            --color-accent-blue-light: #60a5fa; /* blue-400 */
            --color-accent-purple-light: #a78bfa; /* purple-300 */
            --color-accent-green-light: #6ee7b7; /* green-300 */

            --color-border-primary: #2563eb; /* blue-700 */
            --color-border-secondary: #a78bfa; /* purple-500 */
            --color-border-yellow: #fcd34d; /* yellow-500 */
        }

        html.dark-mode {
            /* Dark Mode Overrides */
            --color-bg-body: #000000;
            --color-bg-card: #0a0a0a;
            --color-bg-input: #000000;
            --color-bg-list-item: #0a0a0a;
            --color-bg-table-header: #1a1a1a;
            --color-bg-table-row-border: #1a1a1a;
            --color-bg-accent-light: #2a2a2a;

            --color-text-primary: #ffffff;
            --color-text-secondary: #e0e0e0;
            --color-text-tertiary: #c0c0c0;
            --color-text-italic: #c0c0c0;

            --color-accent-yellow: #ffff00;
            --color-accent-blue: #3366ff;
            --color-accent-purple: #bb33ff;
            --color-accent-green: #33cc33;
            --color-accent-red: #ff3333;
            --color-accent-blue-light: #99ccff;
            --color-accent-purple-light: #c299ff;
            --color-accent-green-light: #99ff99;

            --color-border-primary: #007bff;
            --color-border-secondary: #7b68ee;
            --color-border-yellow: #ffff00;
        }

        /* Apply variables to base elements */
        body {
            font-family: 'VT323', monospace;
            background-color: var(--color-bg-body);
            color: var(--color-text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .font-vt323 { font-family: 'VT323', monospace; }

        /* Retro Card Styling */
        .card-retro {
            background-color: var(--color-bg-card);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 4px solid var(--color-border-secondary);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            color: var(--color-text-primary);
        }

        /* Input and Select Styling */
        .input-retro, .select-retro {
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid var(--color-border-primary);
            border-radius: 0.25rem;
            width: 100%;
            padding: 0.5rem 0.75rem;
            line-height: 1.25;
            outline: none;
            transition: all 0.1s ease-in-out;
            color: var(--color-text-primary);
            background-color: var(--color-bg-input);
        }
        .input-retro:focus, .select-retro:focus {
            ring: 2px;
            ring-color: var(--color-border-secondary);
            border-color: var(--color-border-secondary);
        }
        .select-retro option {
            color: var(--color-text-primary);
            background-color: var(--color-bg-input);
        }

        /* Table Styling */
        .table-retro {
            min-width: 100%;
            background-color: var(--color-bg-table-header);
            border-radius: 0.5rem;
            border: 2px solid var(--color-border-primary);
        }
        .table-retro th {
            padding: 0.5rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-accent-yellow);
            border-bottom: 2px solid var(--color-border-primary);
        }
        .table-retro td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--color-bg-table-row-border);
            color: var(--color-text-primary);
        }
        .table-retro tbody tr:last-child td { border-bottom: 0; }

        /* Button Styling */
        .btn-retro {
            background-color: var(--color-accent-blue);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid var(--color-border-primary);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro:hover { background-color: color-mix(in srgb, var(--color-accent-blue) 90%, black); }
        .btn-retro:active { box-shadow: none; transform: translateX(4px) translateY(4px); }

        .btn-retro-purple {
            background-color: var(--color-accent-purple);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid var(--color-border-secondary);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-purple:hover { background-color: color-mix(in srgb, var(--color-accent-purple) 90%, black); }
        .btn-retro-purple:active { box-shadow: none; transform: translateX(4px) translateY(4px); }

        .btn-retro-green {
            background-color: var(--color-accent-green);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid var(--color-accent-green);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-green:hover { background-color: color-mix(in srgb, var(--color-accent-green) 90%, black); }
        .btn-retro-green:active { box-shadow: none; transform: translateX(4px) translateY(4px); }

        .btn-retro-red {
            background-color: var(--color-accent-red);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 2px solid var(--color-accent-red);
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.5);
            transition: all 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-retro-red:hover { background-color: color-mix(in srgb, var(--color-accent-red) 90%, black); }
        .btn-retro-red:active { box-shadow: none; transform: translateX(4px) translateY(4px); }

        .btn-icon {
            font-size: 1.25rem;
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: transparent;
            color: var(--color-text-primary);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-icon:hover { background-color: var(--color-bg-table-header); }

        /* Spinner for loading states */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--color-text-primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* XP Bar Styling */
        .xp-bar-container {
            position: relative;
            width: 100%;
            height: 24px;
            background-color: var(--color-bg-table-header);
            border: 2px solid var(--color-text-tertiary);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--color-accent-green), color-mix(in srgb, var(--color-accent-green) 80%, black));
            transition: width 0.5s ease-in-out, background 0.5s ease-in-out;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 2px;
            animation: xp-glow 1.5s infinite alternate;
        }
        @keyframes xp-glow { from { box-shadow: 0 0 5px var(--color-accent-green); } to { box-shadow: 0 0 15px color-mix(in srgb, var(--color-accent-green) 80%, black); } }
        .xp-bar-text {
            position: absolute;
            color: var(--color-bg-body); /* Should contrast with fill */
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10;
            text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white;
        }

        /* Notification Styling */
        .notification-container { position: fixed; z-index: 1000; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.5s ease-out, transform 0.5s ease-out; font-family: 'VT323', monospace; display: flex; align-items: center; gap: 0.5rem; min-width: 250px; max-width: 90%; }
        .notification-container-bottom-right { bottom: 20px; right: 20px; align-items: flex-end; }
        .notification.general, .notification.tip { transform: translateX(100%); background-color: var(--color-accent-blue); color: white; border: 2px solid var(--color-border-primary); text-align: right; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .notification.general.error { background-color: var(--color-accent-red); border-color: var(--color-accent-red); }
        .notification.general.warning { background-color: #d97706; border-color: #9a3412; } /* Keep specific for warning if no variable */
        .notification.general.success { background-color: var(--color-accent-green); border-color: var(--color-accent-green); }
        .notification.general.chrono { background-color: var(--color-accent-purple); border-color: var(--color-border-secondary); }
        .notification.general.ai-advice { background-color: color-mix(in srgb, var(--color-accent-blue) 80%, black); border-color: var(--color-accent-blue); }
        .notification.tip { background-color: #059669; border-color: #065F46; } /* Keep specific for tip if no variable */
        .notification.general.show, .notification.tip.show { transform: translateX(0); opacity: 1; }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .notification-container-bottom-right { left: 50%; transform: translateX(-50%); right: auto; width: 100%; align-items: center; top: auto; bottom: 20px; flex-direction: column-reverse; }
            .notification { width: 90%; margin: 0 auto; border-radius: 0.5rem; text-align: center; flex-direction: column; gap: 0.25rem; }
            .notification.general, .notification.tip { transform: translateX(0) !important; border-radius: 0.5rem; }
            .nav-scroll-container { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
            .nav-scroll-container::-webkit-scrollbar { display: none; }
            .nav-items-wrapper { display: flex; flex-wrap: nowrap; padding-bottom: 5px; }
            .nav-item { flex-shrink: 0; min-width: 80px; padding: 0.5rem 0.75rem; margin: 0 0.25rem; }
            .main-content-area { padding-bottom: 6rem; }
        }

        /* Range Input (Slider) Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--color-bg-table-header);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: var(--color-bg-table-header);
            border-radius: 5px;
            border: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-accent-yellow);
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0,0,0,.6);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-accent-yellow);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,.6);
        }
        input[type="range"]::-moz-range-track {
            background: var(--color-bg-table-header);
            border-radius: 5px;
            height: 8px;
        }
        input[type="range"]::-ms-track {
            background: var(--color-bg-table-header);
            border-radius: 5px;
            height: 8px;
            color: transparent;
        }
        input[type="range"]::-ms-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-accent-yellow);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,.6);
        }

        /* Specific element overrides using variables */
        .header-bg {
            background: linear-gradient(to right, var(--color-accent-blue), color-mix(in srgb, var(--color-accent-blue) 80%, black));
        }
        .nav-bg {
            background-color: var(--color-bg-card);
        }
        .nav-border {
            border-color: var(--color-border-primary);
        }
        .nav-item {
            border-color: var(--color-bg-card); /* Default border for nav items */
        }
        .nav-item:hover {
            background-color: var(--color-bg-table-header); /* Hover background for nav items */
        }
        .nav-item.active {
            background-color: var(--color-accent-blue);
            color: var(--color-text-primary);
            border-color: var(--color-border-primary);
        }

        /* Specific card backgrounds */
        .card-bg-blue-border {
            background-color: var(--color-bg-card);
            border-color: var(--color-border-primary);
        }
        .card-bg-purple-border {
            background-color: var(--color-bg-card);
            border-color: var(--color-border-secondary);
        }
        .card-bg-yellow-border {
            background-color: var(--color-bg-card);
            border-color: var(--color-border-yellow);
        }

        /* Text colors */
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-tertiary { color: var(--color-text-tertiary); }
        .text-accent-yellow { color: var(--color-accent-yellow); }
        .text-accent-blue { color: var(--color-accent-blue); }
        .text-accent-purple { color: var(--color-accent-purple); }
        .text-accent-green { color: var(--color-accent-green); }
        .text-accent-red { color: var(--color-accent-red); }
        .text-accent-blue-light { color: var(--color-accent-blue-light); }
        .text-accent-purple-light { color: var(--color-accent-purple-light); }
        .text-accent-green-light { color: var(--color-accent-green-light); }

        /* Specific element background colors */
        .bg-blue-active { background-color: var(--color-accent-blue); } /* For workout type display */
        .bg-list-item { background-color: var(--color-bg-list-item); } /* For chrono list items */
        .bg-trophy-card {
            background-color: color-mix(in srgb, var(--color-accent-yellow) 20%, var(--color-bg-card));
        }
        html.dark-mode .bg-trophy-card {
            background-color: color-mix(in srgb, var(--color-accent-yellow) 10%, var(--color-bg-card));
        }
        .bg-accent-light { background-color: var(--color-bg-accent-light); } /* For calories display bg */
        .form-checkbox:checked {
            background-color: var(--color-accent-purple);
            border-color: var(--color-accent-purple);
        }
        .form-checkbox.text-blue-600:checked { background-color: var(--color-accent-blue); border-color: var(--color-accent-blue); }
        .form-checkbox.text-green-600:checked { background-color: var(--color-accent-green); border-color: var(--color-accent-green); }
        .form-checkbox.text-purple-600:checked { background-color: var(--color-accent-purple); border-color: var(--color-accent-purple); }
        .form-checkbox.text-red-600:checked { background-color: var(--color-accent-red); border-color: var(--color-accent-red); }
  </style>
 </head>
 <body class="font-vt323 min-h-screen flex flex-col">
  <div class="min-h-screen flex flex-col" id="app-container">
   <header class="header-bg text-accent-yellow p-5 shadow-md border-b-4 border-secondary rounded-b-lg">
    <div class="flex items-center justify-center relative">
     <button class="absolute left-0 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 btn-icon" id="home-button" title="Retour à l'accueil">
      <i class="text-accent-yellow text-3xl" data-lucide="home"></i>
     </button>
     <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-center tracking-widest leading-tight flex-1">FITQUEST</h1>
    </div>
    <p class="text-center text-lg sm:text-xl mt-2 opacity-90">TON PROGRAMME PERSONNALISÉ</p>
    <p class="text-center text-sm sm:text-base mt-1 opacity-80 text-tertiary">GÉNÉRÉ PAR POXEL, TON IA PERSONNELLE</p>
    <p class="text-center text-xs sm:text-sm mt-2 opacity-80 text-tertiary hidden" id="user-id-display">
     ID UTILISATEUR:
     <span class="font-mono break-all" id="user-id-value"></span>
    </p>
    <div class="flex items-center justify-center my-4 px-4">
     <i class="text-accent-yellow text-3xl sm:text-4xl mr-2" data-lucide="zap"></i>
     <div class="flex-1 xp-bar-container">
      <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%;"></div>
      <span class="xp-bar-text" id="xp-bar-text">LVL 0 : 0/100 XP</span>
     </div>
    </div>
    <div class="mt-4 p-3 card-bg-blue-border">
     <h3 class="text-lg sm:text-xl font-bold text-accent-yellow mb-2">TON PROFIL ET STATS VITALES :</h3>
     <div class="flex flex-col sm:flex-row sm:items-end gap-3 justify-center">
      <div class="flex-1 w-full sm:w-auto">
       <label class="block text-secondary text-sm font-bold mb-1" for="userHeight">TAILLE (CM) :</label>
       <input class="input-retro" id="userHeight" placeholder="EX: 175" type="number"/>
      </div>
      <div class="flex-1 w-full sm:w-auto">
       <label class="block text-secondary text-sm font-bold mb-1" for="userWeight">POIDS (KG) :</label>
       <input class="input-retro" id="userWeight" placeholder="EX: 70" type="number"/>
      </div>
      <button class="btn-retro-green sm:w-auto w-full px-5 py-2" id="save-profile-btn">ENREGISTRER</button>
     </div>
     <div class="mt-3 text-center text-lg text-primary hidden" id="imc-display">
      <p>TON IMC : <span class="font-bold text-accent-yellow" id="imc-value"></span></p>
      <p>CATÉGORIE : <span class="font-bold text-accent-blue-light" id="imc-category"></span></p>
      <p>PROTÉINES ESTIMÉES : <span class="font-bold text-accent-yellow" id="protein-needs"></span></p>
      <div class="text-xs text-tertiary mt-2">
       <p>**IMC INF. À 16.5 :** INSUFFISANCE PONDÉRALE (DÉNUTRITION SÉVÈRE)</p>
       <p>**IMC 16.5 À 18.4 :** INSUFFISANCE PONDÉRALE</p>
       <p>**IMC 18.5 À 24.9 :** POIDS NORMAL</p>
       <p>**IMC 25 À 26.9 :** SURPOIDS (PRÉ-OBÉSITÉ)</p>
       <p>**IMC 27 À 29.9 :** OBÉSITÉ MODÉRÉE</p>
       <p>**IMC 30 À 34.9 :** OBÉSITÉ CLASSE I</p>
       <p>**IMC 35 À 39.9 :** OBÉSITÉ CLASSE II (SÉVÈRE)</p>
       <p>**IMC SUP. OU ÉGAL À 40 :** OBÉSITÉ CLASSE III (MORBIDE OU MASSIVE)</p>
       <p class="mt-2">**BESOINS EN PROTÉINES :** ESTIMATION POUR LA RÉCUPÉRATION MUSCULAIRE ET LE MAINTIEN DE LA MASSE CORPORELLE, CLÉ POUR TON ACTIVITÉ PHYSIQUE.</p>
      </div>
     </div>
    </div>
   </header>
   <nav class="nav-bg shadow-xl py-3 px-2 sm:px-4 border-y-4 nav-border rounded-b-lg mb-4 mx-2">
    <div class="nav-scroll-container">
     <div class="nav-items-wrapper">
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="daily_plan">
       <i class="text-xl" data-lucide="calendar" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">PLANNING</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="workout">
       <i class="text-xl" data-lucide="dumbbell" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">SPORT</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="recipes">
       <i class="text-xl" data-lucide="utensils" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">RECETTES</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="chrono">
       <i class="text-xl" data-lucide="timer" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">CHRONO</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="progress">
       <i class="text-xl" data-lucide="line-chart" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">ÉVOLUTION</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="trophies">
       <i class="text-xl" data-lucide="trophy" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">TROPHÉES</span>
      </button>
      <button class="nav-item inline-flex flex-col items-center justify-center p-2 rounded-lg transition-all duration-100 text-secondary hover:bg-gray-700 hover:text-accent-yellow border-2 border-gray-700 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] active:shadow-none active:translate-x-1 active:translate-y-1" data-page="options">
       <i class="text-xl" data-lucide="settings" style="width:24px; height:24px;"></i>
       <span class="text-sm mt-1">OPTIONS</span>
      </button>
     </div>
    </div>
   </nav>
   <main class="flex-1 p-4 sm:p-6 main-content-area max-w-full mx-auto" id="main-content"></main>
   <footer class="fixed bottom-0 left-0 right-0 nav-bg shadow-lg p-3 sm:hidden border-t-4 nav-border text-center text-xs text-tertiary">
    FitQuest - 2023
   </footer>
  </div>
  <div id="global-modals-container"></div>
  <div class="notification-container notification-container-bottom-right flex-col-reverse" id="notification-container-bottom-right"></div>
  <script>
   // Fonction pour rendre les icônes Lucide
        function renderLucideIcons() { lucide.createIcons(); }

        // Variables d'état globales de l'application
        let currentPage = 'daily_plan';
        let weeklyMealPlan = null;
        let userProfile = { height: '', weight: '', imc: null, imcCategory: '', proteinNeeds: 'N/A', currentXP: 0, earnedTrophies: [], hideExerciseHistory: false, apiKey: '', likedMeals: [], isDarkMode: false };
        let workoutLogs = [];
        let weightHistory = [];
        let intervalSequences = [];
        let shifts = [];
        let workoutProgram = {};
        let previousLevel = 0;
        let isAudioActive = true;
        let masterVolume = 1;
        let trophySoundPlayer, levelUpPlayer, majorLevelUpPlayer, beepPlayer, startSoundPlayer, synth;
        let chronoIntervals = [];
        let chronoCurrentTime = 0;
        let chronoCurrentIntervalIndex = -1;
        let isChronoRunning = false;
        let isChronoPaused = false;
        let enableChronoPreCountdown = true;
        let chronoPreCountdownDuration = 10;
        let chronoIntervalTimerRef = null;
        let weightChartInstance = null;
        let exerciseChartInstance = null;
        let userId = 'local_user';
        let editingIntervalIndex = -1;
        let regeneratingMeal = null; // Flag to control generation state

        // Nutritional program text to be passed to the AI
        const nutritionalProgramText = `
Principes Généraux de ta Nutrition :
1. Hydratation Optimale : Bois 3 grands verres d'eau avant chaque repas. Aie toujours une bouteille d'eau à portée de main. Les tisanes et le thé non sucrés sont d'excellentes alternatives.
2. Priorité aux Protéines et aux Fibres : Essentielles pour la satiété, le maintien de la masse musculaire et sa réparation. Inclus-en à chaque repas principal et dans les collations si besoin. Mange des légumes à volonté à chaque repas.
3. Glucides Complexes pour l'Énergie : Privilégie les glucides complexes à faible indice glycémique pour une énergie durable (riz, pommes de terre, patate douce, quinoa, flocons d'avoine, pain complet). Adapte la quantité à ton niveau d'activité.
4. Graisses Saines avec Modération : Importantes pour la santé hormonale et l'absorption des vitamines. Concentre-toi sur les graisses saines : huiles végétales (olive, colza), avocats, oléagineux, poissons gras. Utilise avec parcimonie.
5. Gestion du Sucre et du Gras ("Plaisirs") : Monster Energy une fois par semaine. Les sorties au bar à jeux ou les "cheat meals" sont importants pour le moral, mais ne pas en faire une routine quotidienne.
6. Aliments pour la Sclérose en Plaques (SEP) : Privilégier Oméga-3 (poissons gras, graines de lin, chia, noix), antioxydants (fruits et légumes colorés), Vitamine D (exposition soleil, poissons gras, champignons).

Ton Plan Nutritionnel Détaillé par Type de Jour :
1. Jours de Travail : Postes de Jour (6h-18h ou 7h-18h)
    - Petit-déjeuner (vers 5h00-6h30, avant de partir) : Boisson (thé/tisane avec lait, sucres, miel). Option 1: galette/pancake (50g flocons d'avoine mixés, 20-30g whey protéine, 1 banane écrasée/fruits rouges, eau/lait). Option 2: 50g flocons d'avoine en porridge OU 2 tranches pain complet (60-80g) avec purée d'oléagineux/miel. Fruit entier.
    - Collation matinale (optionnel, vers 9h-10h) : Fruit (pomme + 10 amandes) OU petite poignée oléagineux (15-20 amandes/noix) OU yaourt grec nature (100-150g).
    - Déjeuner (vers 12h-13h) : Légumes généreux. Protéines (120-150g cuits: poulet, dinde, cabillaud, thon naturel. Alternatives économiques: lentilles, pois chiches, haricots rouges (150-200g cuits). Option: 1 shaker whey (30g)). Féculents (150-200g cuits: riz, pommes de terre, patate douce, quinoa, semoule). Matière grasse (1 cs huile olive/colza).
    - Collation après-midi (vers 17h) : Fruit OU yaourt nature/fromage blanc OU shaker whey OU petite poignée noix de cajou/amandes (15g).
    - Dîner (après le travail, vers 19h) : Légumes généreux. Protéines (100-120g cuits: poisson maigre, viande blanche, tofu, whey). Féculents (100-120g cuits, optionnel: pommes de terre, riz). Matière grasse (1 petite cuillère huile olive/colza). Fruit (si faim).

2. Jours de Travail : Postes de Nuit (18h-6h)
    - Repas AVANT POSTE (vers 17h) : Légumes généreux. Protéines (120-150g cuits: viande blanche, poisson). Féculents (150-200g cuits: riz, pommes de terre, patate douce, quinoa). Matière grasse (1 cs huile olive/colza).
    - Collation début de nuit (vers 22h-23h - facultatif) : Fruit (banane/pomme) + 10-15g oléagineux OU 2 tartines pain complet + purée d'amande.
    - Repas PENDANT poste ("Mini-repas", vers 2h-3h) : Légumes. Protéines (80-100g cuits: poisson blanc, thon naturel, œuf dur, fromage blanc/yaourt grec. Alternative: petit shaker whey). Féculents (80-100g cuits, petite portion: riz, pommes de terre, patate douce, pain complet). Matière grasse (filet d'huile).
    - Collation fin de nuit (vers 4h-5h - facultatif) : Fruit OU yaourt nature OU petite poignée de noix.
    - Repas APRÈS POSTE (vers 6h30-7h, avant de dormir) : Boisson (thé/tisane avec lait, sucres, miel). Glucides complexes et protéines: Galette/Pancake protéiné (50g flocons d'avoine, 20-30g whey protéine, 1 banane écrasée/fruits rouges, eau/lait). Option simple: 50g flocons d'avoine en porridge OU 2 tranches pain complet avec purée d'oléagineux/miel. Fruit entier.

3. Jours de Repos / Créatifs / Chill
    - Petit-déjeuner ou Brunch (selon réveil, 8h-10h) : Boisson (thé/tisane avec lait, sucres, miel). Option 1: galette/pancake protéiné. Option 2 (variété !) : 50g flocons d'avoine en porridge (avec fruits rouges + yaourt nature + miel) OU 2-3 tranches pain complet toastées avec purée d'oléagineux/miel + 1 banane. OU Bowl protéiné (quinoa + fromage blanc + fruits secs).
    - Collation matinale (si besoin, 10h30-11h30) : Fruit OU petite poignée oléagineux OU yaourt grec nature.
    - Déjeuner (vers 13h) : Légumes généreux. Protéines (120-150g cuits, varie tes sources !) : Viande blanche (poulet, dinde) ou poisson maigre (cabillaud, colin). 1 à 2 fois par semaine, du saumon, maquereau ou sardines pour les précieux Oméga-3. Alternatives : Légumineuses (lentilles, pois chiches, haricots rouges - environ 150-200g cuits), tofu. Féculents (150-200g cuits, à ajuster) : Riz, pommes de terre, patate douce, quinoa, semoule. Matière grasse (1 cs huile olive/colza).
    - Collation après-midi (si besoin, 16h-17h) : Fruit OU yaourt nature ou fromage blanc (0% ou 20%) OU un shaker de whey protéine avec de l'eau OU une petite poignée de noix de cajou ou amandes (15g). Option "plaisir maison" : 1 part de gâteau flocons d'avoine/whey maison (type banana bread protéiné).
    - Dîner (vers 19h-20h) : Légumes généreux. Protéines (100-120g cuits: poisson maigre, viande blanche, tofu, whey). Féculents (100-150g cuits, optionnel: riz, pommes de terre, patate douce). Matière grasse (1 petite cuillère huile olive/colza). Fruit (si faim).

Notes générales pour ta Nutrition :
- Varie les plaisirs ! Change les fruits et légumes selon la saison.
- Cuissons douces : Privilégie la vapeur, le four, les sautés rapides.
- Assaisonnement : Limite les sauces industrielles. Préfère huile d'olive, jus de citron, vinaigre, herbes fraîches et épices.
- Hydratation : Bois beaucoup d'eau, thé et tisanes tout au long de la journée.
- Préparation (Batch Cooking) : Profite de tes jours de repos pour préparer certains repas ou ingrédients à l'avance.
`;

        // Liste de tous les trophées disponibles et leurs conditions
        const allTrophies = [
            { id: 't001', name: 'PREMIER PAS', description: 'Atteindre le Niveau 1. Le voyage commence !', levelRequired: 1 },
            { id: 't002', name: 'NOVICE EN FORME', description: 'Atteindre le Niveau 2. Vous prenez le rythme.', levelRequired: 2 },
            { id: 't003', name: 'INITIÉ DU FIT', description: 'Atteindre le Niveau 3. Les efforts paient.', levelRequired: 3 },
            { id: 't004', name: 'FORME CROISSANTE', description: 'De mieux en mieux !', levelRequired: 4 },
            { id: 't005', name: 'DÉBUTANT AVANCÉ', description: 'Vous n\'êtes plus un débutant.', levelRequired: 5 },
            { id: 't006', name: 'CONSTANCE MÉRITÉE', description: 'La régularité, c\'est la clé.', levelRequired: 6 },
            { id: 't007', name: 'ÉLAN DU PROGRÈS', description: 'Vous sentez la progression.', levelRequired: 7 },
            { id: 't008', name: 'GAINS ASSURÉS', description: 'Les efforts paient.', levelRequired: 8 },
            { id: 't009', name: 'AVANCÉE RAPIDE', description: 'Vous brûlez les étapes.', levelRequired: 9 },
            { id: 't010', name: 'DIXIÈME ÉTAPE', description: 'Un jalon important !', levelRequired: 10 },
            { id: 't011', name: 'MAÎTRE INTERMÉDIAIRE', description: 'Le fitness devient une habitude.', levelRequired: 11 },
            { id: 't012', name: 'FORCE ÉMERGENTE', description: 'Vos limites sont repoussées.', levelRequired: 12 },
            { id: 't013', name: 'ENDURANCE ACCRUE', description: 'Le cardio n\'a plus de secret.', levelRequired: 13 },
            { id: 't014', name: 'EXCELLENCE EN VUE', description: 'La performance est à portée.', levelRequired: 14 },
            { id: 't015', name: 'DEMI-MAÎTRE', description: 'Vous êtes sur la bonne voie.', levelRequired: 15 },
            { id: 't016', name: 'DISCIPLINE DE FER', description: 'Votre engagement est fort.', levelRequired: 16 },
            { id: 't017', name: 'ÉNERGIE DÉCUPLÉE', description: 'Sentez cette vitalité !', levelRequired: 17 },
            { id: 't018', name: 'HARMONIE CORPS/ESPRIT', description: 'L\'équilibre est parfait.', levelRequired: 18 },
            { id: 't019', name: 'FORME OPTIMALE', description: 'Vous rayonnez de santé.', levelRequired: 19 },
            { id: 't020', name: 'DEUXIÈME DIZAINE', description: 'Double décennie de fitness !', levelRequired: 20 },
            { id: 't021', name: 'EXPERT EN DEVENIR', description: 'La maîtrise approche.', levelRequired: 21 },
            { id: 't022', name: 'PUISSANCE RÉVÉLÉE', description: 'Une force insoupçonnée.', levelRequired: 22 },
            { id: 't023', name: 'AGILITÉ MAXIMALE', description: 'Votre corps est un temple agile.', levelRequired: 23 },
            { id: 't024', name: 'RÉSISTANCE INÉGALÉE', description: 'Rien ne vous arrête.', levelRequired: 24 },
            { id: 't025', name: 'QUART DE SIÈCLE', description: 'Vous êtes une machine !', levelRequired: 25 },
            { id: 't026', name: 'PERFECTION EN MARCHE', description: 'Chaque pas est un succès.', levelRequired: 26 },
            { id: 't027', name: 'FORME INCROYABLE', description: 'Admirez votre progression !', levelRequired: 27 },
            { id: 't028', name: 'DÉTERMINATION ACÉRÉE', description: 'Votre volonté est sans faille.', levelRequired: 28 },
            { id: 't029', name: 'INÉPUISABLE', description: 'L\'énergie vous habite.', levelRequired: 29 },
            { id: 't030', name: 'LE TREINTIÈME', description: 'Un cap monumental !', levelRequired: 30 },
            { id: 't031', name: 'MAÎTRE ABSOLU', description: 'Vous êtes une référence.', levelRequired: 31 },
            { id: 't032', name: 'EXPERT LÉGENDAIRE', description: 'Votre réputation vous précède.', levelRequired: 32 },
            { id: 't033', name: 'OLYMPIEN EN HERBE', description: 'Digne des plus grands athlètes.', levelRequired: 33 },
            { id: 't034', name: 'CHAMPION INCROYABLE', description: 'Votre esprit est indomptable.', levelRequired: 34 },
            { id: 't035', name: 'LE PRODIGE', description: 'Vos prouesses sont inégalées.', levelRequired: 35 },
            { id: 't036', name: 'FORCE DE LA NATURE', description: 'Vous êtes imparable.', levelRequired: 36 },
            { id: 't037', name: 'FORME DIVINE', description: 'Votre corps est une œuvre d\'art.', levelRequired: 37 },
            { id: 't038', name: 'CONNAISSANCE SUPRÊME', description: 'Votre savoir est immense.', levelRequired: 38 },
            { id: 't039', name: 'RÉALISATION PARFAITE', description: 'Tout est sous contrôle.', levelRequired: 39 },
            { id: 't040', name: 'QUARANTIÈME HORIZON', description: 'Le ciel est votre limite !', levelRequired: 40 },
            { id: 't041', name: 'LÉGENDE VIVANTE', description: 'On parlera de vous.', levelRequired: 41 },
            { id: 't042', name: 'INSPIRATION ULTIME', description: 'Vous inspirez les foules.', levelRequired: 42 },
            { id: 't043', name: 'DÉFI RELEVÉ', description: 'Chaque obstacle est un tremplin.', levelRequired: 43 },
            { id: 't044', name: 'SUMMUM DE LA FORME', description: 'Vous êtes au sommet.', levelRequired: 44 },
            { id: 't045', name: 'LE MAÎTRE CULMINANT', description: 'La perfection incarnée.', levelRequired: 45 },
            { id: 't046', name: 'IMPARABLE', description: 'Vous êtes invaincu !', levelRequired: 46 },
            { id: 't047', name: 'VOLONTÉ DE DIAMANT', description: 'Votre détermination est inébranlable.', levelRequired: 47 },
            { id: 't048', name: 'ÉCLAT ÉTERNEL', description: 'Votre aura brille.', levelRequired: 48 },
            { id: 't049', name: 'CONNAISSANCE ABSOLUE', description: 'Le savoir vous guide.', levelRequired: 49 },
            { id: 't050', name: 'LE CINQUANTIÈME', description: 'Une performance extraordinaire !', levelRequired: 50 },
            { id: 't051', name: 'GRAND MAÎTRE', description: 'Vous êtes au-delà de l\'excellence.', levelRequired: 51 },
            { id: 't052', name: 'ARCHITECTE DU CORPS', description: 'Vous sculptez votre destin.', levelRequired: 52 },
            { id: 't053', name: 'ARTISAN DE LA SANTÉ', description: 'Votre bien-être est une œuvre.', levelRequired: 53 },
            { id: 't054', name: 'GUERRIER DE LA FORME', description: 'Combattez pour votre meilleure version.', levelRequired: 54 },
            { id: 't055', name: 'CONQUÉRANT DU PHYSIQUE', description: 'Chaque jour est une victoire.', levelRequired: 55 },
            { id: 't056', name: 'PIONNIER DU BIEN-ÊTRE', description: 'Vous ouvrez la voie.', levelRequired: 56 },
            { id: 't057', name: 'PILIER DE LA VITALITÉ', description: 'Votre énergie est inépuisable.', levelRequired: 57 },
            { id: 't058', name: 'SYNTHÈSE PARFAITE', description: 'L\'équilibre est atteint.', levelRequired: 58 },
            { id: 't059', name: 'PERFORMANCE ULTIME', description: 'Vous défiez les limites.', levelRequired: 59 },
            { id: 't060', name: 'LE SOIXANTIÈME', description: 'Incroyable persévérance !', levelRequired: 60 },
            { id: 't061', name: 'LÉGENDAIRE INDOMPTABLE', description: 'Votre nom résonne.', levelRequired: 61 },
            { id: 't062', name: 'MYTHIQUE', description: 'Votre parcours est une épopée.', levelRequired: 62 },
            { id: 't063', name: 'CHRONIQUE VIVANTE', description: 'Chaque jour écrit l\'histoire.', levelRequired: 63 },
            { id: 't064', name: 'PATRON DES RECORDS', description: 'Les records s\'inclinent.', levelRequired: 64 },
            { id: 't065', name: 'LE NÉMÉSIS DE LA FAIBLESSE', description: 'Plus rien ne vous arrête.', levelRequired: 65 },
            { id: 't066', name: 'VOLONTÉ D\'ACIER', description: 'Votre détermination est inébranlable.', levelRequired: 66 },
            { id: 't067', name: 'MÉTÉORE DE LA FORME', description: 'Votre progression est fulgurante.', levelRequired: 67 },
            { id: 't068', name: 'AU-DELÀ DES LIMITES', description: 'Vous transcendez tout.', levelRequired: 68 },
            { id: 't069', name: 'VISIONNAIRE DU FITNESS', description: 'Votre vision est claire.', levelRequired: 69 },
            { id: 't070', name: 'LE SOIXANTE-DIXIÈME', description: 'Une ascension sans fin !', levelRequired: 70 },
            { id: 't071', name: 'IMMORTEL DE LA FORME', description: 'Votre dévouement est éternel.', levelRequired: 71 },
            { id: 't072', name: 'INVICTUS', description: 'Vous êtes invaincu.', levelRequired: 72 },
            { id: 't073', name: 'MAJESTÉ DU PHYSIQUE', description: 'Votre présence est imposante.', levelRequired: 73 },
            { id: 't074', name: 'SOUVERAIN DE LA SANTÉ', description: 'Vous régnez sur votre bien-être.', levelRequired: 74 },
            { id: 't075', name: 'FORCE COLISEUM', description: 'Digne d\'une arène antique.', levelRequired: 75 },
            { id: 't076', name: 'MYSTÈRE DE LA RÉUSSITE', description: 'Votre succès est fascinant.', levelRequired: 76 },
            { id: 't077', name: 'PERFECTION DE L\'ÊTRE', description: 'Corps et âme alignés.', levelRequired: 77 },
            { id: 't078', name: 'AURORE DE LA GRANDEUR', description: 'Chaque jour est un nouveau chef-d\'œuvre.', levelRequired: 78 },
            { id: 't079', name: 'COURONNE ÉTERNELLE', description: 'Votre legs perdurera.', levelRequired: 79 },
            { id: 't080', name: 'LE QUATRE-VINGTIÈME', description: 'Une légende se construit !', levelRequired: 80 },
            { id: 't081', name: 'DIEU DU FITNESS', description: 'Votre puissance est divine.', levelRequired: 81 },
            { id: 't082', name: 'TITAN DE LA FORME', description: 'Une force colossale.', levelRequired: 82 },
            { id: 't083', name: 'HÉROS ABSOLU', description: 'Vous êtes l\'incarnation du triomphe.', levelRequired: 83 },
            { id: 't084', name: 'DÉFIANT LES MORTELS', description: 'Plus rien ne vous est impossible.', levelRequired: 84 },
            { id: 't085', name: 'LE PHÉNIX DE LA SANTÉ', description: 'Vous renaissez de vos efforts.', levelRequired: 85 },
            { id: 't086', name: 'CONSTELLATION DE MUSCLES', description: 'Chaque muscle brille.', levelRequired: 86 },
            { id: 't087', name: 'L\'AURORE BORÉALE', description: 'Votre beauté est naturelle.', levelRequired: 87 },
            { id: 't088', name: 'LA FULGURANCE', description: 'Votre vitesse est inégalée.', levelRequired: 88 },
            { id: 't089', name: 'L\'INCONNU', description: 'Le monde vous attend.', levelRequired: 89 },
            { id: 't090', name: 'LE NONANTIÈME', description: 'À l\'aube de l\'immortalité !', levelRequired: 90 },
            { id: 't091', name: 'L\'ASCENSION', description: 'Vous touchez les étoiles.', levelRequired: 91 },
            { id: 't092', name: 'LA CONQUÊTE FINALE', description: 'La victoire est proche.', levelRequired: 92 },
            { id: 't093', name: 'LA PERFECTION ATTEINTE', description: 'Chaque aspect est maîtrisé.', levelRequired: 93 },
            { id: 't094', name: 'LE ZÉNITH', description: 'Vous êtes au sommet du monde.', levelRequired: 94 },
            { id: 't095', name: 'LE MYSTÈRE ÉCLAIRCI', description: 'Les secrets sont révélés.', levelRequired: 95 },
            { id: 't096', name: 'LE DESTIN ACCOMPLI', description: 'Votre destinée est scellée.', levelRequired: 96 },
            { id: 't097', name: 'L\'APOTHÉOSE', description: 'Vous êtes glorifié.', levelRequired: 97 },
            { id: 't098', name: 'L\'HÉRITAGE', description: 'Votre histoire sera contée.', levelRequired: 98 },
            { id: 't099', name: 'L\'INFINI', description: 'Les possibilités sont sans fin.', levelRequired: 99 },
            { id: 't100', name: 'MAÎTRE ULTIME DE POXEL', description: 'Félicitations, Poxel vous couronne !', levelRequired: 100 },
            { id: 't101', name: 'AU-DELÀ DE LA CENTAINE I', description: 'Une force continue.', levelRequired: 101 },
            { id: 't102', name: 'AU-DELÀ DE LA CENTAINE II', description: 'La puissance croît.', levelRequired: 102 },
            { id: 't103', name: 'AU-DELÀ DE LA CENTAINE III', description: 'L\'énergie pure.', levelRequired: 103 },
            { id: 't104', name: 'AU-DELÀ DE LA CENTAINE IV', description: 'La maîtrise s\'étend.', levelRequired: 104 },
            { id: 't105', name: 'AU-DELÀ DE LA CENTAINE V', description: 'Les profondeurs de la forme.', levelRequired: 105 },
            { id: 't106', name: 'AU-DELÀ DE LA CENTAINE VI', description: 'La discipline absolue.', levelRequired: 106 },
            { id: 't107', name: 'AU-DELÀ DE LA CENTAINE VII', description: 'Le corps résiste à tout.', levelRequired: 107 },
            { id: 't108', name: 'AU-DELÀ DE LA CENTAINE VIII', description: 'L\'esprit ne faiblit pas.', levelRequired: 108 },
            { id: 't109', name: 'AU-DELÀ DE LA CENTAINE IX', description: 'La sagesse du guerrier.', levelRequired: 109 },
            { id: 't110', name: 'AU-DELÀ DE LA CENTAINE X', description: 'Une décennie de plus de puissance !', levelRequired: 110 },
        ];

        // Routines de sommeil adaptées aux types de poste
        const sleepRoutines = {
            '6h-18h': { name: "ROUTINE JOUR (6H-18H)", details: [ "COUCHER : 22H00 - 23H00.", "RÉVEIL : 05H00 - 06H00.", "ASSURER 7-8H DE SOMMEIL DE QUALITÉ. ÉVITER LES ÉCRANS AVANT LE COUCHER." ] },
            '7h-18h': { name: "ROUTINE JOUR (7H-18H)", details: [ "COUCHER : 22H00 - 22H30.", "RÉVEIL : 06H00 - 06H15.", "OBJECTIF 7-8H DE SOMMEIL. PRIVILÉGIER UN RITUEL DE DÉTENTE PRÉ-SOMMEIL." ] },
            '18h-6h': { name: "ROUTINE NUIT (18H-6H)", details: [ "SOMMEIL PRINCIPAL APRÈS LE POSTE : 07H00 - 14H00/15H00 (7-8H).", "SIESTE PRÉ-POSTE (OPTIONNEL) : 17H00 - 17H45 (45 MIN) POUR BOOSTER LA VIGILANCE.", "UTILISER DES RIDEAUX OCCULTANTS ET UN MASQUE DE SOMMEIL POUR OPTIMISER LE REPOS EN JOURNÉE." ] },
            'repos': { name: "JOUR DE REPOS (RÉCUPÉRATION)", details: [ "MAINTENIR UN HORAIRE DE SOMMEIL PROCHE DES JOURS DE TRAVAIL POUR NE PAS PERTURBER LE RYTHME CIRCADIEN.", "COUCHER : VERS 23H00.", "RÉVEIL : VERS 08H00-09H00.", "POSSIBILITÉ DE SIÈSTE COURTE (20-30 MIN) EN DÉBUT D'APRÈS-MIDI SI NÉCESSAIRE." ] },
            'repos_sport': { name: "JOUR DE REPOS (SPORT)", details: [ "COUCHER : VERS 22H30-23H30.", "RÉVEIL : VERS 07H00-08H00.", "SOMMEIL OPTIMAL POUR LA RÉCUPÉRATION MUSCULAIRE. ÉVITER LES EXCITANTS APRÈS L'ENTRAÎNEMENT." ] }
        };

        // Structure par defaut du programme d'entrainement
        const defaultWorkoutProgramStructure = {
            phase1: {
                name: "PHASE 1 : PROGRAMME INITIAL (POUR LES 4 À 6 PREMIÈRES SEMAINES)",
                sessions: {
                    main: {
                        name: "SÉANCE TYPE : RENFORCEMENT MUSCULAIRE (FULL BODY)",
                        exercises: [
                            { name: "SQUAT (POIDS DU CORPS OU HALTÈRE GOBLET)", desc: "DESCENDS COMME SI TU VOULAIS T'ASSEOIR SUR UNE CHAISE, EN GARDANT LE DOS DROIT. TES GENOUX NE DOIVENT PAS DÉPASSER TES POINTES DE PIEDS.", sets: "4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "POIDS DU CORPS / 4-10 KG", rest: "60-90 SECONDES", type: "legs" },
                            { name: "POMPES (PUSH-UPS)", desc: "GARDE LE CORPS DROIT (PLANCHE). DESCENDS TA POITRINE VERS LE SOL ET POUSSE. PROGRESSION : COMMENCE SUR LES GENOUX OU CONTRE UN MUR/BANC, PUIS AU SOL.", sets: "3-4 SÉRIES", reps: "MAX DE RÉPÉTITIONS", weight: "POIDS DU CORPS", rest: "60-90 SECONDES", type: "chest" },
                            { name: "LAT PULLDOWN (POULIE HAUTE)", desc: "ASSIEDS-TOI, SAISIS LA BARRE AVEC UNE PRISE LARGE. TIRE LA BARRE VERS TA POITRINE, EN CONTRACTANT LE DOS.", sets: "3-4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "25-35 KG", rest: "60-90 SECONDES", type: "back" },
                            { name: "DÉVELOPPÉ COUCHÉ HALTÈRES OU PEC DECK", desc: "HALTÈRES (SUR BANC) : ALLONGÉ, UN HALTÈRE DANS CHAQUE MAIN AU NIVEAU DE LA POITRINE. POUSSE LES HALTÈRES VERS LE HAUT. PEC DECK : ASSIEDS-TOI, SAISIS LES POIGNÉES. POUSSE VERS L'AVANT EN CONTRACTANT LA POITRINE.", sets: "3-4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "6-10 KG / 15-25 KG", rest: "60-90 SECONDES", type: "chest" },
                            { name: "FENTES (LUNGES)", desc: "FAIS UN GRAND PAS EN AVANT, DESCENDS LE GENOU ARRIÈRE VERS LE SOL (SANS LE TOUCHER). GARDE LE CORPS DROIT. REMONTE EN POUSSANT SUR LA JAMBE AVANT.", sets: "3 SÉRIES", reps: "8-12 RÉPÉTITIONS PAR JAMBE", weight: "POIDS DU CORPS / 4-6 KG", rest: "60-90 SECONDES", type: "legs" },
                            { name: "ÉLÉVATIONS LATÉRALES (HALTÈRES)", desc: "TIENS UN HALTÈRE LÉGER DANS CHAQUE MAIN, BRAS LE LONG DU CORPS. LÈVE LES BRAS SUR LES CÔTÉS, LÉGÈREMENT FLÉCHIS, JUSQU'À L'HORIZONTAL.", sets: "3 SÉRIES", reps: "12-15 RÉPÉTITIONS", weight: "2-4 KG", rest: "60-90 SECONDES", type: "shoulders" },
                            { name: "PLANCHE (PLANK)", desc: "SUR LES AVANT-BRAS ET LES POINTES DE PIEDS (OU SUR LES GENOUX SI TROP DIFFICILE), GARDE TON CORPS DROIT ET CONTRACTÉ COMME UNE PLANCHE.", sets: "3 SÉRIES", reps: "30-60 SECONDES", weight: "POIDS DU CORPS", rest: "60 SECONDES", type: "core" }
                        ]
                    },
                    cardio: {
                        name: "SÉANCE TYPE : CARDIO (ENDURANCE, FRACTIONNÉ OU MIXTE)",
                        options: [
                            {
                                name: "TAPIS DE COURSE (FRACTIONNÉ)",
                                desc: "RONDE 1 : 2 MIN MARCHE RAPIDE, 1 MIN COURSE LÉGÈRE. RONDE 2 : 2 MIN MARCHE RAPIDE, 1 MIN COURSE LÉGÈRE.",
                                sets: "2 RONDES", reps: "15 MINUTES PAR RONDE", weight: "N/A", rest: "5 MINUTES ENTRE LES RONDES", type: "cardio"
                            },
                            {
                                name: "VÉLO STATIONNAIRE OU VÉLO ELLIPTIQUE (SYNCHRO) (FRACTIONNÉ)",
                                desc: "RONDE 1 : 3 MIN MODÉRÉ, 1 MIN INTENSE. RONDE 2 : 3 MIN MODÉRÉ, 1 MIN INTENSE.",
                                sets: "2 RONDES", reps: "20 MINUTES PAR RONDE", weight: "N/A", rest: "5 MINUTES ENTRE LES RONDES", type: "cardio"
                            },
                            {
                                name: "CARDIO & FONCTIONNEL MIXTE (MOINS INTENSE QU'UN HIIT)",
                                desc: "PARTIE 1 : TAPIS/VÉLO & MOUNTAIN CLIMBERS/JUMPING JACKS. PARTIE 2 : TAPIS/VÉLO & MONTÉES DE GENOUX/KETTLEBELL SWING.",
                                sets: "2 PARTIES", reps: "20 MIN / 15 MIN", weight: "N/A", rest: "5 MINUTES ENTRE LES PARTIES", type: "cardio"
                            }
                        ]
                    },
                    hiit: {
                        name: "SÉANCE TYPE : HIIT (HIGH-INTENSITY INTERVAL TRAINING)",
                        desc: "DURÉE ESTIMÉE : 30-40 MINUTES. FRÉQUENCE : 1 À 2 FOIS PAR SEMAINE MAXIMUM. ATTENTION : LE HIIT EST INTENSE. ÉCOUTE IMPÉRATIVEMENT TON CORPS. LES JOURS OÙ LA FATIGUE LIÉE À TA SEP EST PLUS PRÉSENTE, REMPLACE CETTE SÉANCE PAR DU CARDIO LÉGER OU DU REPOS ACTIF. CORPS DE SÉANCE (20-25 MINUTES) : RÉALISE 3 À 4 TOURS DU CIRCUIT SUIVANT. CHAQUE EXERCICE : 40 SECONDES D'EFFORT MAXIMAL, SUIVIES DE 20 SECONDES DE REPOS TOTAL. ENTRE CHAQUE TOUR COMPLET DU CIRCUIT : 1 MINUTE 30 DE REPOS ACTIF (MARCHE LÉGÈRE, HYDRATATION).",
                        exercises: [
                            { name: "BURPEES (MODIFIÉS)", desc: "DESCENDS EN SQUAT, POSE LES MAINS AU SOL, JETTE LES JAMBES EN ARRIÈRE POUR TE METTRE EN PLANCHE (SANS POMPE SI TU DÉBUTTES), RAMÈNE LES PIEDS ENTRE LES MAINS, RELÈVE-TOI.", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "POIDS DU CORPS", rest: "20 SECONDES", type: "hiit" },
                            { name: "MOUNTAIN CLIMBERS", desc: "EN POSITION DE PLANCHE, RAMÈNE ALTERNATIVEMENT LES GENOUX VERS LA POITRINE, COMME SI TU 'COURAIS' SUR PLACE.", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "POIDS DU CORPS", rest: "20 SECONDES", type: "hiit" },
                            { name: "JUMPING JACKS", desc: "SAUTE EN ÉCARTANT LES JAMBES ET EN LEVANT LES BRAS AU-DESSUS DE LA TÊTE, PUIS REVIENS EN POSITION INITIALE. (SI LES SAUTS SONT TROP INTENSES, FAIS UN PAS SUR LE CÔTÉ AVEC UN BRAS QUI MONTE, PUIS L'AUTRE).", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "POIDS DU CORPS", rest: "20 SECONDES", type: "hiit" },
                            { name: "KETTLEBELL SWING", desc: "MOUVEMENT DE BALANCIER EN POUSSANT LES HANCHES VERS L'AVANT (PAS AVEC LES BRAS !).", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "6-10 KG", rest: "20 SECONDES", type: "hiit" },
                            { name: "FENTES SAUTÉES", desc: "SAUTE POUR CHANGER DE JAMBE EN L'AIR ET ATTERRIS EN FENTE AVEC L'AUTRE JAMBE DEVANT. MODIFICATION : SI LES SAUTS SONT TROP INTENSES, FAIS DES FENTES ALTERNÉES CLASSIQUES EN TE RELÈVANT RAPIDEMENT ENTRE CHAQUE.", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "POIDS DU CORPS", rest: "20 SECONDES", type: "hiit" },
                            { name: "MONTÉES DE GENOUX RAPIDES", desc: "COURS SUR PLACE EN LEVANT LES GENOUX LE PLUS HAUT POSSIBLE, EN UTILISANT TES BRAS.", sets: "1 SÉRIE", reps: "40 SECONDES", weight: "POIDS DU CORPS", rest: "20 SECONDES", type: "hiit" }
                        ]
                    }
                }
            },
            phase2: {
                name: "PHASE 2 : PROGRAMME ALTERNATIF (POUR LES 4 À 6 SEMAINES SUIVANTES)",
                sessions: {
                    main: {
                        name: "SÉANCE TYPE : RENFORCEMENT MUSCULAIRE (FULL BODY) - ALTERNATIVE",
                        exercises: [
                            { name: "SOULEVÉ DE TERRE ROUMAIN (RDL HALTÈRES)", desc: "TIENS UN HALTÈRE DANS CHAQUE MAIN, PIEDS LARGEUR DES HANCHES. DESCENDS LES HALTÈRES LE LONG DE TES JAMBES EN POUSSANT LES HANCHES VERS L'ARRIÈRE ET EN GARDANT LE DOS DROIT.", sets: "4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "6-10 KG", rest: "60-90 SECONDES", type: "legs" },
                            { name: "TRACTIONS ASSISTÉES (MACHINE)", desc: "TIRE TON CORPS VERS LE HAUT JUSQU'À CE QUE TON MENTON DÉPASSE LA BARRE, EN CONTRACTANT LE DOS. ASSISTANCE : UTILISE LA MACHINE AVEC UN POIDS D'ASSISTANCE ÉLEVÉ, OU UN ÉLASTIQUE ÉPAIS.", sets: "3-4 SÉRIES", reps: "MAX DE RÉPÉTITIONS", weight: "N/A", rest: "60-90 SECONDES", type: "back" },
                            { name: "PRESSE À CUISSES (LEG PRESS)", desc: "POUSSE LA PLATEFORME EN ÉTENDANT LES JAMBES, SANS BLOQUER LES GENOUX.", sets: "3-4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "40-60 KG", rest: "60-90 SECONDES", type: "legs" },
                            { name: "DÉVELOPPÉ ÉPAULES (SHOULDER PRESS HALTÈRES OU MACHINE)", desc: "ASSISE, UN HALTÈRE DANS CHAQUE MAIN AU NIVEAU DES ÉPAULES. POUSSE LES HALTÈRES VERS LE HAUT AU-DESSUS DE TA TÊTE.", sets: "3-4 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "4-8 KG / 10-20 KG", rest: "60-90 SECONDES", type: "shoulders" },
                            { name: "ROWING PENCHÉ (HALTÈRES)", desc: "TIENS UN HALTÈRE DANS CHAQUE MAIN, PENCHE LE BUSTE EN AVANT (DOS DROIT, GENOUX LÉGÈREMENT FLÉCHIS). TIRE LES HALTÈRES VERS TA POITRINE EN CONTRACTANT LES OMOPLATES.", sets: "3 SÉRIES", reps: "10-15 RÉPÉTITIONS", weight: "6-10 KG", rest: "60-90 SECONDES", type: "back" },
                            { name: "EXTENSIONS TRICEPS (POULIE HAUTE OU HALTÈRE)", desc: "POULIE : COUDES COLLÉS AU CORPS. POUSSE LA BARRE VERS LE BAS EN NE BOUGEANT QUE L'AVANT-BRAS. HALTÈRE (DERRIÈRE LA TÊTE) : TIENS UN HALTÈRE AVEC LES DEUX MAINS DERRIÈRE TA TÊTE, POUSSE VERS LE HAUT.", sets: "3 SÉRIES", reps: "12-15 RÉPÉTITIONS", weight: "10-15 KG / 4-8 KG", rest: "60-90 SECONDES", type: "arms" },
                            { name: "CRUNCHS (ABDOMINALS)", desc: "LÈVE LES ÉPAULES DU SOL EN CONTRACTANT LES ABDOMINAUX, SANS TIRER SUR LA NUQUE.", sets: "3 SÉRIES", reps: "15-20 RÉPÉTITIONS", weight: "POIDS DU CORPS", rest: "30 SECONDES", type: "core" }
                        ]
                    },
                    cardio: {
                        name: "SÉANCE TYPE : CARDIO (ENDURANCE, FRACTIONNÉ OU MIXTE) - ALTERNATIVE",
                        options: [
                            {
                                name: "TAPIS DE COURSE (ENDURANCE À PENTE VARIABLE)",
                                desc: "5 MIN ÉCHAUFFEMENT LÉGER. RONDE 1 : 2 MIN MARCHE RAPIDE, 3 MIN MARCHE RAPIDE, 2 MIN COURSE LÉGÈRE.",
                                sets: "1 SÉRIE", reps: "40-50 MINUTES", weight: "N/A", rest: "N/A", type: "cardio"
                            },
                            {
                                name: "RAMEUR (ROWING MACHINE) - INTERVAL TRAINING",
                                desc: "5 MIN ÉCHAUFFEMENT LÉGER. RONDE 1 : 2 MIN MODÉRÉ, 1 MIN INTENSE. RONDE 2 : 3 MIN MODÉRÉ, 1 MIN INTENSE.",
                                sets: "2 RONDES", reps: "15 MINUTES PAR RONDE", weight: "N/A", rest: "5 MINUTES ENTRE LES RONDES", type: "cardio"
                            },
                            {
                                name: "CARDIO & FONCTIONNEL MIXTE (ALTERNATIF)",
                                desc: "PARTIE 1 : RAMEUR/ELLIPTIQUE & SQUAT/FENTES. PARTIE 2 : TAPIS/VÉLO & BURPEES/CORDE À SAUTER.",
                                sets: "2 PARTIES", reps: "20 MIN / 15 MIN", weight: "N/A", rest: "N/A", type: "cardio"
                            }
                        ]
                    },
                    hiit: {
                        name: "SÉANCE TYPE : HIIT (HIGH-INTENSITY INTERVAL TRAINING) - ALTERNATIVE",
                        desc: "DURÉE ESTIMÉE : 30-40 MINUTES. FRÉQUENCE : 1 À 2 FOIS PAR SEMAINE MAXIMUM. ATTENTION : LE HIIT EST INTENSE. ÉCOUTE IMPÉRATIVEMENT TON CORPS. LES JOURS OÙ LA FATIGUE LIÉE À TA SEP EST PLUS PRÉSENTE, REMPLACE CETTE SÉANCE PAR DU CARDIO LÉGER OU DU REPOS ACTIF. CORPS DE SÉANCE (20-25 MINUTES) : RÉALISE 3 À 4 TOURS DU CIRCUIT SUIVANT. CHAQUE EXERCICE : 45 SECONDES D'EFFORT INTENSE, SUIVIES DE 15 SECONDES DE REPOS TOTAL. ENTRE CHAQUE TOUR COMPLET DU CIRCUIT : 1 MINUTE 15 DE REPOS ACTIF (MARCHE LÉGÈRE, HYDRATATION).",
                        exercises: [
                            { name: "BURPEES (AVEC POMPE)", desc: "FAIS UN BURPEE COMPLET, EN INCLUANT UNE POMPE (SUR LES GENOUX SI BESOIN) LORSQUE TU ES EN POSITION DE PLANCHE.", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "POIDS DU CORPS", rest: "15 SECONDES", type: "hiit" },
                            { name: "BOX JUMPS OU STEP-UPS", desc: "SAUTE SUR UNE BOÎTE BASSE (OU UN STEP) ET DESCENDS. SI LES SAUTS SONT UN PROBLÈME : FAIS DES STEP-UPS RAPIDES (MONTE ET DESCENDS DU BANC UNE JAMBE APRÈS L'AUTRE).", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "POIDS DU CORPS", rest: "15 SECONDES", type: "hiit" },
                            { name: "CORDE À SAUTER", desc: "SAUTE À LA CORDE. VARIE LES SAUTS (PIEDS JOINTS, ALTERNÉS). SI PAS DE CORDE OU TROP DIFFICILE : FAIS DES SAUTS SUR PLACE LÉGERS OU DES PAS CHASSÉS RAPIDES.", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "POIDS DU CORPS", rest: "15 SECONDES", type: "hiit" },
                            { name: "KETTLEBELL GOBLET SQUAT (EXPLOSIF)", desc: "TIENS UN KETTLEBELL DEVANT TA POITRINE. FAIS UN SQUAT COMPLET ET REMONTE DE MANIÈRE EXPLOSIVE.", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "8-12 KG", rest: "15 SECONDES", type: "hiit" },
                            { name: "MOUNTAIN CLIMBERS CROISÉS", desc: "EN POSITION DE PLANCHE, RAMÈNE LE GENOU DROIT VERS LE COUDE GAUCHE, PUIS LE GENOU GAUCHE VERS LE COUDE DROIT, EN ALTERNANCE RAPIDE.", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "POIDS DU CORPS", rest: "15 SECONDES", type: "hiit" },
                            { name: "SAUTS LATÉRAUX (LATERAL JUMPS)", desc: "SAUTE DE DROITE À GAUCHE RAPIDEMENT AU-DESSUS D'UNE LIGNE IMAGINAIRE OU D'UN PETIT OBJET.", sets: "1 SÉRIE", reps: "45 SECONDES", weight: "POIDS DU CORPS", rest: "15 SECONDES", type: "hiit" }
                        ]
                    }
                }
            },
            recovery: {
                name: "JOURNÉE DE RÉCUPÉRATION ACTIVE / FLEXIBILITÉ (OPTIONNEL)",
                desc: "EN PLUS DE TES JOURS DE REPOS COMPLETS, TU PEUX DÉDIER UNE JOURNÉE PAR SEMAINE À UNE ACTIVITÉ DOUCE POUR LA RÉCUPÉRATION ET LA SOUPLESSE.",
                activities: [
                    { name: "MARCHE PROLONGÉE", desc: "DANS UN PARC, EN NATURE, À UN RYTHME AGRÉABLE (45-60 MIN).", sets: "1 SÉRIE", reps: "45-60 MINUTES", weight: "N/A", rest: "N/A" },
                    { name: "SÉANCE DE YOGA DOUX OU DE PILATES", desc: "PRIVILÉGIE LES VIDÉOS EN LIGNE POUR DÉBUTANTS AXÉES SUR LA FLEXIBILITÉ ET LE RENFORCEMENT DU TRONC.", sets: "1 SÉRIE", reps: "30-45 MINUTES", weight: "N/A", rest: "N/A" },
                    { name: "ÉTIREMENTS PROFONDS", desc: "UNE SÉANCE DÉDIÉE DE 20-30 MINUTES POUR ÉTIRER TOUS LES GRANDS GROUPES MUSCULAIRES, EN MAINTENANT LES POSITIONS PLUS LONGTEMPS (30-60 SEC).", sets: "1 SÉRIE", reps: "20-30 MINUTES", weight: "N/A", rest: "N/A" },
                    { name: "NATATION LÉGÈRE", desc: "QUELQUES LONGUEURS À RYTHME TRANQUILLE POUR DÉTENDRE LES MUSCLES.", sets: "1 SÉRIE", reps: "30-45 MINUTES", weight: "N/A", rest: "N/A" }
                ]
            }
        };

        // Fonctions utilitaires pour la persistance des données dans le localStorage
        function saveToLocalStorage(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); console.log(`[LocalStorage] Données sauvegardées pour '${key}'.`); } catch (e) { console.error(`[LocalStorage] Erreur lors de la sauvegarde pour '${key}':`, e); showMessage(`ERREUR: Impossible de sauvegarder ${key}.`, 'error'); } }
        function loadFromLocalStorage(key, defaultValue) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error(`[LocalStorage] Erreur lors du chargement pour '${key}':`, e); showMessage(`ATTENTION: Données corrompues pour ${key}. Chargement par défaut.`, 'warning'); return defaultValue; } }
        function removeFromLocalStorage(key) { try { localStorage.removeItem(key); console.log(`[LocalStorage] Données supprimées pour '${key}'.`); } catch (e) { console.error(`[LocalStorage] Erreur lors de la suppression pour '${key}':`, e); showMessage(`ERREUR: Impossible de supprimer ${key}.`, 'error'); } }

        // Initialisation de l'état global de l'application au démarrage
        function initializeGlobalState() {
            console.log("[INITIALISATION] Chargement de l'état global depuis le localStorage...");
            userProfile = loadFromLocalStorage('userProfile', { height: '', weight: '', imc: null, imcCategory: '', proteinNeeds: 'N/A', currentXP: 0, earnedTrophies: [], hideExerciseHistory: false, apiKey: '', likedMeals: [], isDarkMode: false });
            if (!Array.isArray(userProfile.likedMeals)) userProfile.likedMeals = [];
            if (userProfile.isDarkMode) {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }

            weeklyMealPlan = loadFromLocalStorage('weeklyMealPlan', { semaine: [] });
            workoutLogs = loadFromLocalStorage('workoutLogs', []);
            weightHistory = loadFromLocalStorage('weightHistory', []);
            intervalSequences = loadFromLocalStorage('intervalSequences', []);
            shifts = loadFromLocalStorage('shifts', []);
            workoutProgram = loadFromLocalStorage('savedWorkoutProgram', JSON.parse(JSON.stringify(defaultWorkoutProgramStructure)));
            previousLevel = calculateLevelAndXP(userProfile.currentXP).level;
            const savedChronoState = loadFromLocalStorage('chronoState', {});
            chronoIntervals = savedChronoState.intervals || [];
            chronoCurrentTime = savedChronoState.currentTime || 0;
            chronoCurrentIntervalIndex = savedChronoState.currentIntervalIndex !== undefined ? savedChronoState.currentIntervalIndex : -1;
            isChronoRunning = savedChronoState.isRunning || false;
            isChronoPaused = savedChronoState.isPaused || false;
            enableChronoPreCountdown = savedChronoState.enablePreCountdown !== undefined ? savedChronoState.enablePreCountdown : true;
            chronoPreCountdownDuration = savedChronoState.preCountdownDuration || 10;
            if (!Array.isArray(userProfile.earnedTrophies)) userProfile.earnedTrophies = [];

            console.log("[INITIALISATION] État global chargé.");
        }

        // Met à jour l'état du chronomètre dans le localStorage
        function updateLocalStorageChronoState() { saveToLocalStorage('chronoState', { intervals: chronoIntervals, currentTime: chronoCurrentTime, currentIntervalIndex: chronoCurrentIntervalIndex, isRunning: isChronoRunning, isPaused: isChronoPaused, enablePreCountdown: enableChronoPreCountdown, preCountdownDuration: chronoPreCountdownDuration }); }

        // Affiche un message de notification à l'utilisateur
        function showMessage(msg, type = 'info') {
            const container = document.getElementById('notification-container-bottom-right');
            const notification = document.createElement('div');
            notification.className = `notification general ${type}`;
            const iconMap = { 'success': '🎉', 'error': '❌', 'warning': '⚠️', 'info': 'ℹ️', 'chrono': '⏱️', 'tip': '💡', 'ai-advice': '🧠' };
            notification.innerHTML = `<span class="text-2xl">${iconMap[type] || 'ℹ️'}</span><p class="font-bold text-sm sm:text-base">${String(msg).toUpperCase()}</p>`;
            container.appendChild(notification);
            void notification.offsetWidth; // Force reflow for animation
            notification.classList.add('show');
            const duration = type === 'trophy' ? 12000 : (type === 'tip' ? 20000 : (type === 'ai-advice' ? 15000 : 5000)); // AI advice for 15 seconds
            setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove(), { once: true }); }, duration);
        }

        // Affiche une notification de trophée débloqué
        function showTrophyNotification(trophyName, description) {
            const container = document.getElementById('notification-container-bottom-right');
            const notification = document.createElement('div');
            notification.className = 'notification general success';
            notification.innerHTML = `<span class="text-4xl">🏆</span><div><p class="font-bold text-lg sm:text-xl">TROPHÉE DÉBLOQUÉ !</p><p class="text-accent-yellow text-sm sm:text-base">${String(trophyName).toUpperCase()}</p><p class="text-secondary text-xs sm:text-sm">${String(description).toUpperCase()}</p></div>`;
            container.appendChild(notification);
            playTrophySound();
            void notification.offsetWidth; // Force reflow for animation
            setTimeout(() => { notification.classList.add('show'); }, 100);
            setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove(), { once: true }); }, 12000);
        }

        // Gestion du contexte audio pour les effets sonores
        let audioContextStartedOnce = false;
        async function initializeAudioContextNonBlocking() {
            if (Tone.context.state === 'running' || audioContextStartedOnce) return;
            try {
                await Tone.start();
                audioContextStartedOnce = true;
                isAudioActive = true;
                Tone.Master.mute = false;
                Tone.Master.volume.value = masterVolume === 0 ? -Infinity : 20 * Math.log10(masterVolume);
            } catch (e) {
                isAudioActive = false;
                Tone.Master.mute = true;
            }
        }

        // Gère le geste de l'utilisateur pour démarrer l'audio
        function handleUserGestureToStartAudio() { window.removeEventListener('click', handleUserGestureToStartAudio); window.removeEventListener('keydown', handleUserGestureToStartAudio); initializeAudioContextNonBlocking(); }

        // Configure les lecteurs audio pour les sons de l'application
        function setupAudioPlayers() {
            trophySoundPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.3 } }).toDestination();
            levelUpPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.05, sustain: 0.1, release: 0.2 } }).toDestination();
            majorLevelUpPlayer = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.6 }, volume: -6 }).toDestination();
            beepPlayer = new Tone.Oscillator(440, "sine").toDestination();
            startSoundPlayer = new Tone.PolySynth(Tone.Synth).toDestination();
            synth = window.speechSynthesis;
            Tone.Master.volume.value = masterVolume === 0 ? -Infinity : 20 * Math.log10(masterVolume);
            Tone.Master.mute = !isAudioActive;
        }

        // Active ou désactive le son de l'application
        function toggleAudioActive() {
            isAudioActive = !isAudioActive;
            if (isAudioActive) { initializeAudioContextNonBlocking(); showMessage("SON ACTIVÉ !", "success"); }
            else { Tone.Master.mute = true; showMessage("SON DÉSACTIVÉ.", "info"); }
            const mainContent = document.getElementById('main-content');
            renderOptionsView(mainContent);
        }

        // Joue le son de trophée
        function playTrophySound() { if (isAudioActive && Tone.context.state === 'running') trophySoundPlayer.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n", Tone.context.currentTime); }

        // Joue le son de montée de niveau
        function playLevelUpSound(level) {
            if (isAudioActive && Tone.context.state === 'running') {
                const now = Tone.context.currentTime;
                if (level > previousLevel) {
                    if (level % 10 === 0) majorLevelUpPlayer.triggerAttackRelease(["C4", "E4", "G4", "C5", "E5"], "2n", now);
                    else { levelUpPlayer.triggerAttackRelease("C4", "16n", now); levelUpPlayer.triggerAttackRelease("E4", "16n", now + 0.1); levelUpPlayer.triggerAttackRelease("G4", "16n", now + 0.2); levelUpPlayer.triggerAttackRelease("C5", "8n", now + 0.3); }
                }
            }
        }

        // Joue un bip sonore
        function playBeep(freq = 4, duration = 0.0) { if (isAudioActive && Tone.context.state === 'running') { beepPlayer.stop(); beepPlayer.start(Tone.context.currentTime); beepPlayer.frequency.setValueAtTime(freq, Tone.context.currentTime); beepPlayer.stop(Tone.context.currentTime + duration); } }

        // Joue un son de démarrage (type Mario Kart)
        function playMarioKartStartSound() {
            if (isAudioActive && Tone.context.state === 'running') {
                const now = Tone.context.currentTime;
                new Tone.MembraneSynth().toDestination().triggerAttackRelease("C5", "16n", now);
                new Tone.MembraneSynth().toDestination().triggerAttackRelease("E5", "16n", now);
                new Tone.MembraneSynth().toDestination().triggerAttackRelease("G5", "16n", now);
                new Tone.Synth().toDestination().triggerAttackRelease("C4", "1n", now );
            }
        }

        // Fonction pour parler avec Kodular (intégration)
        function parlerAvecKodular(texte) {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(texte);
            } else {
                console.log("KODULAR NON DÉTECTÉ, TEXTE À PRONONCER : " + texte);
            }
        }

        // Fait parler l'IA avec la synthèse vocale
        function speak(text) {
            if (!isAudioActive) return; // Ne parle que si l'audio est actif

            // Priorise l'intégration Kodular si disponible
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                parlerAvecKodular(text);
            } else if (synth) { // Repli sur la synthèse vocale du navigateur si pas dans Kodular
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                synth.speak(utterance);
            }
        }

        // Génère un identifiant unique
        function generateUniqueId() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

        // Formate une date au formatYYYY-MM-DD
        function formatDateToYYYYMMDD(date) { if (!(date instanceof Date) || isNaN(date.getTime())) return ''; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        // Retourne une chaîne de caractères décrivant le contexte du jour (poste et sport)
        function getDayContextString(shiftType, workoutType) {
            let context = "";
            const sType = String(shiftType || ''), wType = String(workoutType || '');
            switch (sType) {
                case '6h-18h': context = "Travail de Jour (6H-18H)"; break;
                case '7h-18h': context = "Travail de Jour (7H-18H)"; break;
                case '18h-6h': context = "Travail de Nuit (18H-6H)"; break;
                case 'repos': context = "Jour de Repos"; break;
                case 'repos_sport': context = "Jour de Repos (SPORT)"; break;
                default: context = "Contexte Inconnu"; break;
            }
            if (wType && wType !== 'aucun') context += ` - Sport: ${wType.toUpperCase().replace('_', ' ')}`;
            return context;
        }

        // Retourne une chaîne de caractères décrivant le moment du repas dans le contexte du jour
        function getMealMomentContext(mealType, shiftType, sportType) {
            let moment = "";
            const sType = String(shiftType || ''), spType = String(sportType || '');
            if (mealType === 'petit_dejeuner') { moment = "PETIT-DÉJEUNER"; if (sType === '18h-6h') moment += " POST-NUIT"; else if (spType !== 'aucun') moment += " PRÉ-ENTRAÎNEMENT"; }
            else if (mealType === 'dejeuner') { moment = "DÉJEUNER"; if (sType === '18h-6h') moment += " PENDANT LE POSTE DE NUIT"; else if (spType !== 'aucun') moment += " POST-ENTRAÎNEMENT"; else if (sType.includes('jour')) moment += " JOURNÉE DE TRAVAIL"; }
            else if (mealType === 'diner') { moment = "DÎNER"; if (sType === '18h-6h') moment = "PRÉ-POSTE DE NUIT"; else if (spType !== 'aucun') moment += " POST-ENTRAÎNEMENT"; else if (sType.includes('jour')) moment += " APRÈS JOURNÉE DE TRAVAIL"; }
            else if (mealType === 'collation_matin') { moment = "COLLAT. MATIN"; }
            else if (mealType === 'collation_apresmidi') { moment = "COLLAT. APRÈS-MIDI"; }
            else if (mealType === 'collation_unique') { if (sType === '18h-6h') moment = "COLLAT. PENDANT POSTE DE NUIT"; else { addMeal = false; } } // This `addMeal` here is a local variable, not global. It should be handled by the caller.
            return moment;
        }

        // Conseils spécifiques pour les repas en fonction du contexte
        const specificMealAdvice = {
            'petit_dejeuner': { '18h-6h': "CONSEIL : APRÈS UN POSTE DE NUIT, PRIVILÉGIE UN REPAS NUTRITIF POUR FAVORISER LA RÉCUPÉRATION ET UN SOMMEIL DE QUALITÉ. LES PROTÉINES ET GLUCIDES LENTS SONT CLÉS.", 'default': "CONSEIL : UN PETIT-DÉJEUNER ÉQUILIBRÉ EST ESSENTIEL POUR L'ÉNERGIE DU MATIN. VARIE LES SOURCES DE PROTÉINES ET FIBRES." },
            'dejeuner': { '18h-6h': "CONSEIL : PENDANT UN POSTE DE NUIT, OPTE POUR DES PLATS FACILES À DIGÉRER, RICHES EN PROTÉINES ET LÉGUMES POUR MAINTENIR TON ÉNERGIE SANS ALOURDIR.", 'repos_sport': "CONSEIL : APRÈS LE SPORT, RECONSTITUE TES RÉSERVES. CE REPAS DEVRAIT ÊTRE RICHE EN GLUCIDES COMPLEXES POUR L'ÉNERGIE ET LA RÉPARATION MUSCULAIRE.", 'default': "CONSEIL : POUR UN DÉJEUNER OPTIMAL EN JOURNÉE DE TRAVAIL, PRIVILÉGIE UN PLAT ÉQUILIBRÉ QUI APPORTE UNE ÉNERGIE DURABLE SANS CAUSER DE COUP DE BARRE." },
            'diner': { '18h-6h': "CONSEIL : AVANT UN POSTE DE NUIT, CHOISIS UN DÎNER CONSISTANT MAIS FACILE À DIGÉRER POUR TE DONNER L'ENERGIE NÉCESSAIRE SANS PERTURBER TON DÉBUT DE SOMMEIL PRÉ-POSTE.", 'repos_sport': "CONSEIL : LE DÎNER APRÈS UNE SÉANCE DE SPORT DOIT COMPLÉTER LA RÉCUPÉRATION. CONCENTRE-TOI SUR LES PROTÉINES POUR LA RÉPARATION ET LES GLUCIDES POUR REFAIRE LE PLEIN.", 'default': "CONSEIL : UN DÎNER LÉGER EST IDÉAL POUR FAVORISER UNE BONNE DIGESTION ET UN SOMMEIL RÉPARATEUR APRÈS UNE JOURNÉE DE TRAVAIL. PRIVILÉGIE LES LÉGUMES ET PROTÉINES MAIGRES." },
            'collation': { '6h-18h_matin': "CONSEIL : CETTE COLLATON MATINALE EST CLÉ POUR MAINTENIR TON ÉNERGIE ET ÉVITER LES BAISSES DE GLYCÉMIE JUSQU'AU DÉJEUNER.", '6h-18h_apresmidi': "CONSEIL : LA COLLATON DE L'APRÈS-MIDI AIDE À GÉRER LA FAIM ET À SOUTENIR TON ÉNERGIE JUSQU'AU DÎNER, SANS ALOURDIR AVANT LA FIN DU POSTE.", '18h-6h_pendant': "CONSEIL : UNE COLLATON PENDANT LA NUIT EST LÉGÈRE ET ÉNERGISANTE POUR MAINTENIR TA VIGILANCE SANS PERTURBER TA DIGESTION.", '7h-18h_apresmidi': "CONSEIL : LA COLLATON DE L'APRÈS-MIDI EST PARFAITE POUR SOUTENIR SON ÉNERGIE LORS DES JOURS DE LONG POSTE OU DE REPOS ACTIF.", 'repos_sport_post': "CONSEIL : UNE COLLATON POST-SPORT EST CRUCIALE POUR UNE RÉCUPÉRATION RAPIDE. PRIVILÉGIE UN MIX DE PROTÉINES ET GLUCIDES.", 'repos_default': "CONSEIL : UNE COLLATON LÉGÈRE EN JOUR DE REPOS PEUT AIDER À GÉRER LA FAIM ET APPORTER DES NUTRIENTS SUPPLÉMENTAIRES." }
        };

        // Calcule les seuils d'XP pour chaque niveau
        function getLevelThresholds(level) {
            if (level === 0) return { current: 0, next: 100 };
            let xp = 0;
            for (let i = 1; i <= level; i++) xp += (i * 50 + 50);
            const prevLevelThreshold = xp - (level * 50 + 50);
            return { current: prevLevelThreshold, next: xp };
        }

        // Calcule le niveau actuel et l'XP restante pour le niveau suivant
        function calculateLevelAndXP(totalXP) {
            let level = 0;
            let xpNeededForCurrentLevel = 0;
            let xpNeededForNextLevel = 100;

            while (totalXP >= xpNeededForNextLevel) {
                level++;
                xpNeededForCurrentLevel = xpNeededForNextLevel;
                xpNeededForNextLevel = Math.round(100 + (level * 50 * (1 + level / 10)));
            }

            const xpProgressInCurrentLevel = totalXP - xpNeededForCurrentLevel;
            const xpForThisLevel = xpNeededForNextLevel - xpNeededForCurrentLevel;
            const xpRemainingForNextLevel = xpForThisLevel - xpProgressInCurrentLevel;

            return { level: level, xpCurrentLevel: xpProgressInCurrentLevel, xpForThisLevel: xpForThisLevel, xpToNextLevel: xpRemainingForNextLevel };
        }

        // Initialise l'application au démarrage
        async function initializeApp() {
            setupAudioPlayers();
            initializeGlobalState();
            updateXPBar();
            updateProfileDisplay();
            userId = 'local_user';
            document.getElementById('user-id-value').textContent = userId;
            document.getElementById('user-id-display').classList.remove('hidden');
            renderPage(currentPage);
            attachEventListeners();
            renderLucideIcons();
            window.addEventListener('click', handleUserGestureToStartAudio, { once: true });
            window.addEventListener('keydown', handleUserGestureToStartAudio, { once: true });
            initializeAudioContextNonBlocking();
        }

        // Rend la page principale en fonction du nom de la page
        function renderPage(pageName) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            if (weightChartInstance) { weightChartInstance.destroy(); weightChartInstance = null; }
            if (exerciseChartInstance) { exerciseChartInstance.destroy(); exerciseChartInstance = null; }

            document.querySelectorAll('.nav-item').forEach(button => {
                const isActive = button.dataset.page === pageName;
                button.classList.toggle('active', isActive); /* Use 'active' class for styling */
                button.classList.toggle('text-secondary', !isActive);
                button.classList.toggle('hover:bg-gray-700', !isActive); /* This will be handled by CSS variables now */
                button.classList.toggle('hover:text-accent-yellow', !isActive);
            });

            currentPage = pageName;

            switch (pageName) {
                case 'daily_plan': renderDailyPlanView(mainContent); break;
                case 'workout': renderWorkoutView(mainContent); break;
                case 'recipes': renderRecipeView(mainContent); break;
                case 'chrono': renderChronoIntervalleView(mainContent); break;
                case 'progress': renderProgressView(mainContent); break;
                case 'trophies': renderTrophyRoomView(mainContent); break;
                case 'options': renderOptionsView(mainContent); break;
                default: renderDailyPlanView(mainContent); break;
            }
            renderLucideIcons();
        }

        // Met à jour la barre d'expérience (XP) et le niveau de l'utilisateur
        function updateXPBar() {
            const { level, xpCurrentLevel, xpForThisLevel } = calculateLevelAndXP(userProfile.currentXP);
            const progressBar = document.getElementById('xp-bar-fill');
            const progressText = document.getElementById('xp-bar-text');

            const progressPercentage = xpForThisLevel > 0 ? (xpCurrentLevel / xpForThisLevel) * 100 : 0;
            const actualProgress = Math.max(0, Math.min(100, progressPercentage));

            if (level > previousLevel) {
                playLevelUpSound(level);
                showMessage(`FÉLICITATIONS, VOUS AVEZ ATTEINT LE NIVEAU ${level} !`, 'success');
                speak(`Felicitations, vous avez atteint le niveau ${level} !`);
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                void progressBar.offsetWidth; // Trigger reflow
                setTimeout(() => { progressBar.style.transition = 'width 0.5s ease-in-out, background 0.5s ease-in-out'; progressBar.style.width = `${actualProgress}%`; }, 150);
            } else {
                progressBar.style.transition = 'width 0.5s ease-in-out, background 0.5s ease-in-out';
                progressBar.style.width = `${actualProgress}%`;
            }
            progressText.textContent = `LVL ${level} : ${xpCurrentLevel}/${xpForThisLevel} XP`;
            previousLevel = level;
            checkAndAwardTrophies(level);
        }

        // Vérifie si des trophées ont été gagnés et les attribue
        function checkAndAwardTrophies(currentLevel) {
            let earnedTrophies = userProfile.earnedTrophies || [], newTrophiesEarned = [];
            allTrophies.forEach(trophy => {
                if (currentLevel >= trophy.levelRequired && !earnedTrophies.some(t => t.id === trophy.id)) {
                    newTrophiesEarned.push(trophy);
                    earnedTrophies.push({ id: trophy.id, name: trophy.name, description: trophy.description, levelRequired: trophy.levelRequired, timestamp: new Date().toISOString() });
                }
            });
            if (newTrophiesEarned.length > 0) {
                userProfile.earnedTrophies = earnedTrophies;
                saveToLocalStorage('userProfile', userProfile);
                newTrophiesEarned.forEach(trophy => showTrophyNotification(trophy.name, trophy.description));
                if (currentPage === 'trophies') renderTrophyRoomView(document.getElementById('main-content'));
            }
        }

        // Met à jour l'affichage du profil utilisateur
        function updateProfileDisplay() {
            const heightInput = document.getElementById('userHeight');
            const weightInput = document.getElementById('userWeight');
            const imcDisplay = document.getElementById('imc-display');
            const imcValue = document.getElementById('imc-value');
            const imcCategory = document.getElementById('imc-category');
            const proteinNeeds = document.getElementById('protein-needs');

            heightInput.value = userProfile.height;
            weightInput.value = userProfile.weight;

            if (userProfile.imc && userProfile.imcCategory && userProfile.proteinNeeds) {
                imcValue.textContent = userProfile.imc;
                imcCategory.textContent = userProfile.imcCategory;
                proteinNeeds.textContent = `${userProfile.proteinNeeds} G/JOUR`;
                imcDisplay.classList.remove('hidden');
            } else {
                imcDisplay.classList.add('hidden');
            }
        }

        // Gère la sauvegarde du profil utilisateur (taille, poids, IMC)
        async function handleSaveProfile() {
            const height = document.getElementById('userHeight').value;
            const weight = document.getElementById('userWeight').value;

            if (!height || !weight) { showMessage("ERREUR: TAILLE ET POIDS REQUIS POUR L'IMC.", 'error'); return; }

            const currentHeight = parseFloat(height);
            const currentWeight = parseFloat(weight);
            const currentImc = (currentWeight / ( (currentHeight / 100) * (currentHeight / 100) )).toFixed(2);

            let currentImcCategory;
            const imcVal = parseFloat(currentImc);
            const imcCategories = [
                { threshold: 16.5, category: 'INSUFFISANCE PONDÉRALE (DÉNUTRITION SÉVÈRE)' },
                { threshold: 18.5, category: 'INSUFFISANCE PONDÉRALE' },
                { threshold: 25, category: 'POIDS NORMAL' },
                { threshold: 27, category: 'SURPOIDS (PRÉ-OBÉSITÉ)' },
                { threshold: 30, category: 'OBÉSITÉ MODÉRÉE' },
                { threshold: 35, category: 'OBÉSITÉ CLASSE I' },
                { threshold: 40, category: 'OBÉSITÉ CLASSE II (SÉVÈRE)' },
                { threshold: Infinity, category: 'OBÉSITÉ CLASSE III (MORBIDE OU MASSIVE)' }
            ];
            for (const cat of imcCategories) { if (imcVal < cat.threshold) { currentImcCategory = cat.category; break; } }

            const proteinMultiplier = 1.6;
            const currentProteinNeeds = (currentWeight * proteinMultiplier).toFixed(0);

            let newXP = userProfile.currentXP;
            const oldWeight = parseFloat(userProfile.weight) || 0;
            const oldImcCategory = userProfile.imcCategory || '';

            if (oldWeight > 0 && currentWeight !== oldWeight) {
                const weightDiff = oldWeight - currentWeight;
                const oldImcIndex = imcCategories.findIndex(c => c.category === oldImcCategory);
                const currentImcIndex = imcCategories.findIndex(c => c.category === currentImcCategory);

                if (currentImcIndex < oldImcIndex) { newXP += 50; showMessage(`XP GAGNÉE: AMÉLIORATION DE L'IMC !`, 'success'); }
                else if (currentImcIndex > oldImcIndex) { newXP = Math.max(0, newXP - 30); showMessage(`XP PERDUE: DÉTÉRIORATION DE L'IMC.`, 'warning'); }

                if (currentImcCategory === 'POIDS NORMAL') {
                    if (!oldImcCategory.includes('POIDS NORMAL')) { newXP += 100; showMessage(`XP GAGNÉE: ENTRÉE DANS LA CATÉGORIE DE POIDS NORMAL !`, 'success'); }
                    else { newXP += 5; showMessage(`XP GAGNÉE: MAINTIEN DANS LA CATÉGORIE DE POIDS NORMAL !`, 'success'); }
                } else if (currentImcCategory.includes('INSUFFISANCE PONDÉRALE') && weightDiff < 0) { newXP += Math.round(Math.abs(weightDiff) * 10); showMessage(`XP GAGNÉE: PRISE DE POIDS VERS LA NORMALITÉ !`, 'success'); }
                else if ((currentImcCategory.includes('SURPOIDS') || currentImcCategory.includes('OBÉSITÉ')) && weightDiff > 0) { newXP += Math.round(weightDiff * 10); showMessage(`XP GAGNÉE: PERTE DE POIDS VERS LA NORMALITÉ !`, 'success'); }
                else if (currentImcCategory.includes('INSUFFISANCE PONDÉRALE') && weightDiff > 0) { newXP = Math.max(0, newXP - Math.round(Math.abs(weightDiff) * 5)); showMessage(`XP PERDUE: PERTE DE POIDS À PARTIR DE LA NORMALITÉ !`, 'warning'); }
                else if ((currentImcCategory.includes('SURPOIDS') || currentImcCategory.includes('OBÉSITÉ')) && weightDiff < 0) { newXP = Math.max(0, newXP - Math.round(Math.abs(weightDiff) * 5)); showMessage(`XP PERDUE: PRISE DE POIDS À PARTIR DE LA NORMALITÉ !`, 'warning'); }
            }

            userProfile = { ...userProfile, height: currentHeight, weight: currentWeight, imc: currentImc, imcCategory: currentImcCategory, proteinNeeds: currentProteinNeeds, currentXP: newXP, updatedAt: new Date().toISOString() };
            saveToLocalStorage('userProfile', userProfile);
            updateProfileDisplay();
            updateXPBar();

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const todayFormatted = formatDateToYYYYMMDD(today);

            const existingEntryIndex = weightHistory.findIndex(entry => formatDateToYYYYMMDD(new Date(entry.date)) === todayFormatted);

            if (existingEntryIndex !== -1) {
                // Update existing entry for today
                weightHistory[existingEntryIndex] = {
                    ...weightHistory[existingEntryIndex],
                    weight: currentWeight,
                    imc: currentImc,
                    imcCategory: currentImcCategory,
                    timestamp: new Date().toISOString()
                };
            } else {
                // Add new entry
                weightHistory.push({
                    id: generateUniqueId(),
                    date: new Date().toISOString(),
                    weight: currentWeight,
                    imc: currentImc,
                    imcCategory: currentImcCategory,
                    timestamp: new Date().toISOString()
                });
            }
            saveToLocalStorage('weightHistory', weightHistory);

            if (currentPage === 'progress') renderProgressView(document.getElementById('main-content'));
        }

        // Rend la vue du planning quotidien
        function renderDailyPlanView(container) {
            let html = `<div class="card-retro mb-6"><h2 class="text-3xl sm:text-4xl font-bold text-accent-yellow mb-4 text-center">MON PLANNING</h2><div class="mb-6 space-y-4 p-4 rounded-lg border-2 border-primary card-bg-blue-border"><h3 class="text-xl sm:text-2xl text-accent-yellow mb-3">AJOUTER UN POSTE :</h3><div class="relative"><label for="shiftDate" class="block text-secondary text-sm font-bold mb-2">DATE DU POSTE :</label><input type="date" id="shiftDate" class="input-retro pr-10" style="color: var(--color-text-primary);" value="" /><i data-lucide="calendar" class="absolute right-11 top-12 -translate-y-1/2 text-primary pointer-events-none" style="width:15px; height:18px;"></i></div><div><label for="shiftType" class="block text-secondary text-sm font-bold mb-2">TYPE DE POSTE :</label><select id="shiftType" class="select-retro"><option value="6h-18h">POSTE JOUR (6H-18H)</option><option value="7h-18h">POSTE JOUR (7H-18H)</option><option value="18h-6h">POSTE NUIT (18H-6H)</option><option value="repos">JOUR DE REPOS</option><option value="repos_sport">JOUR DE REPOS (SPORT)</option></select></div><div><label for="workoutType" class="block text-secondary text-sm font-bold mb-2">SÉANCE SPORT PRÉVUE :</label><select id="workoutType" class="select-retro"><option value="aucun">AUCUNE</option><option value="renforcement">RENFORCEMENT MUSCULAIRE</option><option value="cardio">CARDIO</option><option value="hiit">HIIT</option><option value="repos_actif">RÉCUPÉRATION ACTIVE / FLEXIBILITÉ</option></select></div><button id="add-shift-btn" class="btn-retro w-full">AJOUTER POSTE</button></div><h3 class="text-xl sm:text-2xl text-accent-yellow mb-3">TON PLAN POUR LES JOURS PLANIFIÉS :</h3><div id="shifts-list" class="space-y-6"></div></div>`;
            container.innerHTML = html;

            const shiftDateInput = document.getElementById('shiftDate');
            const shiftTypeSelect = document.getElementById('shiftType');
            const workoutTypeSelect = document.getElementById('workoutType');
            const addShiftBtn = document.getElementById('add-shift-btn');
            const shiftsListDiv = document.getElementById('shifts-list');

            addShiftBtn.onclick = async () => {
                const date = shiftDateInput.value;
                const type = shiftTypeSelect.value;
                const workout = workoutTypeSelect.value;

                if (!date || !type) { showMessage("ERREUR: DATE ET TYPE DE POSTE REQUIS.", 'error'); return; }

                const dateObj = new Date(date);
                dateObj.setHours(0, 0, 0, 0); // Normalize to start of day

                if (shifts.some(s => formatDateToYYYYMMDD(new Date(s.date)) === formatDateToYYYYMMDD(dateObj))) { showMessage("ERREUR: POSTE DÉJÀ ENREGISTRÉ POUR CETTE DATE.", 'error'); return; }

                shifts.push({ id: generateUniqueId(), date: dateObj.toISOString(), type: type, workoutType: workout, createdAt: new Date().toISOString() });
                saveToLocalStorage('shifts', shifts);
                showMessage("SUCCÈS: POSTE AJOUTÉ !", 'success');

                shiftDateInput.value = '';
                workoutTypeSelect.value = 'aucun';
                renderDailyPlanView(container);
            };

            renderShiftsList(shiftsListDiv, shifts);
        }

        // Rend la liste des postes planifiés
        function renderShiftsList(container, shiftsData) {
            container.innerHTML = '';
            if (shiftsData.length === 0) { container.innerHTML = '<p class="text-tertiary">AUCUN POSTE ENREGISTRÉ. AJOUTE TON PREMIER POSTE CI-DESSOUS !</p>'; return; }

            const sortedShifts = [...shiftsData].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            sortedShifts.forEach(shift => {
                const dateObj = new Date(shift.date);
                const dateString = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
                const routine = sleepRoutines[String(shift.type)] || sleepRoutines['repos'];
                const mealForThisDay = weeklyMealPlan?.semaine?.find(d => d.date === formatDateToYYYYMMDD(dateObj));

                const shiftDiv = document.createElement('div');
                shiftDiv.className = "card-bg-purple-border p-4 rounded-lg shadow-lg";
                shiftDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <h4 class="text-lg sm:text-xl font-bold text-accent-yellow">${dateString} - POSTE: ${String(shift.type).toUpperCase()}</h4>
                        <button class="btn-retro-red text-sm px-3 py-1 mt-2 sm:mt-0 delete-shift-btn" data-id="${shift.id}" data-date="${formatDateToYYYYMMDD(dateObj)}">SUPPRIMER</button>
                    </div>
                    ${String(shift.workoutType) !== 'aucun' ? `<div class="mb-3 p-2 bg-blue-active rounded-md border border-accent-purple-light"><p class="text-sm sm:text-base font-medium text-primary">SÉANCE SPORT : ${String(shift.workoutType).toUpperCase().replace('_', ' ')} PRÉVUE</p></div>` : ''}
                    <div class="mb-4">
                        <h5 class="font-semibold text-base sm:text-lg text-accent-yellow mb-2">💤 ROUTINE SOMMEIL : ${String(routine.name).toUpperCase()}</h5>
                        <ul class="list-disc list-inside text-secondary text-sm space-y-1">
                            ${routine.details.map(detail => `<li>${String(detail).toUpperCase()}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h5 class="font-semibold text-base sm:text-lg text-accent-yellow mb-2">🍽️ PLAN REPAS SUGGÉRÉ :</h5>
                        ${mealForThisDay ? `
                            <ul class="list-disc list-inside text-secondary text-sm space-y-1">
                                ${mealForThisDay.petit_dejeuner ? `<li>**PETIT-DÉJEUNER :** ${String(mealForThisDay.petit_dejeuner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.dejeuner ? `<li>**DÉJEUNER :** ${String(mealForThisDay.dejeuner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.diner ? `<li>**DÎNER :** ${String(mealForThisDay.diner.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_matin ? `<li>**COLLAT. MATIN :** ${String(mealForThisDay.collation_matin.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_apresmidi ? `<li>**COLLAT. APRÈS-MIDI :** ${String(mealForThisDay.collation_apresmidi.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                                ${mealForThisDay.collation_unique ? `<li>**COLLAT. UNIQUE :** ${String(mealForThisDay.collation_unique.title || 'TITRE INDISPONIBLE').toUpperCase()}</li>` : ''}
                            </ul>
                        ` : `<p class="text-tertiary">PLAN DE REPAS NON DISPONIBLE POUR CE JOUR. GÉNÉREZ UN PLAN HEBDOMADAIRE DANS L'ONGLET "RECETTES".</p>`}
                    </div>
                `;
                container.appendChild(shiftDiv);
            });

            container.querySelectorAll('.delete-shift-btn').forEach(button => {
                button.onclick = async (event) => {
                    const idToDelete = event.target.dataset.id;
                    const dateToDelete = event.target.dataset.date;
                    if (await showConfirmModal("CONFIRMER LA SUPPRESSION DU POSTE ET DE SON PLAN DE REPAS ASSOCIÉ ?")) {
                        shifts = shifts.filter(s => s.id !== idToDelete);
                        saveToLocalStorage('shifts', shifts);
                        if (weeklyMealPlan && weeklyMealPlan.semaine) {
                            weeklyMealPlan.semaine = weeklyMealPlan.semaine.filter(dayData => dayData.date !== dateToDelete);
                            saveToLocalStorage('weeklyMealPlan', weeklyMealPlan);
                        }
                        showMessage("SUCCÈS: POSTE ET REPAS ASSOCIÉS SUPPRIMÉS !", 'success');
                        renderDailyPlanView(document.getElementById('main-content'));
                        renderRecipeView(document.getElementById('main-content')); // Re-render recipe view to update meal plan display
                    }
                };
            });
        }

        // Rend la vue du programme sportif
        function renderWorkoutView(container) {
            let html = `<div class="card-retro mb-6"><h2 class="text-3xl sm:text-4xl font-bold text-accent-yellow mb-4 text-center">PROGRAMME SPORTIF</h2><div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border"><h3 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">LIGNES DIRECTRICES SPORTIVES :</h3><ul class="list-disc list-inside text-secondary text-sm sm:text-base space-y-1"><li>ÉCOUTE TON CORPS : AVEC LA SCLÉROSE EN PLAQUES ET TES HORAIRES DE TRAVAIL, LA FATIGUE PEUT VARIER. SI TU TE SENS MOINS EN FORME, RÉDUIS L'INTENSITÉ, LE NOMBRE DE SÉRIES, OU OPTE POUR UNE SÉANCE PLUS LÉGÈRE OU DU REPOS ACTIF. NE FORCE JAMAIS LA DOULEUR.</li><li>LA FORME AVANT LA CHARGE : CONCENTRE-TOI SUR L'EXÉCUTION CORRECTE DE CHAQUE MOUVEMENT POUR MAXIMISER L'EFFICACITÉ ET PRÉVENIR LES BLESSURES. UNE BONNE TECHNIQUE EST PLUS IMPORTANTE QUE DE SOULEVER LOURD.</li><li>PROGRESSION PROGRESSIVE : L'OBJECTIF EST D'AMÉLIORER TES PERFORMANCES AU FIL DES SEMAINES. LORSQUE TU PEUX RÉALISER FACILEMENT LE MAXIMUM DE RÉPÉTITIONS/SÉRIES AVEC UNE BONNE FORME, AUGMENTE LÉGÈREMENT LA CHARGE (PAR PALIERS DE 2KG POUR LES HALTÈRES, OU 2.5KG/5KG POUR LES MACHINES) OU LE NOMBRE DE RÉPÉTITIONS.</li><li>HYDRATATION : BOIS DE L'EAU RÉGULIÈREMENT AVANT, PENDANT ET APRÈS CHAQUE SÉANCE.</li></ul></div><div class="mb-6 mt-6"><label for="phaseSelect" class="block text-secondary text-sm font-bold mb-2">CHOISIR UNE PHASE :</label><select id="phaseSelect" class="select-retro"><option value="phase1">${String(workoutProgram.phase1?.name || 'PHASE 1').toUpperCase()}</option><option value="phase2">${String(workoutProgram.phase2?.name || 'PHASE 2').toUpperCase()}</option></select></div><div id="workout-phase-content" class="space-y-6"></div></div>`;
            container.innerHTML = html;

            const phaseSelect = document.getElementById('phaseSelect');
            const workoutPhaseContent = document.getElementById('workout-phase-content');

            let selectedPhase = loadFromLocalStorage('selectedWorkoutPhase', 'phase1');
            if (!workoutProgram[selectedPhase]) selectedPhase = 'phase1'; // Fallback if saved phase is invalid
            saveToLocalStorage('selectedWorkoutPhase', selectedPhase); // Save validated phase

            phaseSelect.value = selectedPhase;

            function renderPhaseContent(phase) {
                const currentPhaseData = workoutProgram[phase];
                if (!currentPhaseData || !currentPhaseData.sessions || !currentPhaseData.sessions.main || !currentPhaseData.sessions.cardio || !currentPhaseData.sessions.hiit) {
                    workoutPhaseContent.innerHTML = '<p class="text-tertiary text-center">CONTENU DE LA PHASE INDISPONIBLE. VEUILLEZ IMPORTER UN PROGRAMME VALIDE ET COMPLET.</p>';
                    return;
                }

                const generateExerciseHtml = (ex, index) => `
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 rounded-md border-2 border-primary card-bg-blue-border">
                        <div class="flex-1">
                            <p class="font-medium text-primary text-base sm:text-lg">${index + 1}. ${String(ex.name).toUpperCase()}</p>
                            <p class="text-sm text-tertiary italic">${String(ex.desc).toUpperCase()}</p>
                            ${ex.sets ? `<p class="text-xs text-accent-blue-light">SÉRIES/ROUNDS : ${String(ex.sets).toUpperCase()}</p>` : ''}
                            ${ex.reps ? `<p class="text-xs text-accent-blue-light">RÉPÉTITIONS/DURÉE : ${String(ex.reps).toUpperCase()}</p>` : ''}
                            ${ex.weight && ex.weight !== 'N/A' ? `<p class="text-xs text-accent-blue-light">POIDS SUGGÉRÉ : ${String(ex.weight).toUpperCase()}</p>` : ''}
                            ${ex.rest && ex.rest !== 'N/A' ? `<p class="text-xs text-accent-yellow">TEMPS DE REPOS : ${String(ex.rest).toUpperCase()}</p>` : ''}
                        </div>
                        <button class="btn-retro-green text-sm px-4 py-2 mt-2 sm:mt-0 log-workout-btn" data-exercise-name="${ex.name}" data-exercise-type="${ex.type}">ENREGISTRER</button>
                    </div>
                `;

                let phaseHtml = `
                    <h3 class="text-xl sm:text-2xl font-bold text-accent-blue-light">${String(currentPhaseData.name).toUpperCase()}</h3>
                    <div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">ÉCHAUFFEMENT (10-15 MIN) :</h4>
                        <ul class="list-disc list-inside text-secondary text-sm sm:text-base mb-4 space-y-1">
                            <li>**CARDIO LÉGER (5-7 MIN):** TAPIS (MARCHE RAPIDE 5.0 KM/H, PENTE 1.0) OU VÉLO/ELLIPTIQUE (NIVEAU 3-5).</li>
                            <li>**MOBILISATIONS ARTICULAIRES DYNAMIQUES (5-8 MIN):** CERCLES DE BRAS, ROTATIONS DU TRONC, FENTES (SANS CHARGE), ROTATIONS DE HANCHES, CERCLES DE CHEVILLES ET DE POIGNETS (10-15 RÉPÉTITIONS DE CHAQUE).</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">${String(currentPhaseData.sessions.main.name).toUpperCase()}</h4>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-accent-blue-light">CORPS DE SÉANCE (40-50 MINUTES) :</h5>
                        <div class="space-y-3">
                            ${currentPhaseData.sessions.main.exercises.map(generateExerciseHtml).join('')}
                        </div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-accent-blue-light">RÉCUPÉRATION (5-10 MIN) :</h5>
                        <ul class="list-disc list-inside text-secondary text-sm sm:text-base space-y-1">
                            <li>**ÉTIREMENTS DOUX :** MAINTIENS CHAQUE ÉTIREMENT PENDANT 20-30 SECONDES, SANS DOULEUR. CONCENTRE-TOI SUR LES ISCHIO-JAMBIERS, QUADRICÈPES, PECTORAUX, DOS, ÉPAULES ET BRAS.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">${String(currentPhaseData.sessions.cardio.name).toUpperCase()}</h4>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-accent-blue-light">CORPS DE SÉANCE (35-45 MINUTES) :</h5>
                        <div class="space-y-3">
                            ${currentPhaseData.sessions.cardio.options.map(generateExerciseHtml).join('')}
                        </div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-accent-blue-light">RÉCUPÉRATION (5-10 MIN) :</h5>
                        <ul class="list-disc list-inside text-secondary text-sm sm:text-base space-y-1">
                            <li>**ÉTIREMENTS DOUX :** MAINTIENS CHAQUE ÉTIREMENT PENDANT 20-30 SECONDES, SANS DOULEUR. CONCENTRE-TOI SUR LES ISCHIO-JAMBIERS, QUADRICÈPES, PECTORAUX, DOS, ÉPAULES ET BRAS.</li>
                        </ul>
                    </div>
                    <div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border mt-4">
                        <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">${String(currentPhaseData.sessions.hiit.name).toUpperCase()}</h4>
                        <p class="text-sm sm:text-base text-secondary mb-4">${String(currentPhaseData.sessions.hiit.desc).toUpperCase()}</p>
                        <h5 class="font-medium text-lg sm:text-xl mb-2 text-accent-blue-light">CORPS DE SÉANCE (20-25 MINUTES) :</h5>
                        <div class="space-y-3">
                            ${currentPhaseData.sessions.hiit.exercises.map(generateExerciseHtml).join('')}
                        </div>
                        <h5 class="font-medium text-lg sm:text-xl mt-4 mb-2 text-accent-blue-light">RÉCUPÉRATION (5-10 MIN) :</h5>
                        <ul class="list-disc list-inside text-secondary text-sm space-y-1">
                            <li>**RETOUR AU CALME :** MARCHE LÉGÈRE ET RESPIRATION PROFONDE.</li>
                            <li>**ÉTIREMENTS DOUX :** AXÉS SUR LES MUSCLES PRINCIPAUX SOLLICITÉS.</li>
                        </ul>
                    </div>
                `;

                if (workoutProgram.recovery) {
                    phaseHtml += `
                        <div class="p-4 rounded-lg border-2 border-secondary card-bg-purple-border mt-4">
                            <h4 class="font-semibold text-xl sm:text-2xl mb-3 text-accent-yellow">${String(workoutProgram.recovery.name).toUpperCase()}</h4>
                            <p class="text-sm sm:text-base text-secondary mb-4">${String(workoutProgram.recovery.desc).toUpperCase()}</p>
                            <ul class="list-disc list-inside text-secondary text-sm sm:text-base space-y-1">
                                ${workoutProgram.recovery.activities.map(act => `<li>**${String(act.name).toUpperCase()} :** ${String(act.desc).toUpperCase()}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                workoutPhaseContent.innerHTML = phaseHtml;
                renderLucideIcons(); // Ensure icons are rendered after content is added

                workoutPhaseContent.querySelectorAll('.log-workout-btn').forEach(button => {
                    button.onclick = (event) => {
                        const exerciseName = event.target.dataset.exerciseName;
                        const exerciseType = event.target.dataset.exerciseType;
                        showLogWorkoutModal({ name: exerciseName, type: exerciseType });
                    };
                });
            }

            phaseSelect.onchange = (event) => {
                selectedPhase = event.target.value;
                saveToLocalStorage('selectedWorkoutPhase', selectedPhase);
                renderPhaseContent(selectedPhase);
            };

            renderPhaseContent(selectedPhase);
        }

        // Affiche la modale pour enregistrer un entraînement
        function showLogWorkoutModal(currentExercise) {
            let modalHtml = `
                <div id="log-workout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 font-vt323">
                    <div class="card-retro p-6 rounded-lg border-4 border-secondary shadow-xl w-full max-w-md text-primary">
                        <h3 class="text-2xl sm:text-3xl font-bold text-accent-yellow mb-4 text-center">ENREGISTRER L'ENTRAÎNEMENT</h3>
                        <p class="text-lg sm:text-xl mb-4 text-center">${String(currentExercise?.name).toUpperCase()}</p>
                        <div class="space-y-4">
                            <div>
                                <label for="logSets" class="block text-secondary text-sm font-bold mb-2">SÉRIES / ROUNDS :</label>
                                <input type="text" id="logSets" class="input-retro" placeholder="EX: 3 ou 5 ROUNDS" />
                            </div>
                            <div>
                                <label for="logReps" class="block text-secondary text-sm font-bold mb-2">RÉPÉTITIONS / DURÉE :</label>
                                <input type="text" id="logReps" class="input-retro" placeholder="EX: 12 ou 30 MIN" />
                            </div>
                            <div>
                                <label for="logWeight" class="block text-secondary text-sm font-bold mb-2">POIDS (KG, LAISSER VIDE SI NON APPLICABLE) :</label>
                                <input type="number" id="logWeight" class="input-retro" placeholder="EX: 50" />
                            </div>
                            <div>
                                <label for="logFeeling" class="block text-secondary text-sm font-bold mb-2">RESSENTI :</label>
                                <select id="logFeeling" class="select-retro">
                                    <option value="facile">FACILE</option>
                                    <option value="moyen">MOYEN</option>
                                    <option value="difficile">DIFFICILE</option>
                                </select>
                            </div>
                            <div>
                                <label for="logNotes" class="block text-secondary text-sm font-bold mb-2">NOTES (OPTIONNEL) :</label>
                                <textarea id="logNotes" class="input-retro h-24" placeholder="Ajoutez des notes sur votre séance..."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button id="cancel-log-btn" class="btn-retro-red">ANNULER</button>
                            <button id="confirm-log-btn" class="btn-retro-green">ENREGISTRER</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('global-modals-container').innerHTML = modalHtml;

            const modal = document.getElementById('log-workout-modal');
            modal.querySelector('#cancel-log-btn').onclick = () => modal.remove();
            modal.querySelector('#confirm-log-btn').onclick = async () => {
                const sets = modal.querySelector('#logSets').value;
                const reps = modal.querySelector('#logReps').value;
                const weight = modal.querySelector('#logWeight').value;
                const feeling = modal.querySelector('#logFeeling').value;
                const notes = modal.querySelector('#logNotes').value;

                if (!sets || !reps) {
                    showMessage("SÉRIES/ROUNDS ET RÉPÉTITIONS/DURÉE SONT REQUIS.", 'error');
                    return;
                }

                const newLog = {
                    id: generateUniqueId(),
                    date: new Date().toISOString(),
                    exerciseName: currentExercise.name,
                    exerciseType: currentExercise.type,
                    sets: sets,
                    reps: reps,
                    weight: weight ? parseFloat(weight) : null,
                    feeling: feeling,
                    notes: notes
                };
                workoutLogs.push(newLog);
                saveToLocalStorage('workoutLogs', workoutLogs);

                // Gagner de l'XP pour l'entraînement
                let xpGain = 20; // Base XP for logging a workout
                if (feeling === 'facile') xpGain += 10;
                else if (feeling === 'moyen') xpGain += 5;
                userProfile.currentXP += xpGain;
                saveToLocalStorage('userProfile', userProfile);
                updateXPBar();

                showMessage("ENTRAÎNEMENT ENREGISTRÉ ! XP GAGNÉE.", 'success');
                modal.remove();
                if (currentPage === 'progress') renderProgressView(document.getElementById('main-content'));

                // Generate AI advice
                await generateWorkoutAdvice(newLog);
            };
        }

        // Generate AI advice for workout
        async function generateWorkoutAdvice(workoutLog) {
            const apiKey = userProfile.apiKey || "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Debugging API key and URL
            console.log(`[API KEY DEBUG] Using API Key: ${apiKey ? 'Provided (length: ' + apiKey.length + ')' : 'Empty (expecting Canvas injection)'}`);
            console.log(`[API KEY DEBUG] API URL: ${apiUrl}`);

            const userHeight = userProfile.height;
            const userWeight = userProfile.weight;
            const userImc = userProfile.imc;
            const userImcCategory = userProfile.imcCategory;
            const userProteinNeeds = userProfile.proteinNeeds;

            const prompt = `
            Génère un conseil personnalisé pour l'utilisateur suite à son entraînement.
            L'utilisateur est Gérard Chanot, pseudo Waeky, agent de sécurité avec une sclérose en plaques rémittente progressive bien gérée.
            Il a des postes de 11h-12h, répartis en 3 types (6h-18h, 18h-6h, 7h-18h), avec 12-15 postes par mois.
            Son profil actuel: Taille: ${userProfile.height}cm, Poids: ${userProfile.weight}kg, IMC: ${userProfile.imc} (${userProfile.imcCategory}), Besoins en protéines: ${userProfile.proteinNeeds}g/jour.

            Détails de l'entraînement enregistré:
            - Exercice: ${workoutLog.exerciseName} (Type: ${workoutLog.exerciseType})
            - Séries/Rounds: ${workoutLog.sets}
            - Répétitions/Durée: ${workoutLog.reps}
            - Poids utilisé: ${workoutLog.weight ? workoutLog.weight + ' KG' : 'N/A'}
            - Ressenti: ${workoutLog.feeling}
            - Notes de l'utilisateur: ${workoutLog.notes || 'Aucune'}

            En te basant sur ces informations et son profil (en particulier la SEP et les horaires de travail), donne un conseil concis et motivant.
            Le conseil doit être direct, sans fioritures ni introduction de conversation.
            Adapte le conseil au ressenti :
            - Si "facile": Suggère une légère augmentation de l'intensité ou du volume pour la prochaine fois, ou de varier l'exercice.
            - Si "moyen": Encourage la constance et la bonne forme, et de maintenir l'intensité.
            - Si "difficile": Rappelle l'importance de l'écoute du corps, du repos, de l'hydratation, et de ne pas hésiter à réduire l'intensité si la fatigue liée à la SEP est présente.
            - Mentionne brièvement son rôle d'agent de sécurité et la SEP si pertinent pour le conseil.

            Le conseil doit être court (max 2-3 phrases) et uniquement le texte du conseil, sans préambule ni salutations.
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "text/plain"
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const adviceText = result.candidates[0].content.parts[0].text;
                    showMessage(`CONSEIL DE POXEL : ${adviceText}`, 'ai-advice');
                    speak(`Conseil de Poxel : ${adviceText}`);
                } else {
                    showMessage("Poxel n'a pas pu générer de conseil pour le moment.", 'warning');
                }
            } catch (error) {
                console.error("Erreur lors de la génération du conseil de l'IA:", error);
                showMessage(`ERREUR DE L'IA: ${error.message}`, 'error');
            }
        }

        // Modale de confirmation générique
        function showConfirmModal(message) {
            return new Promise(resolve => {
                const modalDiv = document.createElement('div');
                modalDiv.id = 'confirm-modal';
                modalDiv.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 font-vt323';
                modalDiv.innerHTML = `
                    <div class="card-retro p-6 rounded-lg border-4 border-yellow-border shadow-xl w-full max-w-sm text-primary text-center">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4 text-accent-yellow">CONFIRMATION</h3>
                        <p class="text-base sm:text-lg mb-6">${String(message).toUpperCase()}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-no" class="btn-retro-red">ANNULER</button>
                            <button id="confirm-yes" class="btn-retro-green">CONFIRMER</button>
                        </div>
                    </div>
                `;
                document.getElementById('global-modals-container').appendChild(modalDiv);

                document.getElementById('confirm-yes').onclick = () => {
                    modalDiv.remove();
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    modalDiv.remove();
                    resolve(false);
                };
            });
        }

        // Synchronize breakfast/snack meals across similar days
        function syncSimilarMeals(generatedMeal, originalDateKey) {
            if (!generatedMeal || !generatedMeal.mealType || !(generatedMeal.mealType === 'petit_dejeuner' || generatedMeal.mealType.startsWith('collation'))) return;

            const originalDayContext = generatedMeal.dayContext;
            let updatedCount = 0;

            weeklyMealPlan.semaine.forEach(dayData => {
                const isSimilarDay = dayData.dayContext.poste === originalDayContext.poste && dayData.dayContext.sport === originalDayContext.sport;

                // Only update if it's a similar day AND not the original day that triggered the regeneration
                if (isSimilarDay && dayData.date !== originalDateKey) {
                    dayData[generatedMeal.mealType] = { ...generatedMeal };
                    updatedCount++;
                }
            });

            if (updatedCount > 0) showMessage(`SUCCÈS: ${updatedCount} REPAS SIMILAIRES MIS À JOUR !`, 'success');
        }

        // Calorie needs estimates based on shift type and sport type
        const dailyCalorieNeedsEstimates = {
            '6h-18h': { base: 2500, sport_modifier: { 'renforcement': 300, 'cardio': 200, 'hiit': 400, 'repos_actif': 100, 'aucun': 0 } },
            '7h-18h': { base: 2500, sport_modifier: { 'renforcement': 300, 'cardio': 200, 'hiit': 400, 'repos_actif': 100, 'aucun': 0 } },
            '18h-6h': { base: 2200, sport_modifier: { 'renforcement': 300, 'cardio': 200, 'hiit': 400, 'repos_actif': 100, 'aucun': 0 } },
            'repos': { base: 2000, sport_modifier: { 'renforcement': 300, 'cardio': 200, 'hiit': 400, 'repos_actif': 100, 'aucun': 0 } },
            'repos_sport': { base: 2800, sport_modifier: { 'renforcement': 0, 'cardio': 0, 'hiit': 0, 'repos_actif': 0, 'aucun': 0 } } // repos_sport already implies sport, so no extra modifier
        };

        function getDailyCalorieNeeds(shiftType, sportType) {
            const type = String(shiftType || 'repos');
            const sport = String(sportType || 'aucun');
            const estimate = dailyCalorieNeedsEstimates[type];
            if (estimate) {
                if (type === 'repos_sport') {
                    return estimate.base;
                } else {
                    return estimate.base + (estimate.sport_modifier[sport] || 0);
                }
            }
            return 2200; // Default fallback
        }

        // Fonctions pour la génération de repas par l'IA
        function getMealContextKey(mealType, dayContext) { return `${mealType}_${dayContext.poste}_${dayContext.sport}`; }

        async function generateInternalMeal(mealType, dayContext, existingMealsToday = [], likedMeal = null, allowMeatFish = true, userProfileData, numPeople, nutritionalProgramText) {
            const apiKey = userProfileData.apiKey || "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Debugging API key and URL
            console.log(`[API KEY DEBUG] Using API Key: ${apiKey ? 'Provided (length: ' + apiKey.length + ')' : 'Empty (expecting Canvas injection)'}`);
            console.log(`[API KEY DEBUG] API URL: ${apiUrl}`);

            const userHeight = userProfileData.height;
            const userWeight = userProfileData.weight;
            const userImc = userProfileData.imc;
            const userImcCategory = userProfileData.imcCategory;
            const userProteinNeeds = userProfileData.proteinNeeds;

            let mealContextDescription = getMealMomentContext(mealType, dayContext.poste, dayContext.sport);
            let sportImpact = "";
            if (dayContext.sport !== 'aucun') sportImpact = "CE JOUR INCLUT UNE SÉANCE DE SPORT. LE REPAS DOIT SOUTENIR LA PERFORMANCE OU LA RÉCUPÉRATION.";
            else sportImpact = "CE JOUR N'INCLUT PAS DE SÉANCE DE SPORT. LE REPAS DOIT ÊTRE ÉQUILIBRÉ POUR UN JOUR MOINS ACTIF.";

            let posteImpact = "";
            if (dayContext.poste === '18h-6h') posteImpact = "C'EST UN POSTE DE NUIT. L'ALIMENTATION DOIT ÊTRE ADAPTÉE POUR MAINTENIR L'ÉNERGIE ET LA VIGILANCE PENDANT LA NUIT, ET FAVORISER LE REPOS EN JOURNÉE.";
            else if (dayContext.poste.includes('jour')) posteImpact = "C'EST UN POSTE DE JOUR. L'ALIMENTATION DOIT APPORTER UNE ÉNERGIE DURABLE POUR LA JOURNÉE.";
            else if (dayContext.poste.includes('repos')) posteImpact = "C'EST UN JOUR DE REPOS. L'ALIMENTATION DOIT FAVORISER LA RÉCUPÉRATION ET LE MAINTIEN.";

            let mealSpecificConstraints = [];
            const adviceKey = mealType.includes('collation') ? `${mealType.replace('_unique', '')}_${dayContext.poste === '18h-6h' ? 'pendant' : (dayContext.sport !== 'aucun' ? 'post' : (dayContext.poste === '7h-18h' ? '7h-18h_apresmidi' : 'repos_default'))}` : dayContext.poste === '18h-6h' ? '18h-6h' : (dayContext.sport !== 'aucun' ? 'repos_sport' : 'default');
            const advice = specificMealAdvice[mealType]?.[adviceKey] || specificMealAdvice[mealType]?.default || "CONSEIL GÉNÉRAL : MANGEZ ÉQUILIBRÉ.";
            mealSpecificConstraints.push(advice);

            if (!allowMeatFish) mealSpecificConstraints.push("EXCLURE STRICTEMENT TOUTE VIANDE (ROUGE OU BLANCHE) ET POISSON. PRIVILÉGIER LES PROTÉINES VÉGÉTALES (LÉGUMINEUSES, TOFU, TEMPEH, SEITAN, QUINOA, SARRASIN, AMARANTE, NOIX, GRAINES) OU LES ŒUFS/PRODUITS LAITIERS SI APPLICABLE AU TYPE DE REPAS. ASSURER UNE DIVERSITÉ RÉELLE DES SOURCES DE PROTÉINES VÉGÉTALES, NE PAS SE LIMITER AUX LENTILLES.");
            else mealSpecificConstraints.push("ALTERNANCE ENTRE VIANDE (ROUGE ET BLANCHE), POISSONS (MAIGRES ET GRAS), ŒUFS, TOFU ET LÉGUMINEUSES POUR ASSURER UNE DIVERSITÉ DES SOURCES DE PROTÉINES.");

            if (mealType === 'petit_dejeuner') {
                mealSpecificConstraints.push("DOIT ÊTRE UN PETIT-DÉJEUNER COHÉRENT ET RÉALISTE. AUCUNE COMBINAISON ABSURDE (EX: POULET DANS UN PANCAKE SUCRÉ).");
                mealSpecificConstraints.push("DOIT ÊTRE SUCRÉ, EN ÉVITANT LES SAVEURS SALÉES (SAUF SI LES ŒUFS SONT INTÉGRÉS DANS UNE PRÉPARATION SUCRÉE COMME DES CRÊPES/PANCAKES).");
                mealSpecificConstraints.push("LES ŒUFS NE PEUVENT ÊTRE UTILISÉS QUE S'ILS SONT INTÉGRÉS DANS DES PRÉPARATIONS COMME DES CRÊPES, DES PANCAKES OU DES PORRIDGES, PAS COMME PLAT PRINCIPAL (EX: ŒUFS BROUILLÉS, OMELETTE).");
                mealSpecificConstraints.push("PAS DE PÂTES, SEMOULE OU SAUCE TOMATE.");
                mealSpecificConstraints.push("AJOUTEZ UNE TRÈS GRANDE VARIÉTÉ DE PETITS-DÉJEUNERS : TARTINES (MIEL, BEURRE, BEURRE DE CACAHUÈTE), THÉ (AVEC OU SANS LAIT), PORRIDGE, SHAKE DE WHEY (SI CONTEXTE SPORTIF LE PERMET), CÉRÉALES, FRUITS, YAOURTS. ADAPTEZ LES OPTIONS AU TYPE DE SÉANCE (EX: PORRIDGE POUR RENFORCEMENT, SHAKE POUR CARDIO) POUR ÉVITER LES DÉPENSES INUTILES.");
                if (dayContext.sport === 'renforcement') mealSpecificConstraints.push("PRIVILÉGIER LES PORRIDGES OU LES REPAS RICHES EN GLUCIDES LENTS ET PROTÉINES POUR L'ÉNERGIE ET LA RÉCUPÉRATION MUSCULAIRE.");
                if (dayContext.sport === 'cardio' || dayContext.sport === 'hiit') mealSpecificConstraints.push("PRIVILÉGIER LES SHAKES PROTÉINÉS OU LES OPTIONS PLUS LÉGÈRES ET RAPIDEMENT DIGESTIBLES POUR NE PAS GÊNER LA SÉANCE.");
            } else if (mealType.includes('collation')) {
                mealSpecificConstraints.push("DOIT ÊTRE UNE COLLATON LÉGÈRE ET ÉNERGISANTE. PAS UN REPAS COMPLET. DOIT ÊTRE FACILE À TRANSPORTER.");
                mealSpecificConstraints.push("EXEMPLES : FRUITS (BANANE, POMME), YAOURTS, SHAKES PROTÉINÉS, PETITES POIGNÉES D'OLÉAGINEUX (AMANDES, NOIX), BARRES CÉRÉALES MAISON, FRUITS SECS.");
                mealSpecificConstraints.push("ÉVITEZ LES ALIMENTS TROP GRAS OU TROP SUCRÉS.");
                mealSpecificConstraints.push("PROPOSEZ UNE TRÈS GRANDE VARIÉTÉ DE COLLATIONS.");
            } else if (mealType === 'dejeuner' || mealType === 'diner') {
                mealSpecificConstraints.push("DOIT ÊTRE UN REPAS COMPLET ET ÉQUILIBRÉ AVEC PROTÉINES, GLUCIDES ET LÉGUMES. DOIT ÊTRE COHÉRENT ET RÉALISTE, SANS COMBINAISONS ABSURDES.");
                mealSpecificConstraints.push("PROPOSEZ UNE TRÈS GRANDE VARIÉTÉ DE RECETTES POUR ÉVITER LA MONOTONIE : SALADES (VERTE, ICEBERG, CRUDITÉS, POMMES DE TERRE, RIZ, PÂTES), GALETTES DE POMMES DE TERRE, RECETTES AVEC DU PAIN (EX: PAIN AVEC FROMAGE, TOASTS PROTÉINÉS, SANDWICHS ÉQUILIBRÉS), BURGERS ET WRAPS (ADAPTÉS AU PROGRAMME NUTRITIONNEL).");
                mealSpecificConstraints.push("ALTERNEZ SYSTÉMATIQUEMENT LES TYPES DE PROTÉINES, GLUCIDES ET LÉGUMES. INCLUEZ FRÉQUEMMENT PÂTES COMPLÈTES, SPAGHETTIS, PÂTES FRAÎCHES, RIZ BASMATI, QUINOA, PATATE DOUCE, SEMOULE COMPLÈTE. LÉGUMES VARIÉS: CONCOMBRE, ARTICHAUD, BROCOLIS, POIVRONS, HARICOTS VERTS, COURGETTES, ÉPINARDS, CAROTTES, CHOU-FLEUR, TOMATES CERISES, LAITUE, RADIS, CHAMPIGNONS, AUBERGINE, OIGNON.");
                mealSpecificConstraints.push("LES RECETTES PEUVENT ÊTRE ISSUES D'AUTRES CULTURES OU CUISINES DU MONDE, MAIS DOIVENT TOUJOURS RESPECTER LE PROGRAMME SPORTIF ET NUTRITIONNEL, ET ÊTRE RÉALISTES.");
            }

            let existingMealsPrompt = "";
            if (existingMealsToday.length > 0) {
                existingMealsToday.forEach(meal => { existingMealsPrompt += `- ${meal.title} (${meal.mealType})\n`; });
                mealSpecificConstraints.push(`PRENEZ EN COMPTE LES AUTRES REPAS DÉJÀ GÉNÉRÉS POUR CE JOUR POUR ASSURER LA VARIÉTÉ ET ÉVITER LES DOUBLONS D'INGRÉDIENTS OU DE PRÉPARATIONS. REPAS DÉJÀ PRÉVUS POUR CE JOUR : ${existingMealsPrompt}`);
            }

            if (likedMeal) mealSpecificConstraints.push(`L'UTILISATEUR A AIMÉ LA RECETTE SUIVANTE. UTILISEZ-LA COMME INSPIRATION POUR GÉNÉRER UNE NOUVELLE RECETTE SIMILAIRE, MAIS PAS IDENTIQUE, EN VARIANT LÉGÈREMENT LES INGRÉDIENTS OU LA PRÉPARATION POUR ÉVITER LA MONOTONIE ET CONTINUER À OFFRIR DE LA NOUVEAUTÉ. RECETTE AIMÉE : TITRE: ${likedMeal.title}, DESCRIPTION: ${likedMeal.description_du_plat}, INGRÉDIENTS: ${likedMeal.ingredients_list.join(', ')}.`);

            const prompt = `
        Génère une recette de repas pour ${numPeople} personne(s) au format JSON.
        Le repas est de type : "${mealType}".
        Le contexte du jour est : "${getDayContextString(dayContext.poste, dayContext.sport)}".
        Profil utilisateur : Taille: ${userHeight}cm, Poids: ${userWeight}kg, IMC: ${userImc} (${userImcCategory}), Besoins en protéines: ${userProteinNeeds}g/jour.
        ${sportImpact}
        ${posteImpact}

        PROGRAMME NUTRITIONNEL DÉTAILLÉ À RESPECTER STRICTEMENT :
        ${nutritionalProgramText}

        CONTRAINTES SPÉCIFIQUES POUR CE REPAS :
        - Toutes les informations (titre, description, ingrédients, étapes de préparation, conseils, notes) doivent être STRICTEMENT EN FRANÇAIS.
        - Les quantités des ingrédients doivent être adaptées pour ${numPeople} personne(s) et clairement indiquées (ex: 150g, 2 pièces, 1 cuillère à soupe).
        - GÉNÈRE UNIQUEMENT DES RECETTES EXISTANTES, RÉALISTES ET LOGIQUES. AUCUNE COMBINAISON ABSURDE OU NON EXISTANTE (EX: UN WRAP AU POULET ET AUX FRUITS ROUGES).
        - ASSURE UNE TRÈS GRANDE VARIÉTÉ POUR ÉVITER LA MONOTONIE.
        - POUR LES REPAS PRINCIPAUX (DÉJEUNER ET DÎNER) : Si le contexte (type de poste et séance sportive) est identique à un jour précédent, vous pouvez proposer une recette similaire ou réutiliser des ingrédients clés pour optimiser les courses, mais EFFORCEZ-VOUS DE RENDRE CHAQUE RECETTE UNIQUE OU AVEC UNE TOUCHE DIFFÉRENTE.
        - POUR LES COLLATIONS ET PETITS-DÉJEUNERS : Les recettes doivent être variées, faciles à transporter si applicable, compatibles avec le programme sport/nutrition. Si ce repas est généré pour un jour donné, toutes les autres collations/petits-déjeuners du même type de poste ou de séance dans la même semaine devraient être identiques pour assurer la cohérence et la simplicité. Si une nouvelle génération est demandée pour ce type de repas, proposez de nouvelles recettes.
        ${mealSpecificConstraints.map(c => `- ${c}`).join('\n')}

        Format de sortie JSON attendu :
        {
            "title": "TITRE DU PLAT (EX: POULET GRILLÉ ET LÉGUMES)",
            "description_du_plat": "DESCRIPTION DÉTAILLÉE DU PLAT.",
            "ingredients_label": "INGRÉDIENTS (POUR X PERS)",
            "ingredients_list": ["QUANTITÉ UNITÉ INGRÉDIENT 1", "QUANTITÉ UNITÉ INGRÉDIENT 2", ...],
            "preparation_steps": ["ÉTAPE 1.", "ÉTAPE 2.", ...],
            "ma_portion_waeky": "VOTRE PORTION (POUR WAEKY) : DÉTAILLEZ LES QUANTITÉS SPÉCIFIQUES POUR L'UTILISATEUR (EX: 150G POULET, 200G RIZ, PORTION GÉNÉREUSE DE LÉGUMES). INCLUEZ UNE ESTIMATION DES CALORIES POUR CETTE PORTION (EX: ~500 KCAL).",
            "calories_kcal": "ESTIMATION DES CALORIES TOTALES POUR CE REPAS POUR ${numPeople} PERSONNE(S) (EX: 500)",
            "conseils_reutilisation_economie": "CONSEILS POUR RÉUTILISER LES RESTES OU ÉCONOMISER.",
            "notes": "NOTES SUPPLÉMENTAIRES OU INFORMATIONS NUTRITIONNELLES."
        }
    `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING" },
                            "description_du_plat": { "type": "STRING" },
                            "ingredients_label": { "type": "STRING" },
                            "ingredients_list": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "preparation_steps": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "ma_portion_waeky": { "type": "STRING" },
                            "calories_kcal": { "type": "NUMBER" },
                            "conseils_reutilisation_economie": { "type": "STRING" },
                            "notes": { "type": "STRING" }
                        },
                        "required": ["title", "description_du_plat", "ingredients_label", "ingredients_list", "preparation_steps", "ma_portion_waeky", "calories_kcal", "conseils_reutilisation_economie", "notes"]
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `Erreur HTTP: ${response.status}`;
                    if (response.status === 401 || response.status === 403) errorMessage += " - PROBLÈME D'AUTHENTIFICATION API. VÉRIFIEZ L'ACCÈS À L'API GEMINI. (CODE 401/403)";
                    else if (errorText) errorMessage += ` - ${errorText}`;
                    throw new Error(errorMessage);
                }

                const rawResult = await response.text();
                let parsedContent = null;
                try {
                    const result = JSON.parse(rawResult);
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        parsedContent = JSON.parse(result.candidates[0].content.parts[0].text);
                    } else {
                        throw new Error("Réponse de l'IA mal formée ou vide.");
                    }
                } catch (parseError) {
                    console.error("Erreur lors de l'analyse du JSON de la réponse LLM ou de la structure des candidats:", parseError);
                    console.error("JSON brut causant l'erreur:", rawResult);
                    const fallbackTitle = `${mealContextDescription.toUpperCase()} SIMPLIFIÉ (ERREUR IA)`, fallbackDesc = `UNE ERREUR S'EST PRODUIte LORS DE LA GÉNÉRATION. VOICI UNE RECETTE DE BASE.`, fallbackIngredients = [`QUANTITÉS À DÉFINIR SELON VOTRE APPÉTIT`, `PROTÉINES VARIÉES`, `GLUCIDES COMPLEXES`, `LÉGUMES DE SAISON`], fallbackPreparation = ["1. PRÉPAREZ LES INGRÉDIENTS. 2. CUISEZ SELON VOS MÉTHODES HABITUELLES."], fallbackPortion = "VOTRE PORTION (POUR WAEKY) : PROTÉINES, GLUCIDES ET LÉGUMES/FRUITS VARIÉS ADAPTÉS. POUR 1 PERSONNE.", fallbackCalories = 0, fallbackConseils = "AJUSTEZ LES QUANTITÉS SELON VOS BESOINS. ESSAYEZ DE RÉUTILISER LES RESTES.", fallbackNotes = "LA RECETTE A ÉTÉ SIMPLIFIÉE EN RAISON D'UN PROBLÈME DE COMMUNICATION AVEC L'IA. VÉRIFIEZ LE PROMPT OU L'API.";
                    parsedContent = { title: fallbackTitle, description_du_plat: fallbackDesc, ingredients_label: `INGRÉDIENTS (POUR ${numPeople} PERS)`, ingredients_list: fallbackIngredients, preparation_steps: fallbackPreparation, ma_portion_waeky: fallbackPortion, calories_kcal: fallbackCalories, conseils_reutilisation_economie: fallbackConseils, notes: fallbackNotes };
                }

                return {
                    id: generateUniqueId(),
                    title: String(parsedContent.title || '').toUpperCase(),
                    description_du_plat: String(parsedContent.description_du_plat || '').toUpperCase(),
                    ingredients_label: String(parsedContent.ingredients_label || `INGRÉDIENTS (POUR ${numPeople} PERS)`).toUpperCase(),
                    ingredients_list: (parsedContent.ingredients_list || []).map(item => String(item).toUpperCase()),
                    preparation_steps: (parsedContent.preparation_steps || []).map(step => String(step).toUpperCase()),
                    ma_portion_waeky: String(parsedContent.ma_portion_waeky || '').toUpperCase(),
                    calories_kcal: parsedContent.calories_kcal !== undefined ? parseInt(parsedContent.calories_kcal) : 0,
                    conseils_reutilisation_economie: String(parsedContent.conseils_reutilisation_economie || '').toUpperCase(),
                    notes: String(parsedContent.notes || '').toUpperCase(),
                    mealType: mealType,
                    dayContext: dayContext
                };
            } catch (error) {
                console.error("Erreur fatale lors de l'appel LLM ou de l'analyse JSON générale:", error);
                const fallbackTitle = `${mealContextDescription.toUpperCase()} (ERREUR SYSTÈME)`, fallbackDesc = `UNE ERREUR CRITIQUE S'EST PRODUIte. VEUILLEZ RÉESSAYER.`, fallbackIngredients = [`VÉRIFIEZ VOTRE CONNEXION INTERNET`, `CONTACTEZ LE SUPPORT SI LE PROBLÈME PERSISTE`], fallbackPreparation = ["1. ESSAYEZ DE RE-GÉNÉRER LE PLAN.", "2. ASSUREZ-VOUS QUE VOTRE PROFIL EST COMPLET."], fallbackPortion = "INDISPONIBLE EN RAISON D'UNE ERREUR.", fallbackCalories = 0, fallbackConseils = "AUCUN CONSEIL DISPONIBLE.", fallbackNotes = "ERREUR DE COMMUNICATION MAJEURE AVEC L'IA. VEUILLEZ VÉRIFIER VOTRE CONNEXION.";
                return { id: generateUniqueId(), title: fallbackTitle, description_du_plat: fallbackDesc, ingredients_label: `INGRÉDIENTS (POUR ${numPeople} PERS)`, ingredients_list: fallbackIngredients, preparation_steps: fallbackPreparation, ma_portion_waeky: fallbackPortion, calories_kcal: fallbackCalories, conseils_reutilisation_economie: fallbackConseils, notes: fallbackNotes, mealType: mealType, dayContext: dayContext };
            }
        }

        // Rend la vue des recettes et gère la génération du plan de repas
        function renderRecipeView(container) {
            let numPeople = loadFromLocalStorage('recipeNumPeople', 1);
            let allowMeatFish = loadFromLocalStorage('recipeAllowMeatFish', true);

            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-accent-yellow mb-4 text-center">PLAN DE REPAS</h2>
                    <div class="p-4 rounded-lg border-2 border-primary card-bg-blue-border mb-6">
                        <h3 class="text-xl sm:text-2xl text-accent-yellow mb-3">GÉNÉRER MON PLAN DE REPAS :</h3>
                        <div class="mb-4">
                            <label for="numPeople" class="block text-secondary text-sm font-bold mb-2">POUR COMBIEN DE PERSONNES ?</label>
                            <input type="number" id="numPeople" value="${numPeople}" min="1" class="input-retro" />
                        </div>
                        <div class="mb-4 flex items-center">
                            <input type="checkbox" id="allowMeatFish" ${allowMeatFish ? 'checked' : ''} class="mr-2 h-4 w-4 text-accent-purple rounded border-secondary focus:ring-accent-purple" />
                            <label for="allowMeatFish" class="text-secondary text-sm font-bold">AUTORISER VIANDE ET POISSON (PLUS ÉCONOMIQUE SANS)</label>
                        </div>
                        <button id="generate-plan-btn" class="btn-retro-purple w-full flex items-center justify-center" ${regeneratingMeal ? 'disabled' : ''}>
                            <span id="generate-plan-spinner" class="spinner mr-2 ${regeneratingMeal ? '' : 'hidden'}"></span>
                            <span id="generate-plan-text">${regeneratingMeal ? 'GÉNÉRATION...' : 'GÉNÉRER PLAN DE REPAS'}</span>
                        </button>
                        <p class="text-xs text-tertiary mt-2 text-center">LE PLAN SERA GÉNÉRÉ UNIQUEMENT POUR LES JOURS AVEC DES POSTES ENREGISTRÉS DANS L'ONGLET "PLANNING".</p>
                    </div>
                    <div id="weekly-meal-plan-content"></div>
                </div>
            `;
            container.innerHTML = html;

            const numPeopleInput = document.getElementById('numPeople');
            const allowMeatFishCheckbox = document.getElementById('allowMeatFish');
            const generatePlanBtn = document.getElementById('generate-plan-btn');
            const generatePlanSpinner = document.getElementById('generate-plan-spinner');
            const generatePlanText = document.getElementById('generate-plan-text');
            const weeklyMealPlanContentDiv = document.getElementById('weekly-meal-plan-content');

            numPeople = loadFromLocalStorage('recipeNumPeople', 1);
            allowMeatFish = loadFromLocalStorage('recipeAllowMeatFish', true);
            numPeopleInput.value = numPeople;
            allowMeatFishCheckbox.checked = allowMeatFish;

            numPeopleInput.onchange = (e) => { numPeople = Math.max(1, parseInt(e.target.value) || 1); saveToLocalStorage('recipeNumPeople', numPeople); };
            allowMeatFishCheckbox.onchange = (e) => { allowMeatFish = e.target.checked; saveToLocalStorage('recipeAllowMeatFish', allowMeatFish); };

            // Update button state based on regeneratingMeal flag
            if (regeneratingMeal) {
                generatePlanBtn.disabled = true;
                generatePlanSpinner.classList.remove('hidden');
                generatePlanText.textContent = 'GÉNÉRATION...';
            } else {
                generatePlanBtn.disabled = false;
                generatePlanSpinner.classList.add('hidden');
                generatePlanText.textContent = 'GÉNÉRER PLAN DE REPAS';
            }

            generatePlanBtn.onclick = async () => {
                regeneratingMeal = { dateKey: null, mealType: null }; // Set regeneratingMeal to indicate overall generation
                renderRecipeView(container); // Re-render to show spinner and disabled button

                try {
                    if (!userProfile.height || !userProfile.weight) { showMessage("ERREUR: VEUILLEZ REMPLIR VOTRE TAILLE ET VOTRE POIDS DANS LE PROFIL POUR GÉNÉRER DES RECETTES PRÉCISES.", 'error'); return; }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const fetchedShifts = (loadFromLocalStorage('shifts', []) || []).filter(s => new Date(s.date).getTime() >= today.getTime());

                    if (fetchedShifts.length === 0) { showMessage("AUCUN POSTE ENREGISTRÉ POUR LES JOURS À VENIR. VEUILLEZ AJOUTER DES POSTES DANS L'ONGLET 'PLANNING' POUR GÉNÉRER UN PLAN DE REPAS.", 'warning'); return; }

                    const newMealPlan = { semaine: [] };
                    const userProfileData = { height: parseFloat(userProfile.height), weight: parseFloat(userProfile.weight), imc: userProfile.imc, imcCategory: userProfile.imcCategory, proteinNeeds: userProfile.proteinNeeds, apiKey: userProfile.apiKey };

                    const generatedSimilarMeals = {}; // Key: "shiftType_workoutType_mealType", Value: meal object

                    // Sort shifts by date to ensure consistent generation order
                    fetchedShifts.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                    for (const shift of fetchedShifts) {
                        const day = new Date(shift.date);
                        const dateKey = formatDateToYYYYMMDD(day);
                        const dayContext = { poste: shift.type, sport: shift.workoutType };
                        const mealsForDay = { date: dateKey, dayContext: dayContext };
                        const mealOrder = ['petit_dejeuner', 'collation_matin', 'dejeuner', 'collation_apresmidi', 'diner', 'collation_unique'];

                        for (const mealType of mealOrder) {
                            let addMeal = true;
                            if (mealType === 'collation_matin') {
                                if (dayContext.poste === '18h-6h' || (dayContext.poste === 'repos' && dayContext.sport === 'aucun')) { addMeal = false; }
                            } else if (mealType === 'collation_apresmidi') {
                                if (dayContext.poste === '18h-6h' || (dayContext.poste === 'repos' && dayContext.sport === 'aucun')) { addMeal = false; }
                            } else if (mealType === 'collation_unique') {
                                if (dayContext.poste === '18h-6h') { addMeal = true; } else { addMeal = false; }
                            }
                            if (!addMeal) continue;

                            let generatedMeal;
                            const relevantLikedMeals = userProfile.likedMeals.filter(lm => lm.mealType === mealType);
                            const inspirationMeal = relevantLikedMeals.length > 0 ? relevantLikedMeals[Math.floor(Math.random() * relevantLikedMeals.length)] : null;

                            const isSynchronizableMeal = (mealType === 'petit_dejeuner' || mealType.startsWith('collation'));
                            const dayContextKey = `${dayContext.poste}_${dayContext.sport}_${mealType}`;

                            if (isSynchronizableMeal && generatedSimilarMeals[dayContextKey]) {
                                // Reuse already generated meal for similar context
                                generatedMeal = { ...generatedSimilarMeals[dayContextKey] };
                                generatedMeal.id = generateUniqueId(); // Assign a new unique ID for this instance
                            } else {
                                // Generate new meal
                                generatedMeal = await generateInternalMeal(
                                    mealType,
                                    dayContext,
                                    Object.values(mealsForDay).filter(m => typeof m === 'object' && m !== null && m.mealType && m.mealType !== mealType),
                                    inspirationMeal,
                                    allowMeatFish,
                                    userProfileData,
                                    numPeople,
                                    nutritionalProgramText
                                );
                                if (isSynchronizableMeal) {
                                    // Store for future reuse in this generation cycle
                                    generatedSimilarMeals[dayContextKey] = { ...generatedMeal };
                                }
                            }
                            mealsForDay[mealType] = generatedMeal;
                        }
                        newMealPlan.semaine.push({ date: dateKey, dayContext: dayContext, ...mealsForDay });
                    }

                    newMealPlan.semaine.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                    weeklyMealPlan = newMealPlan;
                    saveToLocalStorage('weeklyMealPlan', weeklyMealPlan);
                    showMessage("SUCCÈS: PLAN DE REPAS GÉNÉRÉ ET ENREGISTRÉ !", 'success');
                    speak("Plan de repas généré !");
                } catch (error) {
                    console.error("Erreur lors de la génération du plan de repas:", error);
                    showMessage(`ERREUR: Échec de la génération du plan. ${error.message}`, 'error');
                } finally {
                    regeneratingMeal = null; // Clear regeneratingMeal flag
                    renderRecipeView(container); // Re-render to update UI and re-enable button
                }
            };

            function renderWeeklyMealPlan() {
                if (!weeklyMealPlan || !weeklyMealPlan.semaine || weeklyMealPlan.semaine.length === 0) {
                    weeklyMealPlanContentDiv.innerHTML = `<p class="text-tertiary text-center">AUCUN PLAN DE REPAS GÉNÉRÉ. CLIQUEZ SUR "GÉNÉRER PLAN DE REPAS" CI-DESSUS.</p>`;
                    return;
                }

                let mealsHtml = `<div class="space-y-6"> <h3 class="text-xl sm:text-2xl text-accent-yellow mb-3 text-center">TON PLAN DE REPAS :</h3> `;

                weeklyMealPlan.semaine.forEach((dayData, dayIndex) => {
                    const dateString = new Date(dayData.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
                    const dayContextString = getDayContextString(dayData.dayContext.poste, dayData.dayContext.sport);

                    const totalDailyCalories = ['petit_dejeuner', 'collation_matin', 'dejeuner', 'collation_apresmidi', 'diner', 'collation_unique'].reduce((sum, mealType) => {
                        const meal = dayData[mealType];
                        return sum + (meal && typeof meal.calories_kcal === 'number' ? meal.calories_kcal : 0);
                    }, 0);
                    const requiredDailyCalories = getDailyCalorieNeeds(dayData.dayContext.poste, dayData.dayContext.sport);

                    mealsHtml += `
                        <div class="card-bg-purple-border p-4 rounded-lg shadow-lg">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center cursor-pointer py-2" data-toggle="day-content-${dayData.date}">
                                <h4 class="text-lg sm:text-xl font-bold text-accent-yellow mb-2 sm:mb-0">${dateString} - ${dayContextString}</h4>
                                <i data-lucide="chevron-down" class="text-accent-yellow transition-transform duration-300"></i>
                            </div>
                            <div class="text-sm text-secondary mt-2 p-2 bg-accent-light rounded-md">
                                <p>CALORIES JOURNÉE : <span class="font-bold text-accent-blue-light">${totalDailyCalories} KCAL</span></p>
                                <p>BESOIN ESTIMÉ : <span class="font-bold text-accent-blue-light">${requiredDailyCalories} KCAL</span></p>
                            </div>
                            <div id="day-content-${dayData.date}" class="overflow-hidden transition-all duration-500 ease-in-out max-h-0">
                                <div class="space-y-4 pt-2">
                    `;

                    const mealOrder = ['petit_dejeuner', 'collation_matin', 'dejeuner', 'collation_apresmidi', 'diner', 'collation_unique'];
                    mealOrder.forEach(mealType => {
                        const meal = dayData[mealType];
                        if (meal) {
                            const momentContext = getMealMomentContext(mealType, dayData.dayContext.poste, dayData.dayContext.sport);
                            const adviceKey = mealType.includes('collation') ? `${mealType.replace('_unique', '')}_${dayData.dayContext.poste === '18h-6h' ? 'pendant' : (dayData.dayContext.sport !== 'aucun' ? 'post' : (dayData.dayContext.poste === '7h-18h' ? '7h-18h_apresmidi' : 'repos_default'))}` : dayData.dayContext.poste === '18h-6h' ? '18h-6h' : (dayData.dayContext.sport !== 'aucun' ? 'repos_sport' : 'default');
                            const advice = specificMealAdvice[mealType]?.[adviceKey] || specificMealAdvice[mealType]?.default || "CONSEIL GÉNÉRAL : MANGEZ ÉQUILIBRÉ.";
                            const isRegeneratingCurrentMeal = regeneratingMeal && regeneratingMeal.dateKey === dayData.date && regeneratingMeal.mealType === mealType;
                            const isLiked = userProfile.likedMeals.some(lm => lm.id === meal.id); // Check if this specific meal instance is liked

                            mealsHtml += `
                                <div class="bg-list-item p-3 rounded-md border border-primary shadow-sm">
                                    <div class="flex justify-between items-center cursor-pointer py-2" data-toggle="meal-content-${meal.id}">
                                        <h5 class="text-lg font-bold text-primary">${momentContext} : ${String(meal.title || 'Titre Indisponible').toUpperCase()} <span class="text-accent-yellow text-sm">(${meal.calories_kcal} KCAL)</span></h5>
                                        <div class="flex items-center">
                                            <button class="btn-retro-purple text-xs px-2 py-1 flex items-center justify-center regenerate-meal-btn" data-date="${dayData.date}" data-meal-type="${mealType}" ${isRegeneratingCurrentMeal ? 'disabled' : ''}>
                                                ${isRegeneratingCurrentMeal ? `<span class="spinner w-4 h-4"></span>` : `<i data-lucide="rotate-ccw" style="width:16px; height:16px;"></i>`}
                                                <span class="ml-1 hidden sm:inline">RÉGÉNÉRER</span>
                                            </button>
                                            <button class="text-primary ml-2 like-meal-btn" data-meal-id="${meal.id}" data-date="${dayData.date}" data-meal-type="${mealType}" style="color:${isLiked ? 'var(--color-accent-yellow)' : 'var(--color-text-primary)'};">
                                                <i data-lucide="${isLiked ? 'heart' : 'heart'}" class="${isLiked ? 'fill-current text-accent-yellow' : ''}" style="width:20px; height:20px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="meal-content-${meal.id}" class="overflow-hidden transition-all duration-500 ease-in-out max-h-0">
                                        <p class="text-secondary text-sm italic mb-2">${String(meal.description_du_plat || 'DESCRIPTION INDISPONIBLE').toUpperCase()}</p>
                                        <p class="text-sm font-medium text-accent-yellow">${String(meal.ingredients_label || 'INGRÉDIENTS').toUpperCase()} :</p>
                                        <ul class="list-disc list-inside text-secondary text-xs pl-2 space-y-1">${(meal.ingredients_list || []).map(ingredient => `<li>${String(ingredient).toUpperCase()}</li>`).join('')}</ul>
                                        <p class="text-sm font-medium text-accent-yellow mt-2">PRÉPARATION :</p>
                                        <ol class="list-decimal list-inside text-secondary text-xs pl-2 space-y-1">${(meal.preparation_steps || []).map(step => `<li>${String(step).toUpperCase()}</li>`).join('')}</ol>
                                        <p class="text-sm font-medium text-accent-yellow mt-2">PORTION WAEKY :</p>
                                        <p class="text-secondary text-xs">${String(meal.ma_portion_waeky || 'PORTION INDISPONIBLE').toUpperCase()}</p>
                                        <p class="text-sm font-medium text-accent-yellow mt-2">CONSEILS ÉCONOMIE :</p>
                                        <p class="text-secondary text-xs">${String(meal.conseils_reutilisation_economie || 'CONSEILS INDISPONIBLES').toUpperCase()}</p>
                                        <p class="text-accent-blue-light text-xs mt-3">${advice}</p>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    mealsHtml += `</div></div></div>`;
                });
                mealsHtml += `</div>`;
                weeklyMealPlanContentDiv.innerHTML = mealsHtml;
                renderLucideIcons();
                attachCollapsibleListeners();
                attachMealActionListeners();
            }
            renderWeeklyMealPlan();
        }

        // Gère l'affichage/masquage des détails de repas
        function attachCollapsibleListeners() {
            document.querySelectorAll('[data-toggle]').forEach(toggleElement => {
                // Remove existing listener to prevent duplicates
                if (toggleElement.dataset.listenerAttached) {
                    toggleElement.removeEventListener('click', toggleElement._clickHandler);
                }

                const clickHandler = (event) => {
                    event.stopPropagation(); // Prevent bubbling to parent if nested
                    const targetId = toggleElement.dataset.toggle;
                    const targetContent = document.getElementById(targetId);
                    const icon = toggleElement.querySelector('i[data-lucide]');

                    if (targetContent) {
                        if (targetContent.classList.contains('max-h-0')) {
                            // Expand
                            targetContent.style.maxHeight = targetContent.scrollHeight + 'px';
                            targetContent.classList.remove('max-h-0');
                            if (icon) icon.classList.add('rotate-180');
                            targetContent.classList.add('open');
                            // After transition, set max-height to a very large value to accommodate dynamic content
                            targetContent.addEventListener('transitionend', function handler() {
                                if (targetContent.classList.contains('open')) {
                                    targetContent.style.maxHeight = '9999px'; // Allow content to grow
                                }
                                targetContent.removeEventListener('transitionend', handler);
                            }, { once: true });
                        } else {
                            // Collapse
                            targetContent.style.maxHeight = targetContent.scrollHeight + 'px'; // Set explicit height before collapsing
                            requestAnimationFrame(() => {
                                targetContent.classList.add('max-h-0');
                                targetContent.style.maxHeight = '0'; // Collapse
                            });
                            if (icon) icon.classList.remove('rotate-180');
                            targetContent.classList.remove('open');
                        }
                    }
                };

                toggleElement.addEventListener('click', clickHandler);
                toggleElement._clickHandler = clickHandler; // Store reference to the handler
                toggleElement.dataset.listenerAttached = 'true';
            });
        }

        // Attach listeners for regenerate and like buttons
        function attachMealActionListeners() {
            document.querySelectorAll('.regenerate-meal-btn').forEach(button => {
                button.onclick = async (event) => {
                    const dateKey = event.currentTarget.dataset.date;
                    const mealType = event.currentTarget.dataset.mealType;
                    const dayDataForRegen = weeklyMealPlan.semaine.find(d => d.date === dateKey);

                    if (!dayDataForRegen || !dayDataForRegen.dayContext) { showMessage("ERREUR: CONTEXTE DE JOUR NON TROUVÉ POUR LA RÉGÉNÉRATION DU REPAS.", 'error'); return; }

                    regeneratingMeal = { dateKey: dateKey, mealType: mealType };
                    renderRecipeView(document.getElementById('main-content')); // Re-render to show spinner/disabled state

                    try {
                        const userProfileData = { height: parseFloat(userProfile.height), weight: parseFloat(userProfile.weight), imc: userProfile.imc, imcCategory: userProfile.imcCategory, proteinNeeds: userProfile.proteinNeeds, apiKey: userProfile.apiKey };
                        const regeneratedMeal = await generateInternalMeal(
                            mealType,
                            dayDataForRegen.dayContext,
                            Object.values(dayDataForRegen).filter(m => typeof m === 'object' && m !== null && m.mealType && m.mealType !== mealType),
                            null, // No specific liked meal inspiration for regeneration of an existing slot
                            allowMeatFish,
                            userProfileData,
                            numPeople,
                            nutritionalProgramText
                        );

                        dayDataForRegen[mealType] = regeneratedMeal;

                        // Synchronize breakfast/collation meals on regeneration
                        if (mealType === 'petit_dejeuner' || mealType.startsWith('collation')) {
                            syncSimilarMeals(regeneratedMeal, dateKey);
                        }

                        saveToLocalStorage('weeklyMealPlan', weeklyMealPlan);
                        showMessage("SUCCÈS: REPAS RÉGÉNÉRÉ !", 'success');
                        speak("Repas régénéré !");
                    } catch (error) {
                        console.error("Erreur lors de la régénération du repas:", error);
                        showMessage(`ERREUR: ÉCHEC DE LA RÉGÉNÉRATION DU REPAS. ${error.message}`, 'error');
                    } finally {
                        regeneratingMeal = null; // Clear regeneratingMeal flag
                        renderRecipeView(document.getElementById('main-content')); // Re-render to update UI and re-enable button
                    }
                };
            });

            document.querySelectorAll('.like-meal-btn').forEach(button => {
                button.onclick = (event) => {
                    const mealId = button.dataset.mealId;
                    const dateKey = button.dataset.date;
                    const mealType = button.dataset.mealType;
                    const dayData = weeklyMealPlan.semaine.find(d => d.date === dateKey);
                    const mealToLike = dayData ? dayData[mealType] : null;

                    if (mealToLike) {
                        // Check if the specific meal instance (by its unique ID) is already liked
                        const existingLikedIndex = userProfile.likedMeals.findIndex(lm => lm.id === mealToLike.id);
                        if (existingLikedIndex !== -1) {
                            userProfile.likedMeals.splice(existingLikedIndex, 1);
                            showMessage("RECETTE RETIRÉE DES FAVORIS.", 'info');
                        } else {
                            // Add the meal to likedMeals, including its context for AI inspiration
                            userProfile.likedMeals.push({
                                id: mealToLike.id,
                                title: mealToLike.title,
                                description_du_plat: mealToLike.description_du_plat,
                                ingredients_list: mealToLike.ingredients_list,
                                mealType: mealToLike.mealType,
                                dayContext: mealToLike.dayContext, // Store day context for better inspiration
                                likedAt: new Date().toISOString()
                            });
                            showMessage("RECETTE AJOUTÉE AUX FAVORIS !", 'success');
                        }
                        saveToLocalStorage('userProfile', userProfile);
                        renderRecipeView(document.getElementById('main-content')); // Re-render to update heart icon
                    }
                };
            });
        }

        // Rend la vue du chronomètre d'intervalle
        function renderChronoIntervalleView(container) {
            let html = `
                <div class="card-retro mb-6">
                    <h2 class="text-3xl sm:text-4xl font-bold text-accent-yellow mb-4 text-center">CHRONOMÈTRE D'INTERVALLES</h2>

                    <!-- Affichage du Chrono -->
                    <div class="card-bg-blue-border p-6 rounded-lg shadow-xl mb-6 text-center">
                        <p class="text-5xl sm:text-7xl font-bold text-accent-green-light mb-2" id="chrono-display">PRÊT: 00</p>
                        <p class="text-xl sm:text-2xl text-accent-purple-light" id="chrono-instruction">AJOUTEZ DES INTERVALLES</p>
                    </div>

                    <!-- Contrôles du Chrono -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                        <button id="start-chrono-btn" class="btn-retro-green col-span-2 sm:col-span-1">DÉMARRER</button>
                        <button id="pause-chrono-btn" class="btn-retro-purple col-span-2 sm:col-span-1">PAUSE</button>
                        <button id="reset-chrono-btn" class="btn-retro-red col-span-2 sm:col-span-1">RESET</button>
                        <button id="skip-interval-btn" class="btn-retro col-span-2 sm:col-span-1">PASSER</button>
                    </div>

                    <!-- Paramètres du Chrono -->
                    <div class="card-bg-yellow-border p-4 rounded-lg mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold text-accent-yellow mb-3">PARAMÈTRES :</h3>
                        <div class="mb-4 flex items-center">
                            <input type="checkbox" id="enable-pre-countdown" ${enableChronoPreCountdown ? 'checked' : ''} class="mr-2 h-4 w-4 text-accent-purple rounded border-secondary focus:ring-accent-purple" />
                            <label for="enable-pre-countdown" class="text-secondary text-sm font-bold">COMPTE À REBOURS PRÉ-CHRONO</label>
                        </div>
                        <div id="pre-countdown-duration-setting" class="${enableChronoPreCountdown ? '' : 'hidden'} mb-4">
                            <label for="chrono-pre-countdown-duration" class="block text-secondary text-sm font-bold mb-2">DURÉE PRÉ-COMPTE (SECONDES) :</label>
                            <input type="number" id="chrono-pre-countdown-duration" value="${chronoPreCountdownDuration}" min="1" class="input-retro" />
                        </div>
                    </div>

                    <!-- Ajout/Modification d'Intervalle -->
                    <div class="card-bg-blue-border p-4 rounded-lg mb-6">
                        <h3 class="text-xl sm:text-2xl text-accent-yellow mb-3">AJOUTER / MODIFIER INTERVALLE :</h3>
                        <div class="mb-4">
                            <label for="new-duration-minutes" class="block text-secondary text-sm font-bold mb-2">DURÉE (MINUTES) :</label>
                            <input type="number" id="new-duration-minutes" class="input-retro" placeholder="EX: 1" min="1" />
                        </div>
                        <div class="mb-4">
                            <label for="new-instruction" class="block text-secondary text-sm font-bold mb-2">INSTRUCTION :</label>
                            <input type="text" id="new-instruction" class="input-retro" placeholder="EX: COURSE RAPIDE" />
                        </div>
                        <button id="add-update-interval-btn" class="btn-retro w-full">AJOUTER</button>
                        <button id="reset-interval-form-btn" class="btn-retro-red w-full mt-2 hidden">ANNULER MODIFICATION</button>
                    </div>

                    <!-- Liste des Intervalles -->
                    <div class="card-bg-purple-border p-4 rounded-lg mb-6">
                        <h3 class="text-xl sm:text-2xl text-accent-yellow mb-3">SÉQUENCE D'INTERVALLES :</h3>
                        <div id="intervals-list" class="space-y-2 mb-4">
                            <!-- Les intervalles seront listés ici -->
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="sequenceName" class="input-retro flex-1" placeholder="NOM DE LA SÉQUENCE" />
                            <button id="save-sequence-btn" class="btn-retro-green">SAUVEGARDER</button>
                            <button id="load-sequence-btn" class="btn-retro">CHARGER</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;

            const chronoDisplay = document.getElementById('chrono-display');
            const chronoInstruction = document.getElementById('chrono-instruction');
            const startChronoBtn = document.getElementById('start-chrono-btn');
            const pauseChronoBtn = document.getElementById('pause-chrono-btn');
            const resetChronoBtn = document.getElementById('reset-chrono-btn');
            const skipIntervalBtn = document.getElementById('skip-interval-btn');
            const newDurationMinutesInput = document.getElementById('new-duration-minutes');
            const newInstructionInput = document.getElementById('new-instruction');
            const addUpdateIntervalBtn = document.getElementById('add-update-interval-btn');
            const resetIntervalFormBtn = document.getElementById('reset-interval-form-btn');
            const intervalsListDiv = document.getElementById('intervals-list');
            const enablePreCountdownCheckbox = document.getElementById('enable-pre-countdown');
            const preCountdownDurationSetting = document.getElementById('pre-countdown-duration-setting');
            const chronoPreCountdownDurationInput = document.getElementById('chrono-pre-countdown-duration');
            const saveSequenceBtn = document.getElementById('save-sequence-btn');
            const loadSequenceBtn = document.getElementById('load-sequence-btn');

            // Met à jour l'affichage du chronomètre
            function updateChronoDisplay() {
                const displayTime = chronoCurrentIntervalIndex === -1 ? `PRÊT: ${String(chronoCurrentTime).padStart(2, '0')}` : `${String(Math.floor(chronoCurrentTime / 60)).padStart(2, '0')}:${String(chronoCurrentTime % 60).padStart(2, '0')}`;
                const currentInstruction = chronoCurrentIntervalIndex === -1 ? "PRÉPAREZ-VOUS !" : chronoIntervals[chronoCurrentIntervalIndex]?.instruction || "FINI !";
                chronoDisplay.textContent = displayTime;
                chronoInstruction.textContent = String(currentInstruction).toUpperCase();

                if (isChronoRunning && !isChronoPaused) {
                    startChronoBtn.disabled = true;
                    pauseChronoBtn.disabled = false;
                    resetChronoBtn.disabled = false;
                    skipIntervalBtn.disabled = false;
                    startChronoBtn.classList.remove('btn-retro-green');
                    startChronoBtn.classList.add('bg-gray-500'); /* Tailwind class, might need variable */
                    pauseChronoBtn.classList.remove('bg-gray-500'); /* Tailwind class, might need variable */
                    pauseChronoBtn.classList.add('btn-retro-purple');
                } else if (isChronoPaused) {
                    startChronoBtn.disabled = false;
                    pauseChronoBtn.disabled = true;
                    resetChronoBtn.disabled = false;
                    skipIntervalBtn.disabled = false;
                    startChronoBtn.classList.remove('bg-gray-500'); /* Tailwind class, might need variable */
                    startChronoBtn.classList.add('btn-retro-green');
                    pauseChronoBtn.classList.remove('btn-retro-purple');
                    pauseChronoBtn.classList.add('bg-gray-500'); /* Tailwind class, might need variable */
                } else {
                    startChronoBtn.disabled = false;
                    pauseChronoBtn.disabled = true;
                    resetChronoBtn.disabled = true;
                    skipIntervalBtn.disabled = true;
                    startChronoBtn.classList.remove('bg-gray-500'); /* Tailwind class, might need variable */
                    startChronoBtn.classList.add('btn-retro-green');
                    pauseChronoBtn.classList.remove('btn-retro-purple');
                    pauseChronoBtn.classList.add('bg-gray-500'); /* Tailwind class, might need variable */
                }
            }

            // Boucle principale du chronomètre
            function chronoLoop() {
                if (!isChronoRunning || isChronoPaused) return;

                if (chronoCurrentIntervalIndex === -1) { // Pre-countdown phase
                    chronoCurrentTime--;
                    if (chronoCurrentTime <= 0) {
                        playMarioKartStartSound();
                        chronoCurrentIntervalIndex = 0;
                        chronoCurrentTime = chronoIntervals[0].duration;
                        speak(String(chronoIntervals[0].instruction).toUpperCase());
                        showMessage(String(chronoIntervals[0].instruction).toUpperCase(), 'chrono');
                    } else if (chronoCurrentTime <= 3 && chronoCurrentTime > 0) {
                        playBeep(660, 0.1); // Short beep for last 3 seconds
                    }
                } else { // Main interval phase
                    chronoCurrentTime--;
                    if (chronoCurrentTime <= 0) {
                        chronoCurrentIntervalIndex++;
                        if (chronoCurrentIntervalIndex < chronoIntervals.length) {
                            chronoCurrentTime = chronoIntervals[chronoCurrentIntervalIndex].duration;
                            speak(String(chronoIntervals[chronoCurrentIntervalIndex].instruction).toUpperCase());
                            showMessage(String(chronoIntervals[chronoCurrentIntervalIndex].instruction).toUpperCase(), 'chrono');
                        } else {
                            isChronoRunning = false;
                            isChronoPaused = false;
                            chronoCurrentIntervalIndex = -1;
                            chronoCurrentTime = 0;
                            speak("Programme terminé !");
                            showMessage("PROGRAMME TERMINÉ !", 'success');
                            clearInterval(chronoIntervalTimerRef);
                            chronoIntervalTimerRef = null;
                        }
                    } else if (chronoCurrentTime <= 10 && chronoCurrentTime > 0) {
                        playBeep(880, 0.05); // Short beep for last 10 seconds of an interval
                    }
                }
                updateLocalStorageChronoState();
                updateChronoDisplay();
            }

            // Rend la liste des intervalles
            function renderIntervalsList() {
                let listHtml = '';
                if (chronoIntervals.length === 0) listHtml = '<p class="text-tertiary">AUCUN INTERVALLE AJOUTÉ.</p>';
                else {
                    listHtml = `<ul class="space-y-2">`;
                    chronoIntervals.forEach((interval, index) => {
                        listHtml += `
                            <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-list-item p-2 rounded-md border border-tertiary">
                                <span class="text-primary text-base sm:text-lg">${Math.floor(interval.duration / 60)}MIN${interval.duration % 60 > 0 ? ` ${interval.duration % 60}S` : ''} - ${String(interval.instruction).toUpperCase()}</span>
                                <div class="flex gap-2 mt-2 sm:mt-0">
                                    <button class="btn-retro-green text-xs px-2 py-1 duplicate-interval-btn" data-index="${index}">DUPLIQUER</button>
                                    <button class="btn-retro-purple text-xs px-2 py-1 edit-interval-btn" data-index="${index}">MODIFIER</button>
                                    <button class="btn-retro-red text-xs px-2 py-1 remove-interval-btn" data-index="${index}">SUPPRIMER</button>
                                </div>
                            </li>
                        `;
                    });
                    listHtml += `</ul>`;
                }
                intervalsListDiv.innerHTML = listHtml;

                intervalsListDiv.querySelectorAll('.remove-interval-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const indexToRemove = parseInt(event.target.dataset.index);
                        if (await showConfirmModal("CONFIRMER LA SUPPRESSION DE L'INTERVALLE ?")) {
                            chronoIntervals.splice(indexToRemove, 1);
                            updateLocalStorageChronoState();
                            showMessage("INTERVALLE SUPPRIMÉE !", 'success');
                            renderIntervalsList();
                            resetIntervalForm();
                        }
                    };
                });

                intervalsListDiv.querySelectorAll('.duplicate-interval-btn').forEach(button => {
                    button.onclick = async (event) => {
                        const indexToDuplicate = parseInt(event.target.dataset.index);
                        const originalInterval = chronoIntervals[indexToDuplicate];
                        if (originalInterval) {
                            chronoIntervals.push({ ...originalInterval });
                            updateLocalStorageChronoState();
                            showMessage("INTERVALLE DUPLIQUÉE !", 'success');
                            renderIntervalsList();
                        }
                    };
                });

                intervalsListDiv.querySelectorAll('.edit-interval-btn').forEach(button => {
                    button.onclick = (event) => {
                        editingIntervalIndex = parseInt(event.target.dataset.index);
                        const intervalToEdit = chronoIntervals[editingIntervalIndex];
                        if (intervalToEdit) {
                            newDurationMinutesInput.value = Math.floor(intervalToEdit.duration / 60);
                            newInstructionInput.value = intervalToEdit.instruction;
                            addUpdateIntervalBtn.textContent = 'METTRE À JOUR';
                            addUpdateIntervalBtn.classList.remove('btn-retro');
                            addUpdateIntervalBtn.classList.add('btn-retro-purple');
                            resetIntervalFormBtn.classList.remove('hidden');
                            showMessage(`MODIFICATION DE L'INTERVALLE ${editingIntervalIndex + 1}.`, 'info');
                        }
                    };
                });
            }

            function resetIntervalForm() {
                newDurationMinutesInput.value = '';
                newInstructionInput.value = '';
                addUpdateIntervalBtn.textContent = 'AJOUTER';
                addUpdateIntervalBtn.classList.remove('btn-retro-purple');
                addUpdateIntervalBtn.classList.add('btn-retro');
                resetIntervalFormBtn.classList.add('hidden');
                editingIntervalIndex = -1;
            }

            addUpdateIntervalBtn.onclick = () => {
                const duration = newDurationMinutesInput.value;
                const instruction = newInstructionInput.value;
                if (duration === '' || instruction.trim() === '') { showMessage("ERREUR: LA DURÉE ET L'INSTRUCTION SONT REQUISES.", 'error'); return; }
                const durationSeconds = parseInt(duration) * 60;

                if (editingIntervalIndex !== -1) {
                    chronoIntervals[editingIntervalIndex] = { duration: durationSeconds, instruction: instruction.trim() };
                    showMessage("INTER
